<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservar Cita - Mappa</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <nav class="container">
            <div class="logo"><i class="fas fa-stethoscope"></i> Mappa</div>
            <ul class="nav-links">
                <li><a href="index.html">Inicio</a></li>
                <li><a href="evaluacion.html">Evaluación</a></li>
                <li><a href="reserva.html" class="active">Reservar Cita</a></li>
                <li><a href="citas.html">Ver Citas</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="section">
            <div class="container">
                <h2><i class="fas fa-calendar-alt"></i> Reservar Cita Médica</h2>
                
                <form id="appointmentForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nombre completo *</label>
                            <input type="text" id="nombre" required>
                        </div>
                        <div class="form-group">
                            <label>Teléfono *</label>
                            <input type="tel" id="telefono" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="email">
                        </div>
                        <div class="form-group">
                            <label>Edad *</label>
                            <input type="number" id="edad" min="0" max="120" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Especialidad *</label>
                        <select id="especialidad" required>
                            <option value="">Seleccionar especialidad</option>
                            <option value="medicina-general">Medicina General</option>
                            <option value="cardiologia">Cardiología</option>
                            <option value="neurologia">Neurología</option>
                            <option value="pediatria">Pediatría</option>
                            <option value="ginecologia">Ginecología</option>
                            <option value="dermatologia">Dermatología</option>
                            <option value="oftalmologia">Oftalmología</option>
                            <option value="ortopedia">Ortopedia</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Fecha *</label>
                            <input type="date" id="fecha" required>
                        </div>
                        <div class="form-group">
                            <label>Hora *</label>
                            <select id="hora" required>
                                <option value="">Seleccionar hora</option>
                                <option value="08:00">08:00 AM</option>
                                <option value="09:00">09:00 AM</option>
                                <option value="10:00">10:00 AM</option>
                                <option value="11:00">11:00 AM</option>
                                <option value="12:00">12:00 PM</option>
                                <option value="14:00">02:00 PM</option>
                                <option value="15:00">03:00 PM</option>
                                <option value="16:00">04:00 PM</option>
                                <option value="17:00">05:00 PM</option>
                                <option value="18:00">06:00 PM</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Motivo de la consulta *</label>
                        <textarea id="motivo" placeholder="Describe brevemente el motivo" required></textarea>
                    </div>

                    <button type="submit" class="submit-btn">
                        <i class="fas fa-calendar-check"></i> Confirmar Reserva
                    </button>
                </form>

                <div id="appointment-result" class="hidden">
                    <div class="success-message">
                        <h3><i class="fas fa-check-circle"></i> ¡Cita Reservada!</h3>
                        <div id="appointment-summary"></div>
                        <div class="action-buttons">
                            <a href="index.html" class="cta-button primary">Volver al Inicio</a>
                            <a href="citas.html" class="cta-button secondary">Ver Citas</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        const API_URL = 'api/citas.php';

        async function getCitas() {
            try {
                const response = await fetch(API_URL);
                return await response.json();
            } catch (error) {
                console.error('Error:', error);
                return [];
            }
        }

        async function saveCita(cita) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(cita)
                });
                return await response.json();
            } catch (error) {
                console.error('Error:', error);
                return {success: false};
            }
        }

        document.getElementById('appointmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const btn = this.querySelector('.submit-btn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
            btn.disabled = true;

            try {
                const citaData = {
                    nombre: document.getElementById('nombre').value,
                    telefono: document.getElementById('telefono').value,
                    email: document.getElementById('email').value,
                    edadPaciente: document.getElementById('edad').value,
                    especialidad: document.getElementById('especialidad').value,
                    fecha: document.getElementById('fecha').value,
                    hora: document.getElementById('hora').value,
                    tipoConsulta: 'presencial',
                    motivo: document.getElementById('motivo').value,
                    confirmacion: 'MED' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                    ownerKey: document.getElementById('email').value || document.getElementById('telefono').value
                };

                const result = await saveCita(citaData);
                
                if (result.success) {
                    document.getElementById('appointment-summary').innerHTML = `
                        <p><strong>Paciente:</strong> ${citaData.nombre}</p>
                        <p><strong>Especialidad:</strong> ${citaData.especialidad}</p>
                        <p><strong>Fecha:</strong> ${citaData.fecha}</p>
                        <p><strong>Hora:</strong> ${citaData.hora}</p>
                        <p><strong>Confirmación:</strong> ${citaData.confirmacion}</p>
                    `;
                    document.getElementById('appointment-result').classList.remove('hidden');
                    this.reset();
                } else {
                    alert('Error al guardar la cita');
                }
            } catch (error) {
                alert('Error al procesar la reserva');
            } finally {
                btn.innerHTML = '<i class="fas fa-calendar-check"></i> Confirmar Reserva';
                btn.disabled = false;
            }
        });

        document.getElementById('fecha').min = new Date().toISOString().split('T')[0];
    </script>
</body>
</html>