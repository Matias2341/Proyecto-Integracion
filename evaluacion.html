<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluaci√≥n de S√≠ntomas - Mappa</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        /* Ocultar contenido hasta verificar autenticaci√≥n */
        body {
            opacity: 0;
            transition: opacity 0.3s ease-in;
        }
        body.authenticated {
            opacity: 1;
        }

        /* Mejoras de interfaz para el formulario de evaluaci√≥n */
        .evaluation-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .evaluation-header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            color: white;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .evaluation-header h2 {
            color: white;
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .evaluation-header p {
            color: rgba(255, 255, 255, 0.95);
            font-size: 1.1rem;
            margin: 0;
        }

        #evaluationForm {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }

        #evaluationForm:hover {
            box-shadow: 0 8px 35px rgba(0, 0, 0, 0.12);
        }

        .form-group {
            margin-bottom: 2rem;
        }

        .form-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .form-group label i {
            color: #667eea;
            font-size: 1.1rem;
        }

        .form-group input[type="number"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
            background: #fafafa;
        }

        .form-group input[type="number"]:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .sintomas-input-wrapper {
            position: relative;
            width: 100%;
        }
        .form-group textarea {
            min-height: 120px;
            resize: vertical;
            line-height: 1.6;
        }
        .sintomas-input-wrapper textarea {
            padding-right: 3.5rem;
        }
        .mic-button {
            position: absolute;
            right: 0.75rem;
            bottom: 0.75rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            z-index: 10;
            font-size: 1rem;
        }
        .mic-button:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .mic-button:active {
            transform: scale(0.95);
        }
        .mic-button.recording {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            animation: pulse 1.5s ease-in-out infinite;
        }
        .mic-button.recording i {
            animation: pulse-icon 0.8s ease-in-out infinite;
        }
        .mic-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
            }
            50% {
                box-shadow: 0 4px 16px rgba(255, 107, 107, 0.6);
            }
        }
        @keyframes pulse-icon {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
        }
        .mic-status {
            position: absolute;
            right: 0.75rem;
            bottom: 3.5rem;
            background: rgba(102, 126, 234, 0.95);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.85rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 11;
            white-space: nowrap;
            backdrop-filter: blur(10px);
        }
        .mic-status.error {
            background: rgba(255, 107, 107, 0.95);
        }
        .mic-status.success {
            background: rgba(40, 167, 69, 0.95);
        }

        .form-group input[type="number"]:read-only {
            background: #f5f5f5;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Mejora del slider de intensidad */
        .intensidad-container {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 2rem;
            border-radius: 16px;
            margin-top: 1rem;
        }

        .intensidad-slider-wrapper {
            position: relative;
            margin: 1.5rem 0;
        }

        .intensidad-slider-wrapper input[type="range"] {
            width: 100%;
            height: 12px;
            border-radius: 10px;
            background: linear-gradient(to right, #4caf50 0%, #ff9800 50%, #f44336 100%);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .intensidad-slider-wrapper input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            border: 3px solid #667eea;
            transition: all 0.3s ease;
        }

        .intensidad-slider-wrapper input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .intensidad-slider-wrapper input[type="range"]::-moz-range-thumb {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            border: 3px solid #667eea;
            transition: all 0.3s ease;
        }

        .intensidad-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #666;
        }

        .intensidad-value-display {
            text-align: center;
            margin: 1rem 0;
        }

        .intensidad-value-display span {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 50px;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            min-width: 80px;
        }

        .submit-btn {
            width: 100%;
            padding: 1.25rem 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .submit-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Mejoras en la secci√≥n de resultados */
        #evaluation-result {
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .success-message {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.08);
        }

        .success-message h3 {
            color: #667eea;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
        }

        /* Mejoras en los tips */
        .tips {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .tip {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            text-align: center;
        }

        .tip:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.12);
        }

        .tip i {
            font-size: 2.5rem;
            color: #667eea;
            margin-bottom: 1rem;
        }

        .tip h3 {
            color: #333;
            margin-bottom: 0.75rem;
        }

        .tip p {
            color: #666;
            line-height: 1.6;
        }

        /* Indicador de campo requerido */
        .required-indicator {
            color: #f44336;
            margin-left: 0.25rem;
        }

        /* Mejoras en el select */
        .form-group select {
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23667eea' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 12px;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
    </style>
</head>
<body>
    <script src="js/auth.js"></script>
    <script>
        // Proteger p√°gina inmediatamente antes de que se cargue
        (async function() {
            const session = await checkSession();
            if (!session.authenticated) {
                window.location.replace('login.html');
            } else {
                // Mostrar contenido si est√° autenticado
                document.body.classList.add('authenticated');
            }
        })();
    </script>
    <header>
        <nav class="container">
            <a href="index.html" class="logo">
                <i class="fas fa-stethoscope"></i> Mappa
            </a>
            <button class="menu-toggle" id="menuToggle" aria-label="Toggle menu">
                <i class="fas fa-bars"></i>
            </button>
            <ul class="nav-links main-nav" id="navLinks">
                <li><a href="index.html"><i class="fas fa-home"></i> Inicio</a></li>
                <li><a href="evaluacion.html" class="active"><i class="fas fa-robot"></i> Evaluaci√≥n</a></li>
                <li><a href="reserva.html"><i class="fas fa-calendar-plus"></i> Reservar Cita</a></li>
                <li><a href="citas.html"><i class="fas fa-calendar-check"></i> Ver Citas</a></li>
            </ul>
            
            <!-- Men√∫ de perfil (solo visible cuando hay sesi√≥n) -->
            <div class="user-menu-container" id="userMenuContainer" style="display: none;">
                <button class="user-profile-btn" id="userProfileBtn" aria-label="Men√∫ de usuario">
                    <i class="fas fa-user"></i>
                </button>
                <div class="user-menu-dropdown" id="userMenuDropdown">
                    <div class="user-menu-header">
                        <div class="user-menu-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="user-menu-info">
                            <h4 id="userMenuName">Usuario</h4>
                            <p id="userMenuEmail">correo@ejemplo.com</p>
                        </div>
                    </div>
                    <div class="user-menu-items">
                        <a href="#" class="user-menu-item">
                            <i class="fas fa-user-circle"></i>
                            <span>Mi Perfil</span>
                        </a>
                        <a href="#" class="user-menu-item" id="editInfoMenuItem">
                            <i class="fas fa-edit"></i>
                            <span>Editar Informaci√≥n</span>
                        </a>
                        <a href="#" class="user-menu-item">
                            <i class="fas fa-cog"></i>
                            <span>Configuraci√≥n</span>
                        </a>
                        <a href="#" class="user-menu-item">
                            <i class="fas fa-bell"></i>
                            <span>Notificaciones</span>
                        </a>
                        <a href="#" class="user-menu-item">
                            <i class="fas fa-shield-alt"></i>
                            <span>Privacidad</span>
                        </a>
                        <div class="user-menu-divider"></div>
                        <a href="#" class="user-menu-item">
                            <i class="fas fa-question-circle"></i>
                            <span>Ayuda</span>
                        </a>
                        <a href="#" class="user-menu-item">
                            <i class="fas fa-info-circle"></i>
                            <span>Sobre Mappa</span>
                        </a>
                        <div class="user-menu-divider"></div>
                        <button class="user-menu-item danger" id="logoutMenuItem">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Cerrar Sesi√≥n</span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>
    </header>
    <script>
        // Verificar sesi√≥n y mostrar men√∫ de usuario
        async function checkAuthAndSetupMenu() {
            try {
                const response = await fetch('api/auth.php?action=session', {
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (result.authenticated) {
                    document.body.classList.add('authenticated');
                    const userMenuContainer = document.getElementById('userMenuContainer');
                    const navLinks = document.getElementById('navLinks');
                    const menuToggle = document.getElementById('menuToggle');
                    
                    if (userMenuContainer) {
                        userMenuContainer.style.display = 'flex';
                    }
                    // Mantener navLinks visibles en desktop cuando hay sesi√≥n
                    if (navLinks && window.innerWidth > 768) {
                        navLinks.style.display = 'flex';
                    }
                    // Ocultar men√∫ hamburguesa en desktop cuando hay sesi√≥n
                    if (menuToggle && window.innerWidth > 768) {
                        menuToggle.style.display = 'none';
                    }
                    // En m√≥vil, mostrar men√∫ hamburguesa
                    if (menuToggle && window.innerWidth <= 768) {
                        menuToggle.style.display = 'block';
                    }
                    
                    if (result.user) {
                        const userNameEl = document.getElementById('userMenuName');
                        const userEmailEl = document.getElementById('userMenuEmail');
                        if (userNameEl) userNameEl.textContent = result.user.nombre || 'Usuario';
                        if (userEmailEl) userEmailEl.textContent = result.user.email || '';
                        
                        const avatar = document.querySelector('.user-menu-avatar');
                        if (avatar && result.user.nombre) {
                            const initials = result.user.nombre.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                            avatar.textContent = initials;
                            avatar.style.fontSize = '1rem';
                            avatar.style.fontWeight = '600';
                        }
                    }
                } else {
                    document.body.classList.remove('authenticated');
                }
            } catch (error) {
                console.error('Error verificando sesi√≥n:', error);
                document.body.classList.remove('authenticated');
            }
        }
        
        function setupUserMenu() {
            const userProfileBtn = document.getElementById('userProfileBtn');
            const userMenuDropdown = document.getElementById('userMenuDropdown');
            const logoutMenuItem = document.getElementById('logoutMenuItem');
            const userMenuContainer = document.getElementById('userMenuContainer');
            
            if (userProfileBtn && userMenuDropdown) {
                userProfileBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    userMenuDropdown.classList.toggle('active');
                    userProfileBtn.classList.toggle('active');
                });
                
                document.addEventListener('click', function(e) {
                    if (userMenuContainer && !userMenuContainer.contains(e.target)) {
                        userMenuDropdown.classList.remove('active');
                        userProfileBtn.classList.remove('active');
                    }
                });
                
                userMenuDropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
            
            if (logoutMenuItem) {
                logoutMenuItem.addEventListener('click', async function(e) {
                    e.preventDefault();
                    try {
                        const response = await fetch('api/auth.php?action=logout', {
                            credentials: 'include'
                        });
                        const result = await response.json();
                        if (result.success) {
                            window.location.href = 'login.html';
                        }
                    } catch (error) {
                        console.error('Error al cerrar sesi√≥n:', error);
                        window.location.href = 'login.html';
                    }
                });
            }
            
            // Manejar "Editar Informaci√≥n"
            const editInfoMenuItem = document.getElementById('editInfoMenuItem');
            if (editInfoMenuItem) {
                editInfoMenuItem.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (userMenuDropdown) {
                        userMenuDropdown.classList.remove('active');
                        userProfileBtn.classList.remove('active');
                    }
                    openEditProfileModal();
                });
            }
            
            document.querySelectorAll('.user-menu-item:not(#logoutMenuItem):not(#editInfoMenuItem)').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (userMenuDropdown) {
                        userMenuDropdown.classList.remove('active');
                        userProfileBtn.classList.remove('active');
                    }
                });
            });
        }
        
        function setupMobileMenu() {
            const menuToggle = document.getElementById('menuToggle');
            const navLinks = document.getElementById('navLinks');
            
            if (menuToggle && navLinks) {
                menuToggle.addEventListener('click', function() {
                    if (!document.body.classList.contains('authenticated') || window.innerWidth <= 768) {
                        navLinks.classList.toggle('active');
                        const icon = this.querySelector('i');
                        if (navLinks.classList.contains('active')) {
                            icon.classList.remove('fa-bars');
                            icon.classList.add('fa-times');
                        } else {
                            icon.classList.remove('fa-times');
                            icon.classList.add('fa-bars');
                        }
                    }
                });

                navLinks.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', function() {
                        if (window.innerWidth <= 768) {
                            navLinks.classList.remove('active');
                            const icon = menuToggle.querySelector('i');
                            if (icon) {
                                icon.classList.remove('fa-times');
                                icon.classList.add('fa-bars');
                            }
                        }
                    });
                });

                document.addEventListener('click', function(e) {
                    if (window.innerWidth <= 768 && !navLinks.contains(e.target) && !menuToggle.contains(e.target)) {
                        navLinks.classList.remove('active');
                        const icon = menuToggle.querySelector('i');
                        if (icon) {
                            icon.classList.remove('fa-times');
                            icon.classList.add('fa-bars');
                        }
                    }
                });
            }
        }
        
        function handleResize() {
            if (document.body.classList.contains('authenticated')) {
                const navLinks = document.getElementById('navLinks');
                const menuToggle = document.getElementById('menuToggle');
                
                if (window.innerWidth > 768) {
                    if (navLinks) navLinks.style.display = 'flex';
                    if (menuToggle) menuToggle.style.display = 'none';
                    if (navLinks) navLinks.classList.remove('active');
                } else {
                    if (navLinks && !navLinks.classList.contains('active')) {
                        navLinks.style.display = 'none';
                    }
                    if (menuToggle) menuToggle.style.display = 'block';
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthAndSetupMenu().then(() => {
                setupUserMenu();
                setupMobileMenu();
                handleResize();
            });
        });
        
        window.addEventListener('resize', handleResize);
    </script>

    <main>
        <section class="section">
            <div class="container evaluation-container">
                <div class="evaluation-header">
                    <h2><i class="fas fa-robot"></i> Evaluaci√≥n de S√≠ntomas con IA</h2>
                    <p>Nuestro sistema de inteligencia artificial analizar√° tus s√≠ntomas y te recomendar√° el especialista m√°s adecuado</p>
                </div>
                
                <form id="evaluationForm" style="pointer-events: none; opacity: 0.6;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edad">
                                <i class="fas fa-birthday-cake"></i>
                                Edad <span class="required-indicator">*</span>
                            </label>
                            <input type="number" id="edad" name="edad" min="0" max="120" required readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                            <small id="edad-info" style="color: #666; font-size: 0.85rem; display: none; margin-top: 0.25rem;">
                                Se calcula autom√°ticamente desde tu fecha de nacimiento
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="genero">
                                <i class="fas fa-user"></i>
                                G√©nero <span class="required-indicator">*</span>
                            </label>
                            <select id="genero" name="genero" required>
                                <option value="">Seleccionar g√©nero</option>
                                <option value="masculino">Masculino</option>
                                <option value="femenino">Femenino</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="sintomas">
                            <i class="fas fa-stethoscope"></i>
                            Describe tus s√≠ntomas <span class="required-indicator">*</span>
                        </label>
                        <div class="sintomas-input-wrapper">
                            <textarea id="sintomas" name="sintomas" placeholder="Describe detalladamente tus s√≠ntomas, cu√°ndo comenzaron, intensidad, etc. Ejemplo: 'Tengo dolor de cabeza intenso desde hace 2 d√≠as, acompa√±ado de mareos y sensibilidad a la luz'" required></textarea>
                            <button type="button" id="mic-button" class="mic-button" title="Hablar para transcribir">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <div id="mic-status" class="mic-status hidden"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="duracion">
                            <i class="fas fa-clock"></i>
                            Duraci√≥n de los s√≠ntomas <span class="required-indicator">*</span>
                        </label>
                        <select id="duracion" name="duracion" required>
                            <option value="">Seleccionar duraci√≥n</option>
                            <option value="menos-1-hora">Menos de 1 hora</option>
                            <option value="1-6-horas">1-6 horas</option>
                            <option value="6-24-horas">6-24 horas</option>
                            <option value="1-3-dias">1-3 d√≠as</option>
                            <option value="mas-3-dias">M√°s de 3 d√≠as</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="intensidad">
                            <i class="fas fa-thermometer-half"></i>
                            Intensidad del dolor/malestar <span class="required-indicator">*</span>
                        </label>
                        <div class="intensidad-container">
                            <div class="intensidad-value-display">
                                <span id="intensidad-value">5</span>
                            </div>
                            <div class="intensidad-slider-wrapper">
                                <input type="range" id="intensidad" name="intensidad" min="1" max="10" value="5" required>
                            </div>
                            <div class="intensidad-labels">
                                <span><i class="fas fa-smile"></i> 1 - Muy leve</span>
                                <span><i class="fas fa-meh"></i> 5 - Moderado</span>
                                <span><i class="fas fa-frown"></i> 10 - Muy intenso</span>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="submit-btn">
                        <i class="fas fa-robot"></i> Analizar con IA y Recomendar Especialista
                    </button>
                </form>

                <div id="evaluation-result" class="hidden">
                    <div class="success-message">
                        <h3><i class="fas fa-robot"></i> An√°lisis de IA Completado</h3>
                        <div id="ai-recommendation"></div>
                        <div id="evaluation-summary"></div>
                        <div class="action-buttons">
                            <button onclick="mostrarConfirmacionReserva()" class="cta-button primary" id="btn-reservar-cita">
                                <i class="fas fa-calendar-plus"></i> Reservar Cita con Especialista Recomendado
                            </button>
                            <button onclick="resetForm()" class="cta-button secondary">
                                <i class="fas fa-redo"></i> Nueva Evaluaci√≥n
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="container">
                <h2>Consejos para una mejor evaluaci√≥n</h2>
                <div class="tips">
                    <div class="tip">
                        <i class="fas fa-lightbulb"></i>
                        <h3>S√© espec√≠fico</h3>
                        <p>Describe exactamente d√≥nde sientes el dolor o malestar y c√≥mo se siente</p>
                    </div>
                    <div class="tip">
                        <i class="fas fa-clock"></i>
                        <h3>Incluye el tiempo</h3>
                        <p>Menciona cu√°ndo comenzaron los s√≠ntomas y si han empeorado o mejorado</p>
                    </div>
                    <div class="tip">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Intensidad real</h3>
                        <p>Eval√∫a honestamente qu√© tan intenso es tu malestar en una escala del 1 al 10</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal de Confirmaci√≥n de Reserva -->
    <div id="confirmacionModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="fas fa-calendar-check"></i> Confirmar Reserva de Cita</h3>
                <span class="close" onclick="cerrarModalConfirmacion()">&times;</span>
            </div>
            <div class="modal-body" id="confirmacionDetalles">
                <p><i class="fas fa-spinner fa-spin"></i> Cargando detalles de la reserva...</p>
            </div>
            <div class="modal-footer">
                <button onclick="cerrarModalConfirmacion()" class="cta-button secondary">Cancelar</button>
                <button onclick="editarReserva()" class="cta-button secondary" id="btn-editar-reserva" style="display: none;">
                    <i class="fas fa-edit"></i> Editar
                </button>
                <button onclick="guardarEdicionReserva()" class="cta-button secondary" id="btn-guardar-edicion" style="display: none;">
                    <i class="fas fa-save"></i> Guardar Cambios
                </button>
                <button onclick="confirmarReserva()" class="cta-button primary" id="btn-confirmar-reserva">
                    <i class="fas fa-check"></i> Confirmar y Reservar
                </button>
            </div>
        </div>
    </div>

    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .modal-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 {
            margin: 0;
            color: white;
        }
        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            opacity: 0.7;
        }
        .modal-body {
            padding: 2rem;
        }
        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #e1e5e9;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        .modal-footer .cta-button.secondary {
            background: transparent;
            color: #ff6b6b;
            border: 2px solid #ff6b6b;
        }
        .modal-footer .cta-button.secondary:hover {
            background: #ff6b6b;
            color: white;
        }
        .detalle-reserva {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .detalle-reserva strong {
            color: #667eea;
        }
    </style>

    <script>
        // Inicializar slider de intensidad cuando el DOM est√© listo
        function initIntensidadSlider() {
            const intensidadInput = document.getElementById('intensidad');
            const intensidadValue = document.getElementById('intensidad-value');
            if (intensidadInput && intensidadValue) {
                intensidadInput.addEventListener('input', function() {
                    intensidadValue.textContent = this.value;
                });
            }
        }
        
        // Funcionalidad de reconocimiento de voz
        let recognition = null;
        let isRecording = false;
        
        // Verificar si el navegador soporta reconocimiento de voz
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                const micButton = document.getElementById('mic-button');
                if (micButton) {
                    micButton.disabled = true;
                    micButton.title = 'Tu navegador no soporta reconocimiento de voz';
                    micButton.style.opacity = '0.5';
                }
                return false;
            }
            
            recognition = new SpeechRecognition();
            recognition.lang = 'es-ES'; // Idioma espa√±ol
            recognition.continuous = true;
            recognition.interimResults = true;
            
            const micButton = document.getElementById('mic-button');
            const sintomasTextarea = document.getElementById('sintomas');
            const micStatus = document.getElementById('mic-status');
            
            if (!micButton || !sintomasTextarea) return;
            
            // Event listeners del reconocimiento
            recognition.onstart = function() {
                isRecording = true;
                micButton.classList.add('recording');
                micButton.title = 'Grabando... Haz clic para detener';
                micStatus.textContent = 'üé§ Escuchando...';
                micStatus.classList.remove('hidden', 'error', 'success');
            };
            
            recognition.onresult = function(event) {
                let interimTranscript = '';
                let finalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                // Obtener el texto actual del textarea
                const currentText = sintomasTextarea.value;
                
                // Agregar el texto final al textarea
                if (finalTranscript) {
                    sintomasTextarea.value = currentText + finalTranscript;
                    micStatus.textContent = '‚úì Texto agregado';
                    micStatus.classList.add('success');
                    setTimeout(() => {
                        micStatus.classList.add('hidden');
                    }, 2000);
                }
                
                // Mostrar transcripci√≥n provisional
                if (interimTranscript) {
                    micStatus.textContent = `üé§ ${interimTranscript}`;
                    micStatus.classList.remove('hidden', 'error', 'success');
                }
            };
            
            recognition.onerror = function(event) {
                console.error('Error en reconocimiento de voz:', event.error);
                isRecording = false;
                micButton.classList.remove('recording');
                micButton.title = 'Hablar para transcribir';
                
                let errorMessage = 'Error en el reconocimiento';
                if (event.error === 'no-speech') {
                    errorMessage = 'No se detect√≥ voz. Intenta nuevamente.';
                } else if (event.error === 'audio-capture') {
                    errorMessage = 'No se pudo acceder al micr√≥fono.';
                } else if (event.error === 'not-allowed') {
                    errorMessage = 'Permiso de micr√≥fono denegado.';
                }
                
                micStatus.textContent = `‚úó ${errorMessage}`;
                micStatus.classList.add('error');
                setTimeout(() => {
                    micStatus.classList.add('hidden');
                }, 3000);
            };
            
            recognition.onend = function() {
                isRecording = false;
                micButton.classList.remove('recording');
                micButton.title = 'Hablar para transcribir';
                if (!micStatus.classList.contains('error') && !micStatus.classList.contains('success')) {
                    micStatus.classList.add('hidden');
                }
            };
            
            // Toggle del bot√≥n de micr√≥fono
            micButton.addEventListener('click', function() {
                if (!isRecording) {
                    try {
                        recognition.start();
                    } catch (error) {
                        console.error('Error al iniciar reconocimiento:', error);
                        micStatus.textContent = '‚úó Error al iniciar. Intenta nuevamente.';
                        micStatus.classList.add('error');
                        setTimeout(() => {
                            micStatus.classList.add('hidden');
                        }, 3000);
                    }
                } else {
                    recognition.stop();
                }
            });
            
            return true;
        }

        // Mapeo de especialidades de ChatGPT a c√≥digos del sistema
        const especialidadMap = {
            'medicina general': 'medicina-general',
            'm√©dico general': 'medicina-general',
            'medicina familiar': 'medicina-general',
            'atenci√≥n primaria': 'medicina-general',
            'cardiolog√≠a': 'cardiologia',
            'cardi√≥logo': 'cardiologia',
            'cardiologia': 'cardiologia',
            'neurolog√≠a': 'neurologia',
            'neur√≥logo': 'neurologia',
            'neurologia': 'neurologia',
            'pediatr√≠a': 'pediatria',
            'pediatra': 'pediatria',
            'pediatria': 'pediatria',
            'ginecolog√≠a': 'ginecologia',
            'ginec√≥logo': 'ginecologia',
            'ginecologia': 'ginecologia',
            'obstetricia': 'ginecologia',
            'dermatolog√≠a': 'dermatologia',
            'dermat√≥logo': 'dermatologia',
            'dermatologia': 'dermatologia',
            'oftalmolog√≠a': 'oftalmologia',
            'oftalm√≥logo': 'oftalmologia',
            'oftalmologia': 'oftalmologia',
            'ortopedia': 'ortopedia',
            'ortopedista': 'ortopedia',
            'traumatolog√≠a': 'ortopedia',
            'traumat√≥logo': 'ortopedia',
            'odontolog√≠a': 'odontologia',
            'odont√≥logo': 'odontologia',
            'odontologo': 'odontologia',
            'odontologia': 'odontologia',
            'dentista': 'odontologia',
            'estomatolog√≠a': 'odontologia',
            'estomatologia': 'odontologia',
            'dental': 'odontologia',
            'psiquiatr√≠a': 'psiquiatria',
            'psiquiatra': 'psiquiatria',
            'psiquiatria': 'psiquiatria',
            'psicolog√≠a': 'psiquiatria',
            'psic√≥logo': 'psiquiatria',
            'endocrinolog√≠a': 'endocrinologia',
            'endocrin√≥logo': 'endocrinologia',
            'endocrinologia': 'endocrinologia',
            'urolog√≠a': 'urologia',
            'ur√≥logo': 'urologia',
            'urologia': 'urologia',
            'otorrinolaringolog√≠a': 'otorrinolaringologia',
            'otorrinolaring√≥logo': 'otorrinolaringologia',
            'otorrinolaringologia': 'otorrinolaringologia',
            'orl': 'otorrinolaringologia',
            'gastroenterolog√≠a': 'gastroenterologia',
            'gastroenter√≥logo': 'gastroenterologia',
            'gastroenterologia': 'gastroenterologia',
            'neumolog√≠a': 'neumologia',
            'neum√≥logo': 'neumologia',
            'neumologia': 'neumologia',
            'reumatolog√≠a': 'reumatologia',
            'reumat√≥logo': 'reumatologia',
            'reumatologia': 'reumatologia',
            'hematolog√≠a': 'hematologia',
            'hemat√≥logo': 'hematologia',
            'hematologia': 'hematologia',
            'oncolog√≠a': 'oncologia',
            'onc√≥logo': 'oncologia',
            'oncologia': 'oncologia'
        };

        // Funci√≥n para normalizar especialidad
        function normalizarEspecialidad(especialidadTexto) {
            if (!especialidadTexto) return 'medicina-general';
            
            const textoLower = especialidadTexto.toLowerCase().trim();
            
            // Buscar coincidencia exacta o parcial
            for (const [key, value] of Object.entries(especialidadMap)) {
                if (textoLower.includes(key)) {
                    return value;
                }
            }
            
            // Si no encuentra, devolver medicina general
            return 'medicina-general';
        }

        // Funci√≥n para consultar Google Gemini (GRATUITO)
        async function consultarGemini(sintomas, edad, intensidad, duracion, genero) {
            try {
                const generoTexto = genero === 'masculino' ? 'Masculino' : genero === 'femenino' ? 'Femenino' : genero || 'No especificado';
                const prompt = `Eres un sistema experto de triaje m√©dico. Analiza los s√≠ntomas EXACTAMENTE como lo har√≠a un algoritmo de detecci√≥n temprana. Sigue estas reglas en ORDEN ESTRICTO:

‚ö†Ô∏è INSTRUCCI√ìN CR√çTICA: Analiza el CONTEXTO COMPLETO de los s√≠ntomas, NO solo palabras individuales. 
Por ejemplo:
- "hinchaz√≥n de tobillo" ‚Üí ortopedia (NO gastroenterologia)
- "hinchaz√≥n de est√≥mago" ‚Üí gastroenterologia
- "hinchaz√≥n abdominal" ‚Üí gastroenterologia
- "hinchaz√≥n en el pie" ‚Üí ortopedia
- "hinchaz√≥n de pies" ‚Üí ortopedia o cardiologia (si menciona coraz√≥n)
- "gases" o "hinchaz√≥n abdominal" ‚Üí gastroenterologia

DATOS DEL PACIENTE:
- Edad: ${edad} a√±os
- G√©nero: ${generoTexto}
- S√≠ntomas principales: "${sintomas}"
- Intensidad del dolor/malestar: ${intensidad}/10
- Duraci√≥n: ${duracion}

DETECCI√ìN TEMPRANA (EVALUAR PRIMERO, EN ESTE ORDEN):

1. DETECCI√ìN DENTAL (PRIORIDAD M√ÅXIMA):
   Si los s√≠ntomas mencionan: "muela", "diente", "dental", "odont", "caries", "enc√≠a", "gingival", "masticar", "masticaci√≥n", "absceso dental", "ortodoncia", "boca" + "dolor"
   ‚Üí RESPUESTA INMEDIATA: odontologia

2. DETECCI√ìN DE EDAD (PRIORIDAD M√ÅXIMA):
   Si edad < 18 a√±os
   ‚Üí RESPUESTA INMEDIATA: pediatria

3. DETECCI√ìN DE C√ÅNCER (PRIORIDAD M√ÅXIMA):
   Si menciona: "c√°ncer", "tumor", "neoplasia", "quimioterapia"
   ‚Üí RESPUESTA INMEDIATA: oncologia

4. DETECCI√ìN DE DOLOR DE CABEZA (PRIORIDAD ALTA):
   Si menciona: "dolor de cabeza", "dolor cabeza", "cefalea", "migra√±a"
   ‚Üí RESPUESTA INMEDIATA: neurologia
   ‚ö†Ô∏è NO confundir con "dolor de pecho" o "dolor en otra parte"

5. DETECCI√ìN DE DOLOR DE PIE/EXTREMIDADES (PRIORIDAD ALTA):
   Si menciona: "dolor de pie", "dolor pie", "dolor en el pie", "pie" + "dolor", "tobillo" + "dolor", "rodilla" + "dolor", "hombro" + "dolor", "dolor en extremidades"
   ‚Üí RESPUESTA INMEDIATA: ortopedia
   ‚ö†Ô∏è NO confundir con "dolor de pecho" o "dolor de cabeza"

6. DETECCI√ìN DE DOLOR DE PUBIS/P√âLVICO/GENITALES (PRIORIDAD ALTA):
   Si menciona: "dolor de pubis", "dolor pubis", "dolor en pubis", "dolor p√©lvico", "pubis" + "dolor", "dolor de pene", "dolor pene", "dolor genital"
   ‚Üí Si menciona "pene", "genital masculino" O g√©nero es MASCULINO: urologia
   ‚Üí Si tambi√©n menciona "menstrual", "vaginal", "embarazo", "ovario", "√∫tero" O (g√©nero es FEMENINO Y edad entre 12-65 a√±os): ginecologia
   ‚Üí Si menciona "orinar", "urinario", "pr√≥stata", "vejiga": urologia
   ‚Üí Por defecto: Si g√©nero es MASCULINO ‚Üí urologia, Si g√©nero es FEMENINO ‚Üí ginecologia (si edad 12-65), Si no hay g√©nero ‚Üí ginecologia (si edad 12-65) o urologia

6b. DETECCI√ìN DE HERPES GENITAL/ENFERMEDADES GENITALES (PRIORIDAD ALTA):
   Si menciona: "herpes genital", "herpes" (si g√©nero est√° especificado), "enfermedad de transmisi√≥n sexual", "ets", "its", "infecci√≥n genital", "infeccion genital", "verrugas genitales", "s√≠filis", "sifilis", "gonorrea", "clamidia"
   ‚Üí Si g√©nero es MASCULINO: urologia (SIEMPRE, sin excepciones)
   ‚Üí Si g√©nero es FEMENINO: ginecologia (SIEMPRE, sin excepciones)
   ‚Üí Si no hay g√©nero especificado: Si menciona "pene" o "genital masculino" ‚Üí urologia, Si menciona "vaginal" o "genital femenino" ‚Üí ginecologia, Por defecto ‚Üí ginecologia (si edad 12-65) o urologia
   ‚ö†Ô∏è CR√çTICO: Si g√©nero es MASCULINO y menciona "herpes" o "herpes genital" ‚Üí SIEMPRE urologia, NUNCA ginecologia

7. DETECCI√ìN DE SED EXCESIVA/CAMBIOS DE PESO (PRIORIDAD ALTA):
   Si menciona: "mucha sed", "sed excesiva", "sed todo el tiempo", "subido de peso sin motivo", "bajado de peso sin dieta", "aumento de peso", "p√©rdida de peso", "bajar de peso"
   ‚Üí RESPUESTA INMEDIATA: endocrinologia

8. DETECCI√ìN DE PROBLEMAS DE AUDICI√ìN (PRIORIDAD ALTA):
   Si menciona: "oigo menos", "problemas de audici√≥n", "sordera", "no oigo bien", "p√©rdida de audici√≥n", "dificultad para o√≠r"
   ‚Üí RESPUESTA INMEDIATA: otorrinolaringologia

9. DETECCI√ìN DE CA√çDA DE PELO (PRIORIDAD ALTA):
   Si menciona: "se me cae el pelo", "ca√≠da de pelo", "p√©rdida de pelo", "alopecia", "calvicie"
   ‚Üí Si tambi√©n menciona "hormon", "tiroides", "menopausia": endocrinologia
   ‚Üí Por defecto: dermatologia

10. DETECCI√ìN DE HINCHAZ√ìN EN EXTREMIDADES (PRIORIDAD ALTA - EVALUAR PRIMERO):
   Si menciona: "hinchaz√≥n de tobillo", "hinchaz√≥n tobillo", "tobillo hinchado", "hinchaz√≥n en el tobillo", "hinchaz√≥n de pie", "hinchaz√≥n pie", "pie hinchado", "hinchaz√≥n en el pie", "hinchaz√≥n de pies", "pies hinchados", "hinchaz√≥n de pierna", "hinchaz√≥n pierna", "pierna hinchada", "hinchaz√≥n en la pierna", "hinchaz√≥n de rodilla", "rodilla hinchada", "hinchaz√≥n en la rodilla", "hinchaz√≥n de mano", "mano hinchada", "hinchaz√≥n en la mano", "hinchaz√≥n de brazo", "brazo hinchado", "hinchaz√≥n en el brazo"
   ‚Üí Si tambi√©n menciona "coraz√≥n", "palpitaciones", "al final del d√≠a": cardiologia
   ‚Üí Por defecto: ortopedia
   ‚ö†Ô∏è CR√çTICO: Esta detecci√≥n debe evaluarse ANTES que la detecci√≥n de gases/hinchaz√≥n digestiva

10b. DETECCI√ìN DE GASES/HINCHAZ√ìN DIGESTIVA (PRIORIDAD ALTA):
   Si menciona: "hinchaz√≥n", "gases", "flatulencia", "distensi√≥n abdominal", "abdomen hinchado", "est√≥mago hinchado", "barriga hinchada", "vientre hinchado"
   ‚Üí SOLO si NO menciona: tobillo, pie, pies, pierna, rodilla, mano, brazo, extremidad
   ‚Üí RESPUESTA INMEDIATA: gastroenterologia

11. DETECCI√ìN DE DOLOR DE ESPALDA (PRIORIDAD ALTA):
   Si menciona: "dolor de espalda", "dolor espalda", "me duele la espalda", "dolor lumbar", "dolor cervical"
   ‚Üí RESPUESTA INMEDIATA: ortopedia

12. DETECCI√ìN DE DIFICULTAD PARA CAMINAR (PRIORIDAD ALTA):
   Si menciona: "me cuesta caminar", "dificultad para caminar", "dificultad caminar", "problemas para caminar"
   ‚Üí Si tambi√©n menciona "dolor", "torcedura", "esguince", "fractura": ortopedia
   ‚Üí Si menciona "equilibrio", "mareo", "v√©rtigo", "adormecimiento": neurologia
   ‚Üí Por defecto: ortopedia

13. DETECCI√ìN DE TORCEDURA/LESIONES (PRIORIDAD ALTA):
   Si menciona: "me torc√≠", "torcedura", "esguince", "me lastim√©", "lesi√≥n", "golpe"
   ‚Üí RESPUESTA INMEDIATA: ortopedia

14. DETECCI√ìN DE ADORMECIMIENTO (PRIORIDAD ALTA):
   Si menciona: "se me duerme", "adormecimiento", "entumecimiento", "hormigueo", "p√©rdida de sensibilidad"
   ‚Üí RESPUESTA INMEDIATA: neurologia

15. DETECCI√ìN DE SANGRE AL IR AL BA√ëO (PRIORIDAD ALTA):
   Si menciona: "sangre al ir al ba√±o", "sangre en heces", "sangre en orina", "sangre al defecar", "sangre al orinar"
   ‚Üí Si menciona "orinar", "orina", "micci√≥n": urologia
   ‚Üí Si menciona "defecar", "heces", "excremento", "deposici√≥n": gastroenterologia
   ‚Üí Por defecto: gastroenterologia

16. DETECCI√ìN DE P√âRDIDA DE EQUILIBRIO (PRIORIDAD ALTA):
   Si menciona: "pierdo el equilibrio", "p√©rdida de equilibrio", "problemas de equilibrio", "desequilibrio", "me caigo"
   ‚Üí RESPUESTA INMEDIATA: neurologia

17. DETECCI√ìN DE P√âRDIDA DE APETITO (PRIORIDAD ALTA):
   Si menciona: "no tengo apetito", "p√©rdida de apetito", "falta de apetito", "sin apetito"
   ‚Üí RESPUESTA INMEDIATA: gastroenterologia

18. DETECCI√ìN DE CANSANCIO EXTREMO (PRIORIDAD ALTA):
   Si menciona: "muy cansado", "cansancio", "fatiga", "sin energ√≠a", "agotado" Y tambi√©n menciona "aunque duerma bien", "aunque duerma", "duerma bien"
   ‚Üí Si tambi√©n menciona "sed", "peso", "tiroides", "hormon": endocrinologia
   ‚Üí Si tambi√©n menciona "triste", "sin ganas", "depresi√≥n": psiquiatria
   ‚Üí Por defecto: medicina-general

19. DETECCI√ìN DE MAREOS AL LEVANTARSE (PRIORIDAD ALTA):
   Si menciona: "mareo al levantarse", "mareo cuando me levanto", "me mareo al levantarme r√°pido", "mareo al pararse"
   ‚Üí Si tambi√©n menciona "palpitaciones", "coraz√≥n", "presi√≥n": cardiologia
   ‚Üí Por defecto: medicina-general

20. DETECCI√ìN DE PRESI√ìN EN EL PECHO AL ESFUERZO (PRIORIDAD ALTA):
   Si menciona: "presi√≥n en el pecho", "molestia en el pecho", "dolor en el pecho" Y tambi√©n menciona "al hacer esfuerzo", "al caminar", "al ejercitar", "al subir escaleras"
   ‚Üí RESPUESTA INMEDIATA: cardiologia

21. DETECCI√ìN DE DIFICULTAD PARA DORMIR (PRIORIDAD ALTA):
   Si menciona: "me cuesta dormir", "dificultad para dormir", "no puedo dormir", "paso dando vueltas", "insomnio"
   ‚Üí RESPUESTA INMEDIATA: psiquiatria

22. DETECCI√ìN DE BOCA SECA Y DOLOR DE GARGANTA (PRIORIDAD ALTA):
   Si menciona: "boca seca" Y "dolor de garganta" O "boca seca al despertar"
   ‚Üí RESPUESTA INMEDIATA: otorrinolaringologia

23. DETECCI√ìN DE PICAZ√ìN EN LA PIEL (PRIORIDAD ALTA):
   Si menciona: "picaz√≥n en la piel", "picor en la piel", "me pica la piel", "ronchas", "urticaria"
   ‚Üí RESPUESTA INMEDIATA: dermatologia

24. DETECCI√ìN DE ARDOR AL ORINAR (PRIORIDAD ALTA):
   Si menciona: "me arde al orinar", "ardor al orinar", "dolor al orinar", "quemaz√≥n al orinar" Y tambi√©n menciona "muchas veces", "frecuente", "a menudo"
   ‚Üí RESPUESTA INMEDIATA: urologia

25. DETECCI√ìN DE PUNZADA EN EL EST√ìMAGO/ABDOMEN (PRIORIDAD M√ÅXIMA):
   Si menciona: "punzada en el est√≥mago", "punzada en el estomago", "punzada en el abdomen", "punzada en el est√≥mago al comer", "punzada en el estomago al comer", "punzada en el est√≥mago despu√©s de comer", "punzada est√≥mago", "punzada estomago", "punzada abdomen", "punzada en la panza", "punzada panza"
   ‚Üí RESPUESTA INMEDIATA: gastroenterologia
   ‚ö†Ô∏è CR√çTICO: Esta detecci√≥n debe evaluarse ANTES que cualquier otra detecci√≥n de "punzada"

26. DETECCI√ìN DE DOLOR ABDOMINAL DESPU√âS DE COMER (PRIORIDAD ALTA):
   Si menciona: "dolor en el abdomen", "dolor abdominal", "dolor en la parte baja del abdomen", "dolor en el est√≥mago", "dolor de est√≥mago", "dolor est√≥mago", "dolor estomago" Y tambi√©n menciona "despu√©s de comer", "al comer", "tras comer", "cuando como", "si como", "comiendo"
   ‚Üí RESPUESTA INMEDIATA: gastroenterologia

27. DETECCI√ìN DE DIFICULTAD PARA CONCENTRARSE (PRIORIDAD ALTA):
   Si menciona: "me cuesta concentrarme", "dificultad para concentrarse", "muy distra√≠do", "no me puedo concentrar", "problemas de concentraci√≥n"
   ‚Üí Si tambi√©n menciona "triste", "ansiedad", "estr√©s", "depresi√≥n": psiquiatria
   ‚Üí Si tambi√©n menciona "memoria", "olvido": neurologia
   ‚Üí Por defecto: psiquiatria

27. DETECCI√ìN DE MANOS FR√çAS Y HORMIGUEO (PRIORIDAD ALTA):
   Si menciona: "manos fr√≠as" Y "hormigueo" O "manos fr√≠as" Y "entumecimiento"
   ‚Üí Si tambi√©n menciona "tiroides", "hormon", "fr√≠o": endocrinologia
   ‚Üí Por defecto: neurologia

28. DETECCI√ìN DE DOLOR EN ARTICULACIONES POR LAS MA√ëANAS (PRIORIDAD ALTA):
   Si menciona: "dolor en las articulaciones" Y "por las ma√±anas" O "rigidez matutina" O "dolor articular al despertar"
   ‚Üí RESPUESTA INMEDIATA: reumatologia

29. DETECCI√ìN DE CA√çDA DE CABELLO (PRIORIDAD ALTA):
   Si menciona: "se me cae el cabello", "ca√≠da de cabello", "se me cae mucho el pelo", "p√©rdida de cabello"
   ‚Üí RESPUESTA INMEDIATA: dermatologia

30. DETECCI√ìN DE PALPITACIONES SIN RAZ√ìN (PRIORIDAD ALTA):
   Si menciona: "palpitaciones", "coraz√≥n late fuerte", "siento el coraz√≥n", "latidos fuertes" Y tambi√©n menciona "sin raz√≥n", "sin motivo", "sin hacer nada"
   ‚Üí RESPUESTA INMEDIATA: cardiologia

31. DETECCI√ìN DE DIFICULTAD PARA RESPIRAR AL CAMINAR (PRIORIDAD ALTA):
   Si menciona: "dificultad para respirar" Y "al caminar" O "me cuesta respirar" Y "al caminar r√°pido" O "falta de aire" Y "al caminar"
   ‚Üí Si tambi√©n menciona "coraz√≥n", "palpitaciones", "pecho": cardiologia
   ‚Üí Por defecto: neumologia

32. DETECCI√ìN DE ANSIEDAD CONSTANTE (PRIORIDAD ALTA):
   Si menciona: "ansiedad", "muy ansioso", "ansiedad casi todo el tiempo", "siempre ansioso", "nervioso todo el tiempo"
   ‚Üí RESPUESTA INMEDIATA: psiquiatria

33. DETECCI√ìN DE TOS PERSISTENTE/CONSTANTE (PRIORIDAD M√ÅXIMA):
   Si menciona: "tos" Y ("no se va" O "que no se va" O "no mejora" O "que no mejora" O "persistente" O "constante" O "desde hace" O "hace tiempo" O "hace d√≠as" O "hace semanas" O "hace 1 semana" O "hace una semana" O "cr√≥nica")
   ‚Üí RESPUESTA INMEDIATA: neumologia
   ‚ö†Ô∏è CR√çTICO: Esta detecci√≥n debe evaluarse ANTES que cualquier otra detecci√≥n relacionada con pecho o coraz√≥n

34. DETECCI√ìN DE DOLOR DE O√çDOS Y ZUMBIDO (PRIORIDAD ALTA):
   Si menciona: "dolor de o√≠dos" Y "zumbido" O "zumbido constante" O "tinnitus" O "ac√∫fenos"
   ‚Üí RESPUESTA INMEDIATA: otorrinolaringologia

35. DETECCI√ìN DE VISI√ìN BORROSA (PRIORIDAD ALTA):
   Si menciona: "veo borroso", "visi√≥n borrosa", "veo borroso a ratos", "visi√≥n borrosa con la luz"
   ‚Üí RESPUESTA INMEDIATA: oftalmologia

36. DETECCI√ìN DE OJOS SECOS Y ARDOR (PRIORIDAD ALTA):
   Si menciona: "ojos secos" Y "me arden" O "ojos muy secos" O "ardor en los ojos"
   ‚Üí RESPUESTA INMEDIATA: oftalmologia

37. DETECCI√ìN DE TRISTEZA SIN MOTIVO (PRIORIDAD ALTA):
   Si menciona: "me siento triste", "tristeza sin motivo", "sin ganas de hacer nada", "triste sin raz√≥n"
   ‚Üí RESPUESTA INMEDIATA: psiquiatria

38. DETECCI√ìN DE DOLOR DE PECHO AL RESPIRAR (PRIORIDAD ALTA):
   Si menciona: "dolor de pecho" Y "al respirar" O "dolor en el pecho cuando respiro profundo"
   ‚Üí Si tambi√©n menciona "palpitaciones", "coraz√≥n": cardiologia
   ‚Üí Por defecto: neumologia

39. DETECCI√ìN DE PIEL SECA Y DESCAMACI√ìN (PRIORIDAD ALTA):
   Si menciona: "piel seca" Y "se descama" O "piel muy seca" O "descamaci√≥n"
   ‚Üí RESPUESTA INMEDIATA: dermatologia

40. DETECCI√ìN DE CALOR Y SUDORACI√ìN REPENTINA (PRIORIDAD ALTA):
   Si menciona: "siento calor de repente", "calor repentino", "sudo mucho", "sofocos", "bochornos"
   ‚Üí RESPUESTA INMEDIATA: endocrinologia

41. DETECCI√ìN DE DOLOR DE CABEZA DETR√ÅS DE LOS OJOS (PRIORIDAD ALTA):
   Si menciona: "dolor de cabeza detr√°s de los ojos", "dolor detr√°s de los ojos", "dolor de cabeza" Y "detr√°s de los ojos"
   ‚Üí Si tambi√©n menciona "visi√≥n", "ojo": oftalmologia
   ‚Üí Por defecto: neurologia

42. DETECCI√ìN DE CARA HINCHADA AL DESPERTAR (PRIORIDAD ALTA):
   Si menciona: "cara hinchada al despertar", "me despierto con la cara hinchada", "hinchaz√≥n en la cara"
   ‚Üí RESPUESTA INMEDIATA: medicina-general (podr√≠a ser alergia, retenci√≥n de l√≠quidos, etc.)

43. DETECCI√ìN DE DOLOR EN COSTADO DERECHO (PRIORIDAD ALTA):
   Si menciona: "dolor en el costado derecho", "dolor costado derecho", "dolor lado derecho del abdomen"
   ‚Üí RESPUESTA INMEDIATA: gastroenterologia

44. DETECCI√ìN DE HINCHAZ√ìN DE PIES (PRIORIDAD ALTA):
   Si menciona: "se me hinchan los pies", "hinchaz√≥n de pies", "pies hinchados" Y "al final del d√≠a"
   ‚Üí Si tambi√©n menciona "coraz√≥n", "palpitaciones": cardiologia
   ‚Üí Por defecto: ortopedia

45. DETECCI√ìN DE TOS CON FLEMA (PRIORIDAD ALTA):
   Si menciona: "tos con flema", "tos con moco", "flema" Y "no mejora"
   ‚Üí RESPUESTA INMEDIATA: neumologia

46. DETECCI√ìN DE DIFICULTAD PARA TRAGAR (PRIORIDAD ALTA):
   Si menciona: "me cuesta tragar", "dificultad para tragar", "nudo en la garganta", "sensaci√≥n de nudo al tragar"
   ‚Üí RESPUESTA INMEDIATA: otorrinolaringologia

47. DETECCI√ìN DE SANGRADO NASAL (PRIORIDAD ALTA):
   Si menciona: "me sangra la nariz", "sangrado nasal", "sangre por la nariz", "sangrado de nariz seguido"
   ‚Üí RESPUESTA INMEDIATA: otorrinolaringologia

48. DETECCI√ìN DE DOLOR DE RODILLA AL SUBIR ESCALERAS (PRIORIDAD ALTA):
   Si menciona: "dolor de rodilla" Y "al subir escaleras" O "me duele la rodilla al subir"
   ‚Üí RESPUESTA INMEDIATA: ortopedia

49. DETECCI√ìN DE ACIDEZ FRECUENTE (PRIORIDAD ALTA):
   Si menciona: "me da acidez", "acidez casi todos los d√≠as", "acidez frecuente", "reflujo"
   ‚Üí RESPUESTA INMEDIATA: gastroenterologia

50. DETECCI√ìN DE CANSANCIO DESPU√âS DE COMER (PRIORIDAD ALTA):
   Si menciona: "cansancio despu√©s de comer", "mucho cansancio despu√©s de comer", "sue√±o despu√©s de comer"
   ‚Üí RESPUESTA INMEDIATA: endocrinologia

51. DETECCI√ìN DE DIFICULTAD PARA LEVANTAR BRAZOS (PRIORIDAD ALTA):
   Si menciona: "me cuesta levantar los brazos", "dificultad para levantar brazos", "dolor en el hombro" Y "al levantar"
   ‚Üí RESPUESTA INMEDIATA: ortopedia

52. DETECCI√ìN DE TEMBLORES EN LAS MANOS (PRIORIDAD ALTA):
   Si menciona: "me tiemblan las manos", "temblores en las manos", "manos temblorosas"
   ‚Üí RESPUESTA INMEDIATA: neurologia

53. DETECCI√ìN DE ENTU–úECIMIENTO EN DEDOS (PRIORIDAD ALTA):
   Si menciona: "entumecimiento en los dedos", "se me duermen los dedos", "dedos entumecidos"
   ‚Üí RESPUESTA INMEDIATA: neurologia

54. DETECCI√ìN DE CAMBIOS DE HUMOR (PRIORIDAD ALTA):
   Si menciona: "cambios de humor", "cambios de √°nimo", "altibajos emocionales"
   ‚Üí Si tambi√©n menciona "hormon", "tiroides", "menopausia": endocrinologia
   ‚Üí Por defecto: psiquiatria

55. DETECCI√ìN DE DOLOR DE EST√ìMAGO CUANDO EST√Å NERVIOSO (PRIORIDAD ALTA):
   Si menciona: "dolor de est√≥mago" Y "cuando estoy nervioso" O "nudo en el est√≥mago" Y "nervioso"
   ‚Üí RESPUESTA INMEDIATA: gastroenterologia

56. DETECCI√ìN DE FALTA DE AIRE NOCTURNA (PRIORIDAD ALTA):
   Si menciona: "falta de aire por las noches", "dificultad para respirar por la noche", "me falta el aire al dormir"
   ‚Üí Si tambi√©n menciona "coraz√≥n", "palpitaciones": cardiologia
   ‚Üí Por defecto: neumologia

57. DETECCI√ìN DE ARDOR EN LA LENGUA (PRIORIDAD ALTA):
   Si menciona: "me arde la lengua", "ardor en la lengua", "mal sabor de boca"
   ‚Üí RESPUESTA INMEDIATA: odontologia

58. DETECCI√ìN DE PRESI√ìN EN LA CABEZA AL AGACHARSE (PRIORIDAD ALTA):
   Si menciona: "presi√≥n en la cabeza" Y "al agacharme" O "presi√≥n cuando me agacho"
   ‚Üí RESPUESTA INMEDIATA: neurologia

59. DETECCI√ìN DE PICAZ√ìN EN OJOS AL AIRE LIBRE (PRIORIDAD ALTA):
   Si menciona: "picaz√≥n en los ojos" Y "al aire libre" O "me pican los ojos" Y "cuando salgo"
   ‚Üí RESPUESTA INMEDIATA: oftalmologia

60. DETECCI√ìN DE DOLORES MUSCULARES SIN EJERCICIO (PRIORIDAD ALTA):
   Si menciona: "dolores musculares" Y "sin hacer ejercicio" O "dolor muscular sin raz√≥n"
   ‚Üí RESPUESTA INMEDIATA: reumatologia

61. DETECCI√ìN DE ENC√çAS QUE SANGRAN (PRIORIDAD ALTA):
   Si menciona: "me duelen las enc√≠as", "enc√≠as sangran", "sangrado de enc√≠as", "enc√≠as que sangran al cepillarme"
   ‚Üí RESPUESTA INMEDIATA: odontologia

62. DETECCI√ìN DE MAND√çBULA QUE SUENA (PRIORIDAD ALTA):
   Si menciona: "me suena la mand√≠bula", "mand√≠bula que suena", "ruido en la mand√≠bula al abrir"
   ‚Üí RESPUESTA INMEDIATA: odontologia

63. DETECCI√ìN DE MORETONES SIN RAZ√ìN (PRIORIDAD ALTA):
   Si menciona: "moretones sin raz√≥n", "moretones sin motivo", "me salen moretones", "moratones sin causa"
   ‚Üí RESPUESTA INMEDIATA: hematologia

64. DETECCI√ìN DE MAREOS DESPU√âS DE COMER (PRIORIDAD ALTA):
   Si menciona: "mareo despu√©s de comer", "me mareo despu√©s de comer", "mareos tras comer"
   ‚Üí RESPUESTA INMEDIATA: endocrinologia

65. DETECCI√ìN DE PIEL AMARILLENTA (PRIORIDAD ALTA):
   Si menciona: "piel amarillenta", "piel amarilla", "ictericia", "color amarillo"
   ‚Üí RESPUESTA INMEDIATA: gastroenterologia (problemas hep√°ticos)

66. DETECCI√ìN DE DOLOR EN M√öSCULOS DEL CUELLO (PRIORIDAD ALTA):
   Si menciona: "dolor en los m√∫sculos del cuello", "dolor cuello y hombros", "m√∫sculos del cuello duelen"
   ‚Üí RESPUESTA INMEDIATA: ortopedia

67. DETECCI√ìN DE FIEBRE LEVE PERSISTENTE (PRIORIDAD ALTA):
   Si menciona: "fiebre leve" Y "desde hace varios d√≠as" O "fiebre leve persistente"
   ‚Üí RESPUESTA INMEDIATA: medicina-general

68. DETECCI√ìN DE DOLOR PUNZANTE DETR√ÅS DE LA RODILLA (PRIORIDAD ALTA):
   Si menciona: "dolor punzante detr√°s de la rodilla", "dolor detr√°s de la rodilla"
   ‚Üí RESPUESTA INMEDIATA: ortopedia

69. DETECCI√ìN DE CALAMBRES EN LAS PIERNAS (PRIORIDAD ALTA):
   Si menciona: "calambres en las piernas", "calambres por la noche", "calambres nocturnos"
   ‚Üí Si tambi√©n menciona "coraz√≥n", "circulaci√≥n": cardiologia
   ‚Üí Por defecto: neurologia

70. DETECCI√ìN DE DIFICULTAD PARA RECORDAR (PRIORIDAD ALTA):
   Si menciona: "dificultad para recordar", "no recuerdo cosas recientes", "problemas de memoria", "olvido"
   ‚Üí RESPUESTA INMEDIATA: neurologia

71. DETECCI√ìN DE ADORMECIMIENTO EN LA CARA (PRIORIDAD ALTA):
   Si menciona: "se me duerme un lado de la cara", "adormecimiento en la cara", "cara adormecida"
   ‚Üí RESPUESTA INMEDIATA: neurologia

72. DETECCI√ìN DE DIFICULTAD PARA SUBIR DE PESO (PRIORIDAD ALTA):
   Si menciona: "me cuesta subir de peso", "no puedo subir de peso", "dificultad para ganar peso"
   ‚Üí RESPUESTA INMEDIATA: endocrinologia

73. DETECCI√ìN DE SENSIBILIDAD AL FR√çO (PRIORIDAD ALTA):
   Si menciona: "sensibilidad al fr√≠o", "mucha sensibilidad al fr√≠o", "no tolero el fr√≠o"
   ‚Üí RESPUESTA INMEDIATA: endocrinologia

74. DETECCI√ìN DE PICAZ√ìN EN BRAZOS (PRIORIDAD ALTA):
   Si menciona: "me pican los brazos", "picaz√≥n en los brazos", "picor en los brazos"
   ‚Üí RESPUESTA INMEDIATA: dermatologia

75. DETECCI√ìN DE ARDOR EN EL PECHO AL ACOSTARSE (PRIORIDAD ALTA):
   Si menciona: "ardor en el pecho" Y "al acostarme" O "reflujo al acostarse"
   ‚Üí RESPUESTA INMEDIATA: gastroenterologia

76. DETECCI√ìN DE MANOS HINCHADAS AL DESPERTAR (PRIORIDAD ALTA):
   Si menciona: "manos hinchadas al despertar", "me despierto con las manos hinchadas"
   ‚Üí RESPUESTA INMEDIATA: reumatologia

77. DETECCI√ìN DE GANAS FRECUENTES DE ORINAR NOCTURNAS (PRIORIDAD ALTA):
   Si menciona: "ganas de orinar por la noche", "orinar frecuente por la noche", "muchas veces al ba√±o por la noche"
   ‚Üí Si tambi√©n menciona "diabetes", "sed": endocrinologia
   ‚Üí Por defecto: urologia

78. DETECCI√ìN DE DOLOR EN LOS PIES AL CAMINAR (PRIORIDAD ALTA):
   Si menciona: "me duelen los pies al caminar", "dolor en los pies al caminar", "dolor de pies al caminar"
   ‚Üí RESPUESTA INMEDIATA: ortopedia

79. DETECCI√ìN DE DIFICULTAD PARA RESPIRAR POR LA NARIZ (PRIORIDAD ALTA):
   Si menciona: "me cuesta respirar por la nariz", "dificultad para respirar por la nariz", "nariz tapada"
   ‚Üí RESPUESTA INMEDIATA: otorrinolaringologia

80. DETECCI√ìN DE PICAZ√ìN EN OJOS Y NARIZ AL DESPERTAR (PRIORIDAD ALTA):
   Si menciona: "picaz√≥n en los ojos" Y "nariz" Y "al despertar" O "me pican los ojos y la nariz"
   ‚Üí RESPUESTA INMEDIATA: medicina-general (alergia, pero no tenemos alergolog√≠a)

81. DETECCI√ìN DE PIEL SENSIBLE AL SOL (PRIORIDAD ALTA):
   Si menciona: "piel sensible al sol", "sensibilidad al sol", "me quema el sol"
   ‚Üí RESPUESTA INMEDIATA: dermatologia

82. DETECCI√ìN DE DOLOR MUSCULAR AL DESPERTAR (PRIORIDAD ALTA):
   Si menciona: "dolor en los m√∫sculos al despertar", "me duelen los m√∫sculos al despertar"
   ‚Üí RESPUESTA INMEDIATA: reumatologia

83. DETECCI√ìN DE U√ëAS QUEBRADIZAS (PRIORIDAD ALTA):
   Si menciona: "u√±as quebradizas", "u√±as fr√°giles", "se me rompen las u√±as"
   ‚Üí RESPUESTA INMEDIATA: dermatologia

84. DETECCI√ìN DE ARDOR EN LA ESPALDA ALTA (PRIORIDAD ALTA):
   Si menciona: "ardor en la espalda alta", "dolor en la espalda alta", "espalda alta duele"
   ‚Üí RESPUESTA INMEDIATA: ortopedia

85. DETECCI√ìN DE SUE√ëO DURANTE EL D√çA (PRIORIDAD ALTA):
   Si menciona: "sue√±o durante el d√≠a", "me da sue√±o en el d√≠a", "somnolencia diurna" Y "aunque duerma bien"
   ‚Üí RESPUESTA INMEDIATA: endocrinologia

86. DETECCI√ìN DE DIFICULTAD PARA ESCUCHAR CON RUIDO (PRIORIDAD ALTA):
   Si menciona: "me cuesta escuchar con ruido", "dificultad para escuchar en ambientes ruidosos", "no oigo bien con ruido"
   ‚Üí RESPUESTA INMEDIATA: otorrinolaringologia

87. DETECCI√ìN DE DOLOR ABDOMINAL AL MOVERSE (PRIORIDAD ALTA):
   Si menciona: "dolor en la parte baja del abdomen" Y "al moverme" O "dolor abdominal al moverse"
   ‚Üí Si g√©nero es FEMENINO: ginecologia
   ‚Üí Si g√©nero es MASCULINO: urologia
   ‚Üí Por defecto: gastroenterologia

88. DETECCI√ìN DE DEBILIDAD DESPU√âS DE POCO ESFUERZO (PRIORIDAD ALTA):
   Si menciona: "me siento d√©bil", "debilidad despu√©s de poco esfuerzo", "muy d√©bil"
   ‚Üí Si tambi√©n menciona "coraz√≥n", "palpitaciones": cardiologia
   ‚Üí Por defecto: medicina-general

89. DETECCI√ìN DE V√âRTIGO AL MIRAR HACIA ABAJO (PRIORIDAD ALTA):
   Si menciona: "v√©rtigo al mirar hacia abajo", "me da v√©rtigo cuando miro abajo", "mareo al mirar abajo"
   ‚Üí RESPUESTA INMEDIATA: otorrinolaringologia

90. DETECCI√ìN DE LABIOS AGRIETADOS (PRIORIDAD ALTA):
   Si menciona: "labios agrietados", "labios secos todo el tiempo", "labios que se agrietan"
   ‚Üí RESPUESTA INMEDIATA: dermatologia

91. DETECCI√ìN DE BULTO EN EL CUELLO (PRIORIDAD ALTA):
   Si menciona: "bulto en el cuello", "bulto peque√±o en el cuello", "n√≥dulo en el cuello"
   ‚Üí RESPUESTA INMEDIATA: endocrinologia

92. DETECCI√ìN DE DOLOR MUSCULAR DESPU√âS DE ESTAR SENTADO (PRIORIDAD ALTA):
   Si menciona: "dolor en los m√∫sculos despu√©s de estar sentado", "me duelen los m√∫sculos al estar sentado"
   ‚Üí RESPUESTA INMEDIATA: ortopedia

93. DETECCI√ìN DE NUDO EN EL EST√ìMAGO CUANDO EST√Å NERVIOSO (PRIORIDAD ALTA):
   Si menciona: "nudo en el est√≥mago" Y "cuando estoy nervioso" O "sensaci√≥n de nudo" Y "nervioso"
   ‚Üí RESPUESTA INMEDIATA: gastroenterologia

94. DETECCI√ìN DE SUENOS EN LAS TRIPAS (PRIORIDAD ALTA):
   Si menciona: "me suenan las tripas", "ruidos en el est√≥mago", "suenan los intestinos" Y "aunque no tenga hambre"
   ‚Üí RESPUESTA INMEDIATA: gastroenterologia

95. DETECCI√ìN DE P√ÅRPADOS HINCHADOS (PRIORIDAD ALTA):
   Si menciona: "p√°rpados hinchados al despertar", "me despierto con los p√°rpados hinchados"
   ‚Üí RESPUESTA INMEDIATA: medicina-general (alergia, pero no tenemos alergolog√≠a)

96. DETECCI√ìN DE PICAZ√ìN EN EL CUERO CABELLUDO (PRIORIDAD ALTA):
   Si menciona: "picaz√≥n en el cuero cabelludo", "me pica el cuero cabelludo", "picor en la cabeza"
   ‚Üí RESPUESTA INMEDIATA: dermatologia

97. DETECCI√ìN DE DOLOR EN LOS HUESOS CON FR√çO (PRIORIDAD ALTA):
   Si menciona: "me duelen los huesos cuando hace fr√≠o", "dolor en los huesos con el fr√≠o"
   ‚Üí RESPUESTA INMEDIATA: reumatologia

98. DETECCI√ìN DE RONQUIDOS Y DIFICULTAD PARA RESPIRAR NOCTURNA (PRIORIDAD ALTA):
   Si menciona: "ronco mucho" Y "dificultad para respirar por la noche" O "ronquidos" Y "falta de aire"
   ‚Üí RESPUESTA INMEDIATA: otorrinolaringologia

99. DETECCI√ìN DE HAMBRE EXCESIVA (PRIORIDAD ALTA):
   Si menciona: "mucha hambre aunque haya comido", "hambre excesiva", "siempre tengo hambre"
   ‚Üí RESPUESTA INMEDIATA: endocrinologia

100. DETECCI√ìN DE DEDOS MORADOS CON FR√çO (PRIORIDAD ALTA):
   Si menciona: "dedos morados cuando hace fr√≠o", "dedos morados con el fr√≠o", "dedos azules con fr√≠o"
   ‚Üí RESPUESTA INMEDIATA: reumatologia

101. DETECCI√ìN DE RUIDOS EN LOS HUESOS (PRIORIDAD ALTA):
   Si menciona: "me suenan los huesos", "ruido en los huesos al mover", "crujidos en los huesos"
   ‚Üí RESPUESTA INMEDIATA: ortopedia

102. DETECCI√ìN DE PRESI√ìN CONSTANTE EN LA FRENTE (PRIORIDAD ALTA):
   Si menciona: "presi√≥n constante en la frente", "presi√≥n en la frente", "dolor de presi√≥n en la frente"
   ‚Üí RESPUESTA INMEDIATA: neurologia

103. DETECCI√ìN DE DOLOR DE CABEZA AL DESPERTAR (PRIORIDAD ALTA):
   Si menciona: "me despierto con dolor de cabeza", "dolor de cabeza al despertar", "dolor de cabeza por las ma√±anas"
   ‚Üí RESPUESTA INMEDIATA: neurologia

104. DETECCI√ìN DE NERVIOSO CON PALPITACIONES (PRIORIDAD ALTA):
   Si menciona: "siempre nervioso" Y "palpitaciones" O "nervioso" Y "con palpitaciones"
   ‚Üí RESPUESTA INMEDIATA: psiquiatria

105. DETECCI√ìN DE RIGIDEZ EN EL CUELLO AL DESPERTAR (PRIORIDAD ALTA):
   Si menciona: "rigidez en el cuello al despertar", "me levanto con rigidez en el cuello", "cuello r√≠gido al despertar"
   ‚Üí RESPUESTA INMEDIATA: ortopedia

106. DETECCI√ìN DE SENSACI√ìN DE APAGADO/SIN ENERG√çA (PRIORIDAD ALTA):
   Si menciona: "me siento apagado", "sin energ√≠a", "sin ganas", "como sin energ√≠a", "me siento medio apagado"
   ‚Üí Si tambi√©n menciona "sed", "peso", "tiroides", "hormon", "calor", "transpiro": endocrinologia
   ‚Üí Si tambi√©n menciona "triste", "depresi√≥n", "ansiedad": psiquiatria
   ‚Üí Por defecto: medicina-general

107. DETECCI√ìN DE DOLOR RARO EN LA CABEZA (PRIORIDAD ALTA):
   Si menciona: "dolor raro en la cabeza", "dolor extra√±o en la cabeza", "dolor leve en la cabeza", "dolor raro cabeza"
   ‚Üí RESPUESTA INMEDIATA: neurologia

108. DETECCI√ìN DE FALTA DE AIRE A RATOS (PRIORIDAD ALTA):
   Si menciona: "me falta aire", "falta de aire", "sensaci√≥n de falta de aire" Y "a ratos", "solo a ratos", "a veces"
   ‚Üí Si tambi√©n menciona "coraz√≥n", "palpitaciones", "pecho": cardiologia
   ‚Üí Por defecto: neumologia

109. DETECCI√ìN DE RUIDO EN EL O√çDO (PRIORIDAD ALTA):
   Si menciona: "me suena un o√≠do", "ruido en el o√≠do", "suena el o√≠do", "zumbido en el o√≠do" Y "de noche", "por la noche"
   ‚Üí RESPUESTA INMEDIATA: otorrinolaringologia

110. DETECCI√ìN DE HINCHAZ√ìN DE PIES AL ESTAR DE PIE (PRIORIDAD ALTA):
   Si menciona: "se me hinchan los pies" Y "cuando estoy de pie", "mucho rato de pie", "al estar de pie"
   ‚Üí RESPUESTA INMEDIATA: ortopedia

111. DETECCI√ìN DE PICAZ√ìN EN LA PIEL SIN SARPULLIDO (PRIORIDAD ALTA):
   Si menciona: "me pica la piel", "picaz√≥n en la piel", "picor en la piel" Y "sin sarpullido", "sin erupci√≥n", "sin ronchas"
   ‚Üí RESPUESTA INMEDIATA: dermatologia

112. DETECCI√ìN DE CABEZA PESADA (PRIORIDAD ALTA):
   Si menciona: "me pesa la cabeza", "cabeza pesada", "sensaci√≥n de peso en la cabeza", "como si me pesara la cabeza"
   ‚Üí RESPUESTA INMEDIATA: neurologia

113. DETECCI√ìN DE FLOJERA Y DIFICULTAD PARA CONCENTRARSE (PRIORIDAD ALTA):
   Si menciona: "me da flojera", "todo me da flojera", "flojera" Y "me cuesta concentrarme", "dificultad para concentrarse"
   ‚Üí Si tambi√©n menciona "sed", "peso", "tiroides", "hormon": endocrinologia
   ‚Üí Por defecto: psiquiatria

114. DETECCI√ìN DE ARDOR EN EL PECHO AL COMER R√ÅPIDO (PRIORIDAD ALTA):
   Si menciona: "me arde el pecho" Y "cuando como r√°pido", "al comer r√°pido", "si como r√°pido"
   ‚Üí RESPUESTA INMEDIATA: gastroenterologia

115. DETECCI√ìN DE CANSANCIO A PESAR DE DORMIR (PRIORIDAD ALTA):
   Si menciona: "duermo pero me levanto cansado", "me levanto igual de cansado", "duermo pero sigo cansado", "cansado aunque duerma"
   ‚Üí Si tambi√©n menciona "sed", "peso", "tiroides", "hormon": endocrinologia
   ‚Üí Por defecto: medicina-general

116. DETECCI√ìN DE MOLESTIA LEVE EN LA PANZA (PRIORIDAD ALTA):
   Si menciona: "molestia leve en la panza", "molestia en la panza", "panza molesta", "molestia en el abdomen" Y "todo el tiempo", "constantemente"
   ‚Üí RESPUESTA INMEDIATA: gastroenterologia

117. DETECCI√ìN DE TEMBLOR EN LA MANO SIN RAZ√ìN (PRIORIDAD ALTA):
   Si menciona: "me tiembla la mano", "temblor en la mano", "mano temblorosa" Y "sin raz√≥n", "sin motivo", "a veces"
   ‚Üí Si tambi√©n menciona "tiroides", "hormon": endocrinologia
   ‚Üí Por defecto: neurologia

118. DETECCI√ìN DE CALOR Y TRANSPIRACI√ìN SIN MOTIVO (PRIORIDAD ALTA):
   Si menciona: "siento calor", "transpiro", "sudo" Y "sin motivo", "sin raz√≥n", "sin hacer nada"
   ‚Üí RESPUESTA INMEDIATA: endocrinologia

119. DETECCI√ìN DE DOLOR DE ESPALDA BAJA AL AGACHARSE (PRIORIDAD ALTA):
   Si menciona: "me duele la espalda baja" Y "al agacharme", "cuando me agacho", "al agacharse"
   ‚Üí RESPUESTA INMEDIATA: ortopedia

120. DETECCI√ìN DE VISTA NUBLADA POR SEGUNDOS (PRIORIDAD ALTA):
   Si menciona: "se me nubla la vista", "vista nublada", "visi√≥n nublada" Y "por unos segundos", "por segundos", "moment√°neamente"
   ‚Üí Si tambi√©n menciona "dolor de cabeza", "mareo": neurologia
   ‚Üí Por defecto: oftalmologia

121. DETECCI√ìN DE TOS SIN FIEBRE (PRIORIDAD ALTA):
   Si menciona: "tos" Y ("sin fiebre" O "desde hace rato" O "persistente" O "que no se va" O "no mejora")
   ‚Üí RESPUESTA INMEDIATA: neumologia
   ‚ö†Ô∏è Esta detecci√≥n es redundante con la #33 pero se mantiene para mayor cobertura

122. DETECCI√ìN DE OJOS HINCHADOS AL DESPERTAR (PRIORIDAD ALTA):
   Si menciona: "ojos hinchados al despertar", "me levanto con los ojos hinchados", "ojos hinchados casi todos los d√≠as"
   ‚Üí RESPUESTA INMEDIATA: medicina-general (alergia, pero no tenemos alergolog√≠a)

123. DETECCI√ìN DE PU√ëADA EN EL PECHO R√ÅPIDA (PRIORIDAD ALTA):
   Si menciona: "punzada en el pecho", "punzada en el pecho", "dolor punzante en el pecho" Y "pasa r√°pido", "r√°pida", "breve"
   ‚Üí RESPUESTA INMEDIATA: cardiologia

124. DETECCI√ìN DE GARGANTA RARA CON SENSACI√ìN DE ATRAPADO (PRIORIDAD ALTA):
   Si menciona: "garganta rara", "garganta extra√±a", "sensaci√≥n en la garganta" Y "como con algo atorado", "algo atorado", "nudo en la garganta"
   ‚Üí RESPUESTA INMEDIATA: otorrinolaringologia

125. DETECCI√ìN DE DOLOR EN LAS PIERNAS AL CAMINAR (PRIORIDAD ALTA):
   Si menciona: "me duelen las piernas" Y "cuando camino mucho", "al caminar", "al caminar mucho"
   ‚Üí RESPUESTA INMEDIATA: ortopedia

126. DETECCI√ìN DE EST√ìMAGO REVUELTO (PRIORIDAD ALTA):
   Si menciona: "est√≥mago revuelto", "estomago revuelto", "tengo el est√≥mago revuelto", "est√≥mago alterado"
   ‚Üí RESPUESTA INMEDIATA: gastroenterologia

127. DETECCI√ìN DE NERVIOSO SIN MOTIVO (PRIORIDAD ALTA):
   Si menciona: "me siento nervioso", "nervioso", "nervios" Y "sin motivo", "sin raz√≥n", "a veces"
   ‚Üí RESPUESTA INMEDIATA: psiquiatria

128. DETECCI√ìN DE DIFICULTAD PARA RESPIRAR AL SUBIR ESCALERAS (PRIORIDAD ALTA):
   Si menciona: "me cuesta respirar" Y "al subir escaleras", "cuando subo escaleras", "al subir"
   ‚Üí Si tambi√©n menciona "coraz√≥n", "palpitaciones": cardiologia
   ‚Üí Por defecto: neumologia

129. DETECCI√ìN DE PICAZ√ìN EN OJOS AL AIRE LIBRE (PRIORIDAD ALTA):
   Si menciona: "me pican los ojos" Y "al aire libre", "cuando estoy al aire libre", "cuando salgo"
   ‚Üí RESPUESTA INMEDIATA: oftalmologia

130. DETECCI√ìN DE TENSI√ìN EN EL CUELLO (PRIORIDAD ALTA):
   Si menciona: "molestia en el cuello", "tensi√≥n en el cuello", "cuello tenso", "como tensi√≥n" Y "leve"
   ‚Üí RESPUESTA INMEDIATA: ortopedia

131. DETECCI√ìN DE MAREOS SIN P√âRDIDA DE EQUILIBRIO (PRIORIDAD ALTA):
   Si menciona: "me siento mareado", "mareo", "mareos" Y "pero no llego a perder el equilibrio", "sin perder equilibrio", "leve"
   ‚Üí RESPUESTA INMEDIATA: neurologia

132. DETECCI√ìN DE DEDOS DORMIDOS DE LAS MANOS (PRIORIDAD ALTA):
   Si menciona: "se me duermen los dedos", "dedos dormidos", "dedos de las manos dormidos", "dedos entumecidos"
   ‚Üí Si tambi√©n menciona "dolor", "rigidez": reumatologia
   ‚Üí Por defecto: neurologia

133. DETECCI√ìN DE DIFICULTAD PARA LEVANTARSE POR LAS MA√ëANAS (PRIORIDAD ALTA):
   Si menciona: "me cuesta levantarme", "dificultad para levantarme", "me cuesta mucho levantarme" Y "por las ma√±anas", "en las ma√±anas"
   ‚Üí Si tambi√©n menciona "sed", "peso", "tiroides", "hormon": endocrinologia
   ‚Üí Por defecto: psiquiatria

134. DETECCI√ìN DE PIEL M√ÅS SECA DE LO NORMAL (PRIORIDAD ALTA):
   Si menciona: "piel m√°s seca", "piel seca", "piel muy seca" Y "de lo normal", "m√°s de lo normal"
   ‚Üí RESPUESTA INMEDIATA: dermatologia

135. DETECCI√ìN DE DOLOR DE CABEZA SIN CAF√â (PRIORIDAD ALTA):
   Si menciona: "dolor de cabeza" Y "si no tomo caf√©", "sin caf√©", "cuando no tomo caf√©"
   ‚Üí RESPUESTA INMEDIATA: neurologia

136. DETECCI√ìN DE AGITACI√ìN SIN ESFUERZO (PRIORIDAD ALTA):
   Si menciona: "me siento agitado", "agitado", "agitaci√≥n" Y "aunque no haya hecho nada", "sin hacer nada", "sin motivo"
   ‚Üí Si tambi√©n menciona "coraz√≥n", "palpitaciones": cardiologia
   ‚Üí Por defecto: psiquiatria

137. DETECCI√ìN DE NUDO EN LA PANZA SIN ENFERMEDAD (PRIORIDAD ALTA):
   Si menciona: "nudo en la panza", "nudo en el est√≥mago", "sensaci√≥n de nudo" Y "sin estar enfermo", "sin enfermedad"
   ‚Üí RESPUESTA INMEDIATA: gastroenterologia

138. DETECCI√ìN DE DOLOR MUSCULAR COMO SI HUBIERA HECHO EJERCICIO (PRIORIDAD ALTA):
   Si menciona: "me duelen los m√∫sculos", "dolor muscular" Y "como si hubiera hecho ejercicio", "como despu√©s de ejercicio"
   ‚Üí RESPUESTA INMEDIATA: reumatologia

139. DETECCI√ìN DE DIFICULTAD PARA RESPIRAR POR LA NARIZ (PRIORIDAD ALTA):
   Si menciona: "me cuesta respirar por la nariz", "dificultad para respirar por la nariz", "no puedo respirar por la nariz" Y "desde hace tiempo"
   ‚Üí RESPUESTA INMEDIATA: otorrinolaringologia

140. DETECCI√ìN DE LATIDO EN EL OJO (PRIORIDAD ALTA):
   Si menciona: "me late el ojo", "latido en el ojo", "ojo que late", "sensaci√≥n de latido en el ojo"
   ‚Üí RESPUESTA INMEDIATA: neurologia

141. DETECCI√ìN DE DOLOR DE CABEZA AL AGACHARSE (PRIORIDAD ALTA):
   Si menciona: "me duele la cabeza" Y "al agacharme", "cuando me agacho", "al agacharse"
   ‚Üí RESPUESTA INMEDIATA: neurologia

142. DETECCI√ìN DE CUELLO TIESO AL DESPERTAR (PRIORIDAD ALTA):
   Si menciona: "me levanto con el cuello tieso", "cuello tieso al despertar", "cuello r√≠gido al despertar"
   ‚Üí RESPUESTA INMEDIATA: ortopedia

143. DETECCI√ìN DE ARDOR EN LA BOCA SIN RAZ√ìN (PRIORIDAD ALTA):
   Si menciona: "me arde la boca", "ardor en la boca", "boca que arde" Y "sin raz√≥n", "sin motivo"
   ‚Üí RESPUESTA INMEDIATA: odontologia

144. DETECCI√ìN DE PIES FR√çOS CONSTANTEMENTE (PRIORIDAD ALTA):
   Si menciona: "pies fr√≠os", "tengo los pies fr√≠os" Y "casi todo el tiempo", "constantemente", "siempre"
   ‚Üí Si tambi√©n menciona "tiroides", "hormon": endocrinologia
   ‚Üí Por defecto: reumatologia

145. DETECCI√ìN DE DIFICULTAD PARA RESPIRAR ACOSTADO BOCA ARRIBA (PRIORIDAD ALTA):
   Si menciona: "me cuesta respirar" Y "cuando estoy acostado boca arriba", "acostado boca arriba", "boca arriba"
   ‚Üí Si tambi√©n menciona "coraz√≥n", "palpitaciones": cardiologia
   ‚Üí Por defecto: neumologia

146. DETECCI√ìN DE SUENOS EN LAS TRIPAS SIN HAMBRE (PRIORIDAD ALTA):
   Si menciona: "me suenan las tripas", "ruidos en el est√≥mago", "suenan los intestinos" Y "aunque no tenga hambre", "sin hambre"
   ‚Üí RESPUESTA INMEDIATA: gastroenterologia

147. DETECCI√ìN DE SENSACI√ìN DE LLENO DE AIRE DESPU√âS DE COMER (PRIORIDAD ALTA):
   Si menciona: "me siento lleno de aire", "lleno de aire", "como lleno de aire" Y "despu√©s de comer", "tras comer"
   ‚Üí RESPUESTA INMEDIATA: gastroenterologia

148. DETECCI√ìN DE VISTA BORROSA MOMENT√ÅNEA (PRIORIDAD ALTA):
   Si menciona: "vista borrosa", "visi√≥n borrosa" Y "un segundo", "por un segundo", "moment√°neamente", "y se me pasa"
   ‚Üí RESPUESTA INMEDIATA: oftalmologia

149. DETECCI√ìN DE DOLOR EN LA MAND√çBULA AL MASTICAR (PRIORIDAD ALTA):
   Si menciona: "me duele la mand√≠bula" Y "al masticar", "cuando mastico", "al masticar"
   ‚Üí RESPUESTA INMEDIATA: odontologia

150. DETECCI√ìN DE MANOS H√öMEDAS CONSTANTEMENTE (PRIORIDAD ALTA):
   Si menciona: "manos h√∫medas", "manos sudorosas", "manos mojadas" Y "todo el tiempo", "constantemente"
   ‚Üí Si tambi√©n menciona "tiroides", "hormon": endocrinologia
   ‚Üí Por defecto: psiquiatria

151. DETECCI√ìN DE PICAZ√ìN EN BRAZOS SIN VISIBLE (PRIORIDAD ALTA):
   Si menciona: "me pican los brazos", "picaz√≥n en los brazos" Y "sin que se vea nada", "sin sarpullido", "sin erupci√≥n"
   ‚Üí RESPUESTA INMEDIATA: dermatologia

152. DETECCI√ìN DE EST√ìMAGO SENSIBLE A ALIMENTOS (PRIORIDAD ALTA):
   Si menciona: "est√≥mago sensible", "estomago sensible" Y "a ciertos alimentos", "a algunos alimentos", "a ciertos comidas"
   ‚Üí RESPUESTA INMEDIATA: gastroenterologia

153. DETECCI√ìN DE DIFICULTAD PARA RESPIRAR CON CALOR O HUMEDAD (PRIORIDAD ALTA):
   Si menciona: "me cuesta respirar" Y "cuando hace calor", "con calor", "cuando hay humedad", "con humedad"
   ‚Üí RESPUESTA INMEDIATA: neumologia

154. DETECCI√ìN DE GARGANTA IRRITADA AL DESPERTAR (PRIORIDAD ALTA):
   Si menciona: "garganta irritada", "me levanto con la garganta irritada", "garganta irritada al despertar"
   ‚Üí RESPUESTA INMEDIATA: otorrinolaringologia

155. DETECCI√ìN DE PRESI√ìN LEVE EN EL PECHO (PRIORIDAD ALTA):
   Si menciona: "presi√≥n en el pecho", "presi√≥n leve en el pecho", "sensaci√≥n de presi√≥n en el pecho" Y "a veces", "a ratos"
   ‚Üí RESPUESTA INMEDIATA: cardiologia

156. DETECCI√ìN DE CUERPO PESADO Y DIFICULTAD PARA MOVERSE (PRIORIDAD ALTA):
   Si menciona: "cuerpo pesado", "me siento pesado", "cuerpo pesado" Y "me cuesta moverme", "dificultad para moverme"
   ‚Üí Si tambi√©n menciona "sed", "peso", "tiroides": endocrinologia
   ‚Üí Por defecto: medicina-general

157. DETECCI√ìN DE DOLOR DE RODILLA CON CAMBIOS DE CLIMA (PRIORIDAD ALTA):
   Si menciona: "me duele una rodilla" Y "cuando cambia el clima", "con cambios de clima", "cuando cambia el tiempo"
   ‚Üí RESPUESTA INMEDIATA: reumatologia

158. DETECCI√ìN DE AGITACI√ìN R√ÅPIDA CON ESFUERZO M√çNIMO (PRIORIDAD ALTA):
   Si menciona: "me agito r√°pido", "agitaci√≥n r√°pida" Y "al hacer algo m√≠nimo", "con poco esfuerzo", "con esfuerzo m√≠nimo"
   ‚Üí Si tambi√©n menciona "coraz√≥n", "palpitaciones": cardiologia
   ‚Üí Por defecto: neumologia

159. DETECCI√ìN DE PICAZ√ìN EN EL CUERO CABELLUDO SIN CASPA (PRIORIDAD ALTA):
   Si menciona: "picaz√≥n en el cuero cabelludo", "me pica el cuero cabelludo", "picor en la cabeza" Y "sin caspa", "sin tener caspa"
   ‚Üí RESPUESTA INMEDIATA: dermatologia

160. DETECCI√ìN DE DIFICULTAD PARA TRAGAR CON SENSACI√ìN DE TRABADO (PRIORIDAD ALTA):
   Si menciona: "me cuesta tragar", "dificultad para tragar" Y "como si se trabara algo", "se trabara", "sensaci√≥n de trabado"
   ‚Üí RESPUESTA INMEDIATA: otorrinolaringologia

161. DETECCI√ìN DE MAREOS AL GIRAR R√ÅPIDO (PRIORIDAD ALTA):
   Si menciona: "me dan mareos", "mareos" Y "cuando giro r√°pido", "al girar r√°pido", "al girar"
   ‚Üí RESPUESTA INMEDIATA: otorrinolaringologia

162. DETECCI√ìN DE SUE√ëO DESPU√âS DE COMER (PRIORIDAD ALTA):
   Si menciona: "me da sue√±o despu√©s de comer", "sue√±o despu√©s de comer", "somnolencia despu√©s de comer" Y "aunque no haya comido mucho"
   ‚Üí RESPUESTA INMEDIATA: endocrinologia

163. DETECCI√ìN DE TENSI√ìN CONSTANTE (PRIORIDAD ALTA):
   Si menciona: "me siento tenso", "tensi√≥n", "tenso" Y "todo el tiempo", "constantemente", "como si no pudiera aflojar"
   ‚Üí RESPUESTA INMEDIATA: psiquiatria

164. DETECCI√ìN DE PINCHAZOS EN EL PECHO (PRIORIDAD ALTA):
   Si menciona: "pinchazos en el pecho", "pinchazos en el pecho", "como pinchazos" Y "a veces", "a ratos"
   ‚Üí RESPUESTA INMEDIATA: cardiologia

165. DETECCI√ìN DE DIFICULTAD PARA CONCENTRARSE EN LA LECTURA (PRIORIDAD ALTA):
   Si menciona: "me cuesta concentrarme", "dificultad para concentrarse" Y "en lo que leo", "al leer", "en la lectura"
   ‚Üí RESPUESTA INMEDIATA: psiquiatria

166. DETECCI√ìN DE SED AUMENTADA (PRIORIDAD ALTA):
   Si menciona: "m√°s sed de lo normal", "tengo m√°s sed", "sed aumentada", "sed excesiva"
   ‚Üí RESPUESTA INMEDIATA: endocrinologia

167. DETECCI√ìN DE DOLOR EN BRAZOS AL DORMIR DE UN LADO (PRIORIDAD ALTA):
   Si menciona: "me duelen los brazos" Y "cuando duermo de un lado", "al dormir de un lado", "dormir de un lado"
   ‚Üí RESPUESTA INMEDIATA: ortopedia

168. DETECCI√ìN DE EST√ìMAGO SENSIBLE E HINCHAZ√ìN F√ÅCIL (PRIORIDAD ALTA):
   Si menciona: "est√≥mago sensible", "estomago sensible" Y "me hincho f√°cil", "hinchaz√≥n f√°cil", "se me hincha f√°cil"
   ‚Üí RESPUESTA INMEDIATA: gastroenterologia

169. DETECCI√ìN DE DOLOR DE CABEZA SI NO COME A TIEMPO (PRIORIDAD ALTA):
   Si menciona: "me duele la cabeza" Y "si no como a tiempo", "cuando no como a tiempo", "sin comer a tiempo"
   ‚Üí Si tambi√©n menciona "sed", "peso", "tiroides": endocrinologia
   ‚Üí Por defecto: neurologia

170. DETECCI√ìN DE DIFICULTAD PARA RESPIRAR CUANDO EST√Å NERVIOSO (PRIORIDAD ALTA):
   Si menciona: "me cuesta respirar" Y "cuando estoy nervioso", "al estar nervioso", "si estoy nervioso"
   ‚Üí RESPUESTA INMEDIATA: psiquiatria

171. DETECCI√ìN DE SANGRADO NASAL AL DESPERTAR (PRIORIDAD ALTA):
   Si menciona: "me despierto con la nariz sangrando", "nariz sangrando al despertar", "sangrado nasal al despertar"
   ‚Üí RESPUESTA INMEDIATA: otorrinolaringologia

172. DETECCI√ìN DE MOLESTIA EN PARTE BAJA DEL ABDOMEN (PRIORIDAD ALTA):
   Si menciona: "molestia en la parte baja del abdomen", "molestia parte baja abdomen", "dolor parte baja abdomen" Y "leve"
   ‚Üí Si g√©nero es FEMENINO: ginecologia
   ‚Üí Si g√©nero es MASCULINO: urologia
   ‚Üí Por defecto: gastroenterologia

173. DETECCI√ìN DE DIFICULTAD PARA MANTENER EQUILIBRIO CON OJOS CERRADOS (PRIORIDAD ALTA):
   Si menciona: "me cuesta mantener el equilibrio" Y "si cierro los ojos", "con los ojos cerrados", "al cerrar los ojos"
   ‚Üí RESPUESTA INMEDIATA: neurologia

174. DETECCI√ìN DE DOLOR EN DEDOS CON FR√çO (PRIORIDAD ALTA):
   Si menciona: "me duelen los dedos" Y "cuando hace fr√≠o", "con el fr√≠o", "si hace fr√≠o"
   ‚Üí RESPUESTA INMEDIATA: reumatologia

175. DETECCI√ìN DE AGOTAMIENTO SIN ESFUERZO (PRIORIDAD ALTA):
   Si menciona: "me siento agotado", "agotado", "agotamiento" Y "aunque no haya hecho nada", "sin hacer nada"
   ‚Üí Si tambi√©n menciona "sed", "peso", "tiroides": endocrinologia
   ‚Üí Por defecto: medicina-general

176. DETECCI√ìN DE LATIDOS FUERTES DEL CORAZ√ìN EN REPOSO (PRIORIDAD ALTA):
   Si menciona: "me late fuerte el coraz√≥n", "latidos fuertes", "coraz√≥n late fuerte" Y "cuando estoy tranquilo", "en reposo", "sin hacer nada"
   ‚Üí RESPUESTA INMEDIATA: cardiologia

177. DETECCI√ìN DE ZUMBIDO EN LA CABEZA PERSISTENTE (PRIORIDAD ALTA):
   Si menciona: "zumbido en la cabeza", "zumbido en la cabeza", "ruido en la cabeza" Y "que no se va", "persistente", "constante"
   ‚Üí RESPUESTA INMEDIATA: neurologia

178. DETECCI√ìN DE ACIDEZ AUNQUE COMA POCO (PRIORIDAD ALTA):
   Si menciona: "me da acidez", "acidez" Y "aunque coma poco", "comiendo poco", "aunque no coma mucho"
   ‚Üí RESPUESTA INMEDIATA: gastroenterologia

179. DETECCI√ìN DE DOLOR EN PIERNAS AL ESTAR SENTADO (PRIORIDAD ALTA):
   Si menciona: "me duelen las piernas" Y "si estoy mucho tiempo sentado", "al estar sentado", "cuando estoy sentado"
   ‚Üí RESPUESTA INMEDIATA: ortopedia

180. DETECCI√ìN DE ARDOR EN EL EST√ìMAGO A RATOS (PRIORIDAD ALTA):
   Si menciona: "me arde el est√≥mago", "ardor en el est√≥mago" Y "a veces", "a ratos", "a veces"
   ‚Üí RESPUESTA INMEDIATA: gastroenterologia

181. DETECCI√ìN DE DIFICULTAD PARA RESPIRAR POR LA NOCHE (PRIORIDAD ALTA):
   Si menciona: "me cuesta respirar por la noche", "dificultad para respirar por la noche", "respirar por la noche"
   ‚Üí RESPUESTA INMEDIATA: neumologia

182. DETECCI√ìN DE IRRITABILIDAD (PRIORIDAD ALTA):
   Si menciona: "muy irritable", "irritabilidad", "me siento irritable" Y "√∫ltimamente", "recientemente"
   ‚Üí RESPUESTA INMEDIATA: psiquiatria

183. DETECCI√ìN DE MANOS DORMIDAS AL DESPERTAR (PRIORIDAD ALTA):
   Si menciona: "manos dormidas", "manos entumecidas" Y "cuando me despierto", "al despertar", "al despertarme"
   ‚Üí Si tambi√©n menciona "dolor", "rigidez": reumatologia
   ‚Üí Por defecto: neurologia

184. DETECCI√ìN DE DOLOR EN EL CUELLO DESPU√âS DE TRABAJAR (PRIORIDAD ALTA):
   Si menciona: "me duele el cuello" Y "despu√©s de trabajar", "al trabajar", "despu√©s de trabajar muchas horas"
   ‚Üí RESPUESTA INMEDIATA: ortopedia

185. DETECCI√ìN DE DOLOR DETR√ÅS DE LOS OJOS (PRIORIDAD ALTA):
   Si menciona: "dolor detr√°s de los ojos", "dolor detr√°s de los ojos", "dolor leve detr√°s de los ojos"
   ‚Üí RESPUESTA INMEDIATA: oftalmologia

186. DETECCI√ìN DE PRESI√ìN EN LA SIEN (PRIORIDAD ALTA):
   Si menciona: "presi√≥n en la sien", "presi√≥n en la sien", "presi√≥n leve en la sien" Y "a veces", "a ratos"
   ‚Üí RESPUESTA INMEDIATA: neurologia

187. DETECCI√ìN DE DIFICULTAD PARA RESPIRAR CON FR√çO (PRIORIDAD ALTA):
   Si menciona: "me cuesta respirar" Y "cuando hace fr√≠o", "con el fr√≠o", "si hace fr√≠o"
   ‚Üí RESPUESTA INMEDIATA: neumologia

188. DETECCI√ìN DE MOLESTIA ESTOMACAL CON COMIDA PESADA (PRIORIDAD ALTA):
   Si menciona: "me molesta el est√≥mago" Y "si como algo pesado", "con comida pesada", "al comer pesado"
   ‚Üí RESPUESTA INMEDIATA: gastroenterologia

189. DETECCI√ìN DE ARDOR EN LA PIEL CON EL SOL (PRIORIDAD ALTA):
   Si menciona: "me arde la piel" Y "cuando me da el sol", "con el sol", "al sol"
   ‚Üí RESPUESTA INMEDIATA: dermatologia

190. DETECCI√ìN DE DOLOR MUSCULAR SIN EJERCICIO (PRIORIDAD ALTA):
   Si menciona: "me duelen los m√∫sculos" Y "aunque no haya hecho ejercicio", "sin hacer ejercicio", "sin ejercicio"
   ‚Üí RESPUESTA INMEDIATA: reumatologia

191. DETECCI√ìN DE PIERNAS ENTUMECIDAS AL DESPERTAR (PRIORIDAD ALTA):
   Si menciona: "piernas entumecidas", "piernas dormidas" Y "al despertar", "cuando me despierto", "al despertarme"
   ‚Üí RESPUESTA INMEDIATA: neurologia

192. DETECCI√ìN DE DIFICULTAD PARA TRAGAR SALIVA (PRIORIDAD ALTA):
   Si menciona: "me cuesta tragar saliva", "dificultad para tragar saliva", "tragar saliva" Y "a veces"
   ‚Üí RESPUESTA INMEDIATA: otorrinolaringologia

193. DETECCI√ìN DE SENSACI√ìN DE FIEBRE SIN FIEBRE (PRIORIDAD ALTA):
   Si menciona: "sensaci√≥n de fiebre", "como si tuviera fiebre" Y "pero no tengo", "sin tener fiebre", "sin fiebre"
   ‚Üí RESPUESTA INMEDIATA: medicina-general

194. DETECCI√ìN DE PICAZ√ìN EN LA NARIZ FRECUENTE (PRIORIDAD ALTA):
   Si menciona: "me pica la nariz", "picaz√≥n en la nariz", "picor en la nariz" Y "muy seguido", "frecuentemente"
   ‚Üí RESPUESTA INMEDIATA: medicina-general (alergia, pero no tenemos alergolog√≠a)

195. DETECCI√ìN DE PRESI√ìN EN LA ESPALDA MEDIA (PRIORIDAD ALTA):
   Si menciona: "presi√≥n en la espalda", "presi√≥n en la espalda media", "especie de presi√≥n en la espalda"
   ‚Üí RESPUESTA INMEDIATA: ortopedia

196. DETECCI√ìN DE DOLOR DE PECHO SOLO AL RESPIRAR PROFUNDO (PRIORIDAD ALTA):
   Si menciona: "me duele el pecho" Y "solo cuando respiro profundo", "al respirar profundo", "cuando respiro profundo"
   ‚Üí RESPUESTA INMEDIATA: neumologia

197. DETECCI√ìN DE MAREOS AL ESTAR DE PIE (PRIORIDAD ALTA):
   Si menciona: "me siento mareado" Y "cuando estoy mucho rato de pie", "al estar de pie", "de pie mucho tiempo"
   ‚Üí RESPUESTA INMEDIATA: neurologia

198. DETECCI√ìN DE PU√ëADA EN EL ABDOMEN (PRIORIDAD ALTA):
   Si menciona: "punzada en el abdomen", "punzada en el abdomen", "como una punzada" Y "a veces", "a ratos"
   ‚Üí RESPUESTA INMEDIATA: gastroenterologia

199. DETECCI√ìN DE DIFICULTAD PARA MANTENER OJOS ABIERTOS (PRIORIDAD ALTA):
   Si menciona: "me cuesta mantener los ojos abiertos", "dificultad para mantener ojos abiertos" Y "al final del d√≠a"
   ‚Üí Si tambi√©n menciona "sed", "peso", "tiroides": endocrinologia
   ‚Üí Por defecto: oftalmologia

200. DETECCI√ìN DE SENSACI√ìN DE ENFERMEDAD INMINENTE (PRIORIDAD ALTA):
   Si menciona: "me siento raro", "como si me fuera a enfermar", "sensaci√≥n de enfermedad", "como si fuera a enfermar"
   ‚Üí RESPUESTA INMEDIATA: medicina-general

201. DETECCI√ìN DE AGITACI√ìN R√ÅPIDA AL CAMINAR DESPACIO (PRIORIDAD ALTA):
   Si menciona: "me agito r√°pido", "agitaci√≥n r√°pida" Y "aunque camine despacio", "caminando despacio", "al caminar despacio"
   ‚Üí Si tambi√©n menciona "coraz√≥n", "palpitaciones": cardiologia
   ‚Üí Por defecto: neumologia

202. DETECCI√ìN DE DOLOR EN DEDOS DE LOS PIES SIN MOTIVO (PRIORIDAD ALTA):
   Si menciona: "me duelen los dedos de los pies", "dolor en dedos de los pies" Y "sin motivo", "sin raz√≥n", "a veces"
   ‚Üí RESPUESTA INMEDIATA: reumatologia

203. DETECCI√ìN DE CARA CALIENTE SIN FIEBRE (PRIORIDAD ALTA):
   Si menciona: "cara caliente", "siento la cara caliente" Y "sin fiebre", "pero no tengo fiebre"
   ‚Üí Si tambi√©n menciona "tiroides", "hormon": endocrinologia
   ‚Üí Por defecto: medicina-general

204. DETECCI√ìN DE HOMBROS TENSOS CONSTANTEMENTE (PRIORIDAD ALTA):
   Si menciona: "hombros tensos", "hombros r√≠gidos" Y "todo el tiempo", "constantemente"
   ‚Üí RESPUESTA INMEDIATA: ortopedia

205. DETECCI√ìN DE DIFICULTAD PARA RESPIRAR BIEN ACOSTADO (PRIORIDAD ALTA):
   Si menciona: "me cuesta respirar bien" Y "cuando estoy acostado", "al estar acostado", "acostado"
   ‚Üí Si tambi√©n menciona "coraz√≥n", "palpitaciones": cardiologia
   ‚Üí Por defecto: neumologia

‚ö†Ô∏è ESPECIALIDADES NO DISPONIBLES (IGNORAR SI SE MENCIONAN):
- Nefrolog√≠a ‚Üí Usar medicina-general o cardiologia (si es hinchaz√≥n de pies con coraz√≥n)
- Alergolog√≠a ‚Üí Usar medicina-general o dermatologia (si es piel) u oftalmologia (si es ojos)
- Fisiatr√≠a ‚Üí Usar ortopedia
- Medicina del sue√±o ‚Üí Usar psiquiatria o endocrinologia (si es cansancio con sed/peso)
- Flebolog√≠a ‚Üí Usar ortopedia o cardiologia
- Podolog√≠a ‚Üí Usar ortopedia
- Psicolog√≠a ‚Üí Usar psiquiatria
- Hepatolog√≠a ‚Üí Usar gastroenterologia
- Infectolog√≠a ‚Üí Usar medicina-general

ESPECIALIDADES DISPONIBLES (solo si no aplica detecci√≥n temprana):

1. odontologia - Problemas dentales/bucales: muela, diente, dental, caries, enc√≠a, gingival, absceso dental, ortodoncia, endodoncia, periodoncia, dolor al masticar, problemas de masticaci√≥n
2. medicina-general - S√≠ntomas generales SIN causa espec√≠fica: fiebre, malestar general, resfriados, gripe, tos general, consultas de rutina, sensaci√≥n de enfermedad, agotamiento sin causa
3. cardiologia - Problemas card√≠acos/cardiovasculares: dolor tor√°cico card√≠aco, palpitaciones, arritmias, hipertensi√≥n, problemas del coraz√≥n (EXCLUIR si menciona dental/muela)
4. neurologia - Problemas neurol√≥gicos/cerebro: dolor de cabeza, cefalea, migra√±a, convulsiones, problemas de memoria, coordinaci√≥n, temblores, par√°lisis
5. pediatria - SOLO si edad < 18 a√±os (cualquier s√≠ntoma en ni√±os/adolescentes)
6. ginecologia - Problemas reproductivos femeninos: embarazo, menstruaci√≥n, problemas p√©lvicos, problemas de mama, menopausia
7. dermatologia - Problemas de piel/pelo/u√±as: erupciones, sarpullidos, manchas, lunares, acn√©, dermatitis, psoriasis
8. oftalmologia - Problemas oculares/visi√≥n: visi√≥n borrosa, dolor ocular, problemas de retina, glaucoma, cataratas
9. ortopedia - Problemas musculoesquel√©ticos: dolor de huesos, articulaciones, espalda, fracturas, esguinces, rodilla, hombro
10. psiquiatria - Problemas mentales/emocionales: depresi√≥n, ansiedad, estr√©s, ataques de p√°nico, trastornos mentales, pensamientos suicidas
11. endocrinologia - Problemas hormonales/metabolismo: diabetes, tiroides, problemas hormonales, obesidad, crecimiento
12. urologia - Problemas urinarios/genitales masculinos: problemas urinarios, pr√≥stata, ri√±ones, vejiga, problemas sexuales masculinos
13. otorrinolaringologia - Problemas o√≠do/nariz/garganta: dolor de o√≠do, problemas de audici√≥n, dolor de garganta, ronquera, sinusitis, rinitis
14. gastroenterologia - Problemas digestivos: dolor de est√≥mago, n√°useas, v√≥mitos, diarrea, estre√±imiento, reflujo, problemas intestinales
15. neumologia - Problemas respiratorios/pulmones: dificultad respiratoria, asma, bronquitis, problemas pulmonares, tos cr√≥nica
16. reumatologia - Enfermedades autoinmunes/articulaciones: artritis, artrosis, lupus, fibromialgia, dolor articular cr√≥nico
17. hematologia - Problemas de sangre: anemia, problemas de coagulaci√≥n, leucemia, linfoma
18. oncologia - C√°ncer/tumores: c√°ncer, tumor, quimioterapia, radioterapia, neoplasia

REGLAS DE SELECCI√ìN (solo si NO aplic√≥ detecci√≥n temprana):

PRIORIDAD 2 (ALTA):
- "depresi√≥n", "ansiedad", "estr√©s", "ataque de p√°nico", "pensamientos suicidas", "trastorno mental" ‚Üí psiquiatria
- "dolor de o√≠do", "problemas de audici√≥n", "dolor de garganta", "ronquera", "sinusitis" ‚Üí otorrinolaringologia
- "dolor de est√≥mago", "dolor abdominal", "n√°useas", "v√≥mitos", "diarrea", "estre√±imiento", "reflujo" ‚Üí gastroenterologia
- "dificultad respiratoria", "asma", "bronquitis", "tos" (cualquier tipo: tos cr√≥nica, tos persistente, tos que no se va, tos constante, tos seca, tos con flema) ‚Üí neumologia
  ‚ö†Ô∏è CR√çTICO: CUALQUIER tipo de tos SIEMPRE va a neumologia, NUNCA a cardiologia
- "problemas urinarios", "pr√≥stata", "ri√±ones", "vejiga", "dolor al orinar" ‚Üí urologia
- "diabetes", "tiroides", "problemas hormonales", "obesidad" ‚Üí endocrinologia
- "dolor de pecho" o "tor√°cico" SOLO si TAMBI√âN menciona "palpitaciones", "arritmia", "coraz√≥n", "card√≠aco" Y NO menciona cabeza/pie/pubis/abdomen ‚Üí cardiologia
  ‚ö†Ô∏è Si solo dice "dolor de pecho" sin s√≠ntomas card√≠acos, NO es cardiologia

PRIORIDAD 3 (MEDIA):
- "piel", "erupci√≥n", "sarpullido", "mancha", "lunar", "acn√©" ‚Üí dermatologia
- "ojo", "visi√≥n", "vista", "dolor ocular" ‚Üí oftalmologia
- "menstrual", "embarazo", "ginecol√≥gico", "menopausia", "vaginal", "ovario", "√∫tero" ‚Üí ginecologia
- "artritis", "artrosis", "lupus", "fibromialgia" ‚Üí reumatologia
- "anemia", "problemas de coagulaci√≥n", "leucemia" ‚Üí hematologia

PRIORIDAD 4 (√öLTIMO RECURSO):
- Solo s√≠ntomas generales como "fiebre", "malestar", "cansancio" SIN s√≠ntomas espec√≠ficos ‚Üí medicina-general

INSTRUCCIONES CR√çTICAS (SEGUIR EN ORDEN ESTRICTO):
1. PRIMERO: Verifica TODAS las detecciones tempranas (1-17) en orden
2. SEGUNDO: Si NO aplica ninguna detecci√≥n temprana, busca coincidencias en PRIORIDAD 2
3. TERCERO: Si no hay coincidencias en PRIORIDAD 2, busca en PRIORIDAD 3
4. √öLTIMO: Solo si NO hay ning√∫n s√≠ntoma espec√≠fico, usa medicina-general
5. NUNCA uses cardiologia para: dolor de cabeza, dolor de pie, dolor de pubis, dolor de pene, dolor de est√≥mago, sed, peso, audici√≥n, pelo, gases, espalda, caminar, torcedura, adormecimiento, sangre, equilibrio, apetito, TOS (cualquier tipo de tos: tos seca, tos con flema, tos persistente, tos que no se va, tos constante, tos cr√≥nica)
6. Cardiologia SOLO si hay s√≠ntomas card√≠acos espec√≠ficos (palpitaciones, arritmia, taquicardia, etc.) junto con dolor tor√°cico card√≠aco
7. ‚ö†Ô∏è REGLA CR√çTICA SOBRE TOS: CUALQUIER tipo de tos (tos seca, tos con flema, tos persistente, tos que no se va, tos constante, tos cr√≥nica, tos desde hace tiempo) SIEMPRE va a neumologia, NUNCA a cardiologia, a menos que TAMBI√âN mencione s√≠ntomas card√≠acos espec√≠ficos como palpitaciones, arritmia, taquicardia junto con dolor tor√°cico card√≠aco
8. Si menciona "sangre al ir al ba√±o" sin especificar, asume gastroenterologia (sangre en heces es m√°s com√∫n)
9. "P√©rdida de equilibrio" SIEMPRE es neurologia, NO ortopedia

Responde SOLO con un objeto JSON v√°lido en este formato exacto (sin markdown, sin c√≥digo, solo JSON puro):
{
    "especialidad_codigo": "odontologia",
    "especialidad_nombre": "Odont√≥logo",
    "diagnostico_preliminar": ["Diagn√≥stico 1", "Diagn√≥stico 2"],
    "urgencia": "Media",
    "recomendaciones_inmediatas": "Qu√© hacer antes de la consulta",
    "posibles_causas": ["Causa 1"],
    "senales_alerta": ["Se√±al de alerta"]
}

IMPORTANTE: El campo "especialidad_codigo" DEBE ser exactamente uno de estos valores (en min√∫sculas, sin espacios):
- odontologia, medicina-general, cardiologia, neurologia, pediatria, ginecologia, dermatologia, oftalmologia, ortopedia
- psiquiatria, endocrinologia, urologia, otorrinolaringologia, gastroenterologia, neumologia, reumatologia, hematologia, oncologia

NO uses nombres completos, solo el c√≥digo en min√∫sculas. Analiza cuidadosamente los s√≠ntomas y elige la especialidad M√ÅS ESPEC√çFICA Y ADECUADA seg√∫n las reglas estrictas de prioridad.`;

                // Google Gemini API (GRATUITO)
                const apiKey = 'AIzaSyBFj5nZ9_dLotrQf3p5DqSKFBVrZCeUAsY';
                const response = await axios.post(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.2, // Reducir temperatura para respuestas m√°s precisas
                        maxOutputTokens: 800,
                        responseMimeType: "application/json"
                    }
                }, {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('üì• Respuesta completa de Gemini recibida:', response.data);
                
                if (!response.data.candidates || !response.data.candidates[0] || !response.data.candidates[0].content) {
                    console.error('‚ùå Respuesta inv√°lida de Gemini: estructura incorrecta');
                    throw new Error('Respuesta inv√°lida de Gemini: estructura de respuesta incorrecta');
                }
                
                const aiResponse = response.data.candidates[0].content.parts[0].text;
                console.log('üìù Respuesta Gemini (texto):', aiResponse);
                
                try {
                    // Limpiar respuesta si tiene markdown o texto adicional
                    let cleanResponse = aiResponse.trim();
                    
                    // Eliminar markdown si existe
                    if (cleanResponse.startsWith('```json')) {
                        cleanResponse = cleanResponse.replace(/```json\n?/g, '').replace(/```\n?/g, '');
                    } else if (cleanResponse.startsWith('```')) {
                        cleanResponse = cleanResponse.replace(/```\n?/g, '');
                    }
                    
                    // Buscar el JSON dentro del texto si hay texto adicional
                    const jsonMatch = cleanResponse.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        cleanResponse = jsonMatch[0];
                    }
                    
                    const parsed = JSON.parse(cleanResponse);
                    console.log('JSON parseado correctamente:', parsed);
                    
                    // Normalizar especialidad
                    const especialidadCodigo = normalizarEspecialidad(parsed.especialidad_codigo || parsed.especialista_recomendado);
                    
                    return {
                        especialidad_codigo: especialidadCodigo,
                        especialidad_nombre: parsed.especialidad_nombre || parsed.especialista_recomendado || 'M√©dico General',
                        especialista_recomendado: parsed.especialidad_nombre || parsed.especialista_recomendado || 'M√©dico General',
                        diagnostico_preliminar: parsed.diagnostico_preliminar || ["Requiere evaluaci√≥n m√©dica"],
                        urgencia: parsed.urgencia || (intensidad >= 8 ? "Alta" : intensidad >= 6 ? "Media" : "Baja"),
                        recomendaciones_inmediatas: parsed.recomendaciones_inmediatas || "Consulta con un m√©dico",
                        posibles_causas: parsed.posibles_causas || ["Requiere evaluaci√≥n m√©dica"],
                        senales_alerta: parsed.senales_alerta || ["Si los s√≠ntomas empeoran, acuda a urgencias"]
                    };
                } catch (parseError) {
                    console.error('Error al parsear respuesta Gemini:', parseError);
                    // Intentar extraer especialidad del texto con todas las especialidades
                    const textoLower = aiResponse.toLowerCase();
                    let especialidadCodigo = 'medicina-general';
                    
                    // Detecci√≥n mejorada con todas las especialidades (en orden de prioridad)
                    if (textoLower.includes('muela') || textoLower.includes('diente') || textoLower.includes('dental') || 
                        textoLower.includes('odont') || textoLower.includes('masticar') || textoLower.includes('caries')) {
                        especialidadCodigo = 'odontologia';
                    }
                    else if (textoLower.includes('c√°ncer') || textoLower.includes('cancer') || textoLower.includes('tumor') || 
                             textoLower.includes('neoplasia') || textoLower.includes('quimioterapia') || textoLower.includes('oncolog')) {
                        especialidadCodigo = 'oncologia';
                    }
                    else if (textoLower.includes('depresi√≥n') || textoLower.includes('depresion') || textoLower.includes('ansiedad') || 
                             textoLower.includes('estr√©s') || textoLower.includes('estres') || textoLower.includes('psiquiatr') || 
                             textoLower.includes('trastorno mental') || textoLower.includes('pensamiento suicida')) {
                        especialidadCodigo = 'psiquiatria';
                    }
                    else if (textoLower.includes('dolor de o√≠do') || textoLower.includes('dolor de oido') || textoLower.includes('audici√≥n') || 
                             textoLower.includes('audicion') || textoLower.includes('dolor de garganta') || textoLower.includes('ronquera') || 
                             textoLower.includes('sinusitis') || textoLower.includes('orl') || textoLower.includes('otorrino')) {
                        especialidadCodigo = 'otorrinolaringologia';
                    }
                    else if (textoLower.includes('dolor de est√≥mago') || textoLower.includes('dolor de estomago') || 
                             textoLower.includes('n√°useas') || textoLower.includes('nauseas') || textoLower.includes('v√≥mitos') || 
                             textoLower.includes('vomitos') || textoLower.includes('diarrea') || textoLower.includes('estre√±imiento') || 
                             textoLower.includes('estrenimiento') || textoLower.includes('reflujo') || textoLower.includes('gastroenter')) {
                        especialidadCodigo = 'gastroenterologia';
                    }
                    else if (textoLower.includes('dificultad respiratoria') || textoLower.includes('asma') || 
                             textoLower.includes('bronquitis') || textoLower.includes('tos cr√≥nica') || textoLower.includes('tos cronica') || 
                             textoLower.includes('neumolog') || textoLower.includes('pulm√≥n') || textoLower.includes('pulmon')) {
                        especialidadCodigo = 'neumologia';
                    }
                    else if (textoLower.includes('problemas urinarios') || textoLower.includes('pr√≥stata') || textoLower.includes('prostata') || 
                             textoLower.includes('ri√±ones') || textoLower.includes('rinones') || textoLower.includes('vejiga') || 
                             textoLower.includes('urolog')) {
                        especialidadCodigo = 'urologia';
                    }
                    else if (textoLower.includes('diabetes') || textoLower.includes('tiroides') || textoLower.includes('hormon') || 
                             textoLower.includes('obesidad') || textoLower.includes('endocrin')) {
                        especialidadCodigo = 'endocrinologia';
                    }
                    else if (textoLower.includes('artritis') || textoLower.includes('artrosis') || textoLower.includes('lupus') || 
                             textoLower.includes('fibromialgia') || textoLower.includes('reumat')) {
                        especialidadCodigo = 'reumatologia';
                    }
                    else if (textoLower.includes('anemia') || textoLower.includes('coagulaci√≥n') || textoLower.includes('coagulacion') || 
                             textoLower.includes('leucemia') || textoLower.includes('hematolog')) {
                        especialidadCodigo = 'hematologia';
                    }
                    else if (textoLower.includes('cardio')) especialidadCodigo = 'cardiologia';
                    else if (textoLower.includes('neuro')) especialidadCodigo = 'neurologia';
                    else if (textoLower.includes('pediatr')) especialidadCodigo = 'pediatria';
                    else if (textoLower.includes('gineco')) especialidadCodigo = 'ginecologia';
                    else if (textoLower.includes('dermato')) especialidadCodigo = 'dermatologia';
                    else if (textoLower.includes('oftalmo')) especialidadCodigo = 'oftalmologia';
                    else if (textoLower.includes('ortope')) especialidadCodigo = 'ortopedia';
                    
                    // Mapear c√≥digos a nombres
                    const especialidadNombres = {
                        'odontologia': 'Odont√≥logo',
                        'medicina-general': 'M√©dico General',
                        'cardiologia': 'Cardi√≥logo',
                        'neurologia': 'Neur√≥logo',
                        'pediatria': 'Pediatra',
                        'ginecologia': 'Ginec√≥logo',
                        'dermatologia': 'Dermat√≥logo',
                        'oftalmologia': 'Oftalm√≥logo',
                        'ortopedia': 'Ortopedista',
                        'psiquiatria': 'Psiquiatra',
                        'endocrinologia': 'Endocrin√≥logo',
                        'urologia': 'Ur√≥logo',
                        'otorrinolaringologia': 'Otorrinolaring√≥logo',
                        'gastroenterologia': 'Gastroenter√≥logo',
                        'neumologia': 'Neum√≥logo',
                        'reumatologia': 'Reumat√≥logo',
                        'hematologia': 'Hemat√≥logo',
                        'oncologia': 'Onc√≥logo'
                    };
                    
                    return {
                        especialidad_codigo: especialidadCodigo,
                        especialidad_nombre: especialidadNombres[especialidadCodigo] || 'M√©dico General',
                        especialista_recomendado: especialidadNombres[especialidadCodigo] || 'M√©dico General',
                        diagnostico_preliminar: ["Requiere evaluaci√≥n m√©dica"],
                        urgencia: intensidad >= 8 ? "Alta" : intensidad >= 6 ? "Media" : "Baja",
                        recomendaciones_inmediatas: "Consulta con un m√©dico",
                        posibles_causas: ["Requiere evaluaci√≥n m√©dica"],
                        senales_alerta: ["Si los s√≠ntomas empeoran, acuda a urgencias"],
                        analisis_completo: aiResponse
                    };
                }
            } catch (error) {
                console.error('Error al consultar Gemini:', error);
                console.error('Detalles del error:', {
                    message: error.message,
                    response: error.response?.data,
                    status: error.response?.status,
                    stack: error.stack
                });
                // Si falla la API, usar an√°lisis b√°sico mejorado
                return null;
            }
        }

        // Funci√≥n principal que intenta usar IA (ahora usa Gemini)
        async function consultarIA(sintomas, edad, intensidad, duracion, genero) {
            console.log('üîç Iniciando consulta con Gemini...');
            // Intentar con Gemini primero (gratuito)
            const geminiResult = await consultarGemini(sintomas, edad, intensidad, duracion, genero);
            if (geminiResult) {
                console.log('‚úÖ Gemini respondi√≥ correctamente:', geminiResult);
                return geminiResult;
            }
            console.log('‚ö†Ô∏è Gemini no respondi√≥, usando an√°lisis b√°sico');
            // Si falla, retornar null para usar an√°lisis b√°sico
            return null;
        }

        function analyzeSymptomsAndRecommendSpecialist(sintomas, edad, intensidad, sintomasAdicionales = [], genero = '') {
            const sintomasLower = sintomas.toLowerCase();
            
            // PRIORIDAD M√ÅXIMA: Tos persistente/constante - debe ir a Neumolog√≠a (ANTES que cualquier otra detecci√≥n relacionada con pecho/coraz√≥n)
            if (sintomasLower.includes('tos') &&
                (sintomasLower.includes('no se va') || sintomasLower.includes('que no se va') ||
                sintomasLower.includes('no mejora') || sintomasLower.includes('que no mejora') ||
                sintomasLower.includes('persistente') || sintomasLower.includes('constante') ||
                sintomasLower.includes('desde hace') || sintomasLower.includes('hace tiempo') ||
                sintomasLower.includes('hace d√≠as') || sintomasLower.includes('hace semanas') ||
                sintomasLower.includes('hace 1 semana') || sintomasLower.includes('hace una semana') ||
                sintomasLower.includes('cr√≥nica') || sintomasLower.includes('cronica'))) {
                return {
                    recommendedSpeciality: 'neumologia',
                    specialityName: 'Neum√≥logo',
                    description: 'Especialista en enfermedades respiratorias y pulmones',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // PRIORIDAD M√ÅXIMA: Punzada en el est√≥mago/abdomen - debe ir a Gastroenterolog√≠a (ANTES que cualquier otra detecci√≥n)
            if (sintomasLower.includes('punzada en el est√≥mago') || sintomasLower.includes('punzada en el estomago') ||
                sintomasLower.includes('punzada en el abdomen') || sintomasLower.includes('punzada en el est√≥mago al comer') ||
                sintomasLower.includes('punzada en el estomago al comer') || sintomasLower.includes('punzada en el est√≥mago despu√©s de comer') ||
                sintomasLower.includes('punzada est√≥mago') || sintomasLower.includes('punzada estomago') ||
                sintomasLower.includes('punzada abdomen') || sintomasLower.includes('punzada en la panza') ||
                sintomasLower.includes('punzada panza') || (sintomasLower.includes('punzada') && 
                (sintomasLower.includes('est√≥mago') || sintomasLower.includes('estomago') || sintomasLower.includes('abdomen') ||
                 sintomasLower.includes('panza') || sintomasLower.includes('comer')))) {
                return {
                    recommendedSpeciality: 'gastroenterologia',
                    specialityName: 'Gastroenter√≥logo',
                    description: 'Especialista en sistema digestivo y enfermedades gastrointestinales',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Dolor abdominal/est√≥mago despu√©s de comer o al comer
            if ((sintomasLower.includes('dolor en el abdomen') || sintomasLower.includes('dolor abdominal') ||
                sintomasLower.includes('dolor en el est√≥mago') || sintomasLower.includes('dolor de est√≥mago') ||
                sintomasLower.includes('dolor est√≥mago') || sintomasLower.includes('dolor estomago')) &&
                (sintomasLower.includes('despu√©s de comer') || sintomasLower.includes('al comer') ||
                sintomasLower.includes('tras comer') || sintomasLower.includes('cuando como') ||
                sintomasLower.includes('si como') || sintomasLower.includes('comiendo'))) {
                return {
                    recommendedSpeciality: 'gastroenterologia',
                    specialityName: 'Gastroenter√≥logo',
                    description: 'Especialista en sistema digestivo y enfermedades gastrointestinales',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // PRIORIDAD ALTA: Detectar s√≠ntomas espec√≠ficos primero
            // Dolor dental/muela - debe ir a Odontolog√≠a
            if (sintomasLower.includes('muela') || sintomasLower.includes('diente') || sintomasLower.includes('dental') || 
                sintomasLower.includes('odont') || sintomasLower.includes('caries') || sintomasLower.includes('enc√≠a') ||
                sintomasLower.includes('gingival') || sintomasLower.includes('masticar') || sintomasLower.includes('mastic') ||
                sintomasLower.includes('absceso dental') || sintomasLower.includes('ortodoncia') ||
                (sintomasLower.includes('boca') && sintomasLower.includes('dolor'))) {
                return {
                    recommendedSpeciality: 'odontologia',
                    specialityName: 'Odont√≥logo',
                    description: 'Especialista en salud dental y bucal',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Dolor de cabeza - debe ir a Neurolog√≠a (incluye variantes)
            if (sintomasLower.includes('dolor de cabeza') || sintomasLower.includes('dolor cabeza') || 
                sintomasLower.includes('cefalea') || sintomasLower.includes('migra√±a') || sintomasLower.includes('migrana') ||
                sintomasLower.includes('dolor raro en la cabeza') || sintomasLower.includes('dolor extra√±o en la cabeza') ||
                sintomasLower.includes('dolor leve en la cabeza') || sintomasLower.includes('me pesa la cabeza') ||
                sintomasLower.includes('cabeza pesada') || sintomasLower.includes('dolor de cabeza si no tomo caf√©') ||
                sintomasLower.includes('dolor de cabeza al agacharme') || sintomasLower.includes('dolor de cabeza cuando me agacho') ||
                sintomasLower.includes('dolor de cabeza si no como a tiempo')) {
                return {
                    recommendedSpeciality: 'neurologia',
                    specialityName: 'Neur√≥logo',
                    description: 'Especialista en enfermedades del sistema nervioso y cerebro',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Sensaci√≥n de apagado/sin energ√≠a
            if (sintomasLower.includes('me siento apagado') || sintomasLower.includes('sin energ√≠a') ||
                sintomasLower.includes('como sin energ√≠a') || sintomasLower.includes('me siento medio apagado') ||
                sintomasLower.includes('sin ganas') || sintomasLower.includes('agotado aunque no haya hecho nada') ||
                sintomasLower.includes('me siento agotado sin hacer nada')) {
                if (sintomasLower.includes('sed') || sintomasLower.includes('peso') || sintomasLower.includes('tiroides') ||
                    sintomasLower.includes('hormon') || sintomasLower.includes('calor') || sintomasLower.includes('transpiro')) {
                    return {
                        recommendedSpeciality: 'endocrinologia',
                        specialityName: 'Endocrin√≥logo',
                        description: 'Especialista en hormonas, metabolismo y gl√°ndulas endocrinas',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else if (sintomasLower.includes('triste') || sintomasLower.includes('depresi√≥n') || sintomasLower.includes('ansiedad')) {
                    return {
                        recommendedSpeciality: 'psiquiatria',
                        specialityName: 'Psiquiatra',
                        description: 'Especialista en salud mental y trastornos psiqui√°tricos',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else {
                    return {
                        recommendedSpeciality: 'medicina-general',
                        specialityName: 'M√©dico General',
                        description: 'M√©dico general para atenci√≥n primaria y seguimiento',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Falta de aire a ratos
            if ((sintomasLower.includes('me falta aire') || sintomasLower.includes('falta de aire') ||
                sintomasLower.includes('sensaci√≥n de falta de aire')) &&
                (sintomasLower.includes('a ratos') || sintomasLower.includes('solo a ratos') || sintomasLower.includes('a veces'))) {
                if (sintomasLower.includes('coraz√≥n') || sintomasLower.includes('corazon') || sintomasLower.includes('palpitaciones') ||
                    sintomasLower.includes('pecho')) {
                    return {
                        recommendedSpeciality: 'cardiologia',
                        specialityName: 'Cardi√≥logo',
                        description: 'Especialista en enfermedades del coraz√≥n y sistema cardiovascular',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else {
                    return {
                        recommendedSpeciality: 'neumologia',
                        specialityName: 'Neum√≥logo',
                        description: 'Especialista en enfermedades respiratorias y pulmones',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Ruido en el o√≠do de noche
            if ((sintomasLower.includes('me suena un o√≠do') || sintomasLower.includes('ruido en el o√≠do') ||
                sintomasLower.includes('suena el o√≠do') || sintomasLower.includes('zumbido en el o√≠do')) &&
                (sintomasLower.includes('de noche') || sintomasLower.includes('por la noche'))) {
                return {
                    recommendedSpeciality: 'otorrinolaringologia',
                    specialityName: 'Otorrinolaring√≥logo',
                    description: 'Especialista en o√≠do, nariz y garganta',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Hinchaz√≥n de pies al estar de pie
            if ((sintomasLower.includes('se me hinchan los pies') || sintomasLower.includes('hinchaz√≥n de pies') ||
                sintomasLower.includes('pies hinchados')) &&
                (sintomasLower.includes('cuando estoy de pie') || sintomasLower.includes('mucho rato de pie') ||
                sintomasLower.includes('al estar de pie'))) {
                return {
                    recommendedSpeciality: 'ortopedia',
                    specialityName: 'Ortopedista',
                    description: 'Especialista en huesos, articulaciones y sistema musculoesquel√©tico',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Picaz√≥n en la piel sin sarpullido
            if ((sintomasLower.includes('me pica la piel') || sintomasLower.includes('picaz√≥n en la piel') ||
                sintomasLower.includes('picor en la piel')) &&
                (sintomasLower.includes('sin sarpullido') || sintomasLower.includes('sin erupci√≥n') ||
                sintomasLower.includes('sin ronchas'))) {
                return {
                    recommendedSpeciality: 'dermatologia',
                    specialityName: 'Dermat√≥logo',
                    description: 'Especialista en enfermedades de la piel, pelo y u√±as',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Flojera y dificultad para concentrarse
            if ((sintomasLower.includes('me da flojera') || sintomasLower.includes('todo me da flojera') ||
                sintomasLower.includes('flojera')) &&
                (sintomasLower.includes('me cuesta concentrarme') || sintomasLower.includes('dificultad para concentrarse'))) {
                if (sintomasLower.includes('sed') || sintomasLower.includes('peso') || sintomasLower.includes('tiroides') ||
                    sintomasLower.includes('hormon')) {
                    return {
                        recommendedSpeciality: 'endocrinologia',
                        specialityName: 'Endocrin√≥logo',
                        description: 'Especialista en hormonas, metabolismo y gl√°ndulas endocrinas',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else {
                    return {
                        recommendedSpeciality: 'psiquiatria',
                        specialityName: 'Psiquiatra',
                        description: 'Especialista en salud mental y trastornos psiqui√°tricos',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Ardor en el pecho al comer r√°pido
            if (sintomasLower.includes('me arde el pecho') && 
                (sintomasLower.includes('cuando como r√°pido') || sintomasLower.includes('al comer r√°pido') ||
                sintomasLower.includes('si como r√°pido'))) {
                return {
                    recommendedSpeciality: 'gastroenterologia',
                    specialityName: 'Gastroenter√≥logo',
                    description: 'Especialista en sistema digestivo y enfermedades gastrointestinales',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Cansancio a pesar de dormir
            if (sintomasLower.includes('duermo pero me levanto cansado') || sintomasLower.includes('me levanto igual de cansado') ||
                sintomasLower.includes('duermo pero sigo cansado') || sintomasLower.includes('cansado aunque duerma')) {
                if (sintomasLower.includes('sed') || sintomasLower.includes('peso') || sintomasLower.includes('tiroides') ||
                    sintomasLower.includes('hormon')) {
                    return {
                        recommendedSpeciality: 'endocrinologia',
                        specialityName: 'Endocrin√≥logo',
                        description: 'Especialista en hormonas, metabolismo y gl√°ndulas endocrinas',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else {
                    return {
                        recommendedSpeciality: 'medicina-general',
                        specialityName: 'M√©dico General',
                        description: 'M√©dico general para atenci√≥n primaria y seguimiento',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Molestia leve en la panza todo el tiempo
            if ((sintomasLower.includes('molestia leve en la panza') || sintomasLower.includes('molestia en la panza') ||
                sintomasLower.includes('panza molesta') || sintomasLower.includes('molestia en el abdomen')) &&
                (sintomasLower.includes('todo el tiempo') || sintomasLower.includes('constantemente'))) {
                return {
                    recommendedSpeciality: 'gastroenterologia',
                    specialityName: 'Gastroenter√≥logo',
                    description: 'Especialista en sistema digestivo y enfermedades gastrointestinales',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Temblor en la mano sin raz√≥n
            if ((sintomasLower.includes('me tiembla la mano') || sintomasLower.includes('temblor en la mano') ||
                sintomasLower.includes('mano temblorosa')) &&
                (sintomasLower.includes('sin raz√≥n') || sintomasLower.includes('sin motivo') || sintomasLower.includes('a veces'))) {
                if (sintomasLower.includes('tiroides') || sintomasLower.includes('hormon')) {
                    return {
                        recommendedSpeciality: 'endocrinologia',
                        specialityName: 'Endocrin√≥logo',
                        description: 'Especialista en hormonas, metabolismo y gl√°ndulas endocrinas',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else {
                    return {
                        recommendedSpeciality: 'neurologia',
                        specialityName: 'Neur√≥logo',
                        description: 'Especialista en enfermedades del sistema nervioso y cerebro',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Calor y transpiraci√≥n sin motivo
            if ((sintomasLower.includes('siento calor') || sintomasLower.includes('transpiro') || sintomasLower.includes('sudo')) &&
                (sintomasLower.includes('sin motivo') || sintomasLower.includes('sin raz√≥n') || sintomasLower.includes('sin hacer nada'))) {
                return {
                    recommendedSpeciality: 'endocrinologia',
                    specialityName: 'Endocrin√≥logo',
                    description: 'Especialista en hormonas, metabolismo y gl√°ndulas endocrinas',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Dolor de espalda baja al agacharse
            if (sintomasLower.includes('me duele la espalda baja') &&
                (sintomasLower.includes('al agacharme') || sintomasLower.includes('cuando me agacho') ||
                sintomasLower.includes('al agacharse'))) {
                return {
                    recommendedSpeciality: 'ortopedia',
                    specialityName: 'Ortopedista',
                    description: 'Especialista en huesos, articulaciones y sistema musculoesquel√©tico',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Vista nublada por segundos
            if ((sintomasLower.includes('se me nubla la vista') || sintomasLower.includes('vista nublada') ||
                sintomasLower.includes('visi√≥n nublada')) &&
                (sintomasLower.includes('por unos segundos') || sintomasLower.includes('por segundos') ||
                sintomasLower.includes('moment√°neamente'))) {
                if (sintomasLower.includes('dolor de cabeza') || sintomasLower.includes('mareo')) {
                    return {
                        recommendedSpeciality: 'neurologia',
                        specialityName: 'Neur√≥logo',
                        description: 'Especialista en enfermedades del sistema nervioso y cerebro',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else {
                    return {
                        recommendedSpeciality: 'oftalmologia',
                        specialityName: 'Oftalm√≥logo',
                        description: 'Especialista en enfermedades de los ojos y visi√≥n',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Tos persistente/constante (PRIORIDAD M√ÅXIMA - debe evaluarse antes que otras detecciones)
            if (sintomasLower.includes('tos') &&
                (sintomasLower.includes('no se va') || sintomasLower.includes('que no se va') ||
                sintomasLower.includes('no mejora') || sintomasLower.includes('que no mejora') ||
                sintomasLower.includes('persistente') || sintomasLower.includes('constante') ||
                sintomasLower.includes('desde hace') || sintomasLower.includes('hace tiempo') ||
                sintomasLower.includes('hace d√≠as') || sintomasLower.includes('hace semanas') ||
                sintomasLower.includes('hace 1 semana') || sintomasLower.includes('hace una semana') ||
                sintomasLower.includes('cr√≥nica') || sintomasLower.includes('cronica') ||
                sintomasLower.includes('sin fiebre') || sintomasLower.includes('desde hace rato'))) {
                return {
                    recommendedSpeciality: 'neumologia',
                    specialityName: 'Neum√≥logo',
                    description: 'Especialista en enfermedades respiratorias y pulmones',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Punzada en el pecho r√°pida
            if ((sintomasLower.includes('punzada en el pecho') || sintomasLower.includes('dolor punzante en el pecho')) &&
                (sintomasLower.includes('pasa r√°pido') || sintomasLower.includes('r√°pida') || sintomasLower.includes('breve'))) {
                return {
                    recommendedSpeciality: 'cardiologia',
                    specialityName: 'Cardi√≥logo',
                    description: 'Especialista en enfermedades del coraz√≥n y sistema cardiovascular',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Garganta rara con sensaci√≥n de atrapado
            if ((sintomasLower.includes('garganta rara') || sintomasLower.includes('garganta extra√±a') ||
                sintomasLower.includes('sensaci√≥n en la garganta')) &&
                (sintomasLower.includes('como con algo atorado') || sintomasLower.includes('algo atorado') ||
                sintomasLower.includes('nudo en la garganta'))) {
                return {
                    recommendedSpeciality: 'otorrinolaringologia',
                    specialityName: 'Otorrinolaring√≥logo',
                    description: 'Especialista en o√≠do, nariz y garganta',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Dolor en las piernas al caminar
            if (sintomasLower.includes('me duelen las piernas') &&
                (sintomasLower.includes('cuando camino mucho') || sintomasLower.includes('al caminar') ||
                sintomasLower.includes('al caminar mucho'))) {
                return {
                    recommendedSpeciality: 'ortopedia',
                    specialityName: 'Ortopedista',
                    description: 'Especialista en huesos, articulaciones y sistema musculoesquel√©tico',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Est√≥mago revuelto
            if (sintomasLower.includes('est√≥mago revuelto') || sintomasLower.includes('estomago revuelto') ||
                sintomasLower.includes('tengo el est√≥mago revuelto') || sintomasLower.includes('est√≥mago alterado')) {
                return {
                    recommendedSpeciality: 'gastroenterologia',
                    specialityName: 'Gastroenter√≥logo',
                    description: 'Especialista en sistema digestivo y enfermedades gastrointestinales',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Nervioso sin motivo
            if (sintomasLower.includes('me siento nervioso') || sintomasLower.includes('nervioso') ||
                sintomasLower.includes('nervios')) {
                if (sintomasLower.includes('sin motivo') || sintomasLower.includes('sin raz√≥n') || sintomasLower.includes('a veces')) {
                    return {
                        recommendedSpeciality: 'psiquiatria',
                        specialityName: 'Psiquiatra',
                        description: 'Especialista en salud mental y trastornos psiqui√°tricos',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Dificultad para respirar al subir escaleras
            if (sintomasLower.includes('me cuesta respirar') &&
                (sintomasLower.includes('al subir escaleras') || sintomasLower.includes('cuando subo escaleras') ||
                sintomasLower.includes('al subir'))) {
                if (sintomasLower.includes('coraz√≥n') || sintomasLower.includes('corazon') || sintomasLower.includes('palpitaciones')) {
                    return {
                        recommendedSpeciality: 'cardiologia',
                        specialityName: 'Cardi√≥logo',
                        description: 'Especialista en enfermedades del coraz√≥n y sistema cardiovascular',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else {
                    return {
                        recommendedSpeciality: 'neumologia',
                        specialityName: 'Neum√≥logo',
                        description: 'Especialista en enfermedades respiratorias y pulmones',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Picaz√≥n en ojos al aire libre
            if (sintomasLower.includes('me pican los ojos') &&
                (sintomasLower.includes('al aire libre') || sintomasLower.includes('cuando estoy al aire libre') ||
                sintomasLower.includes('cuando salgo'))) {
                return {
                    recommendedSpeciality: 'oftalmologia',
                    specialityName: 'Oftalm√≥logo',
                    description: 'Especialista en enfermedades de los ojos y visi√≥n',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Tensi√≥n en el cuello
            if ((sintomasLower.includes('molestia en el cuello') || sintomasLower.includes('tensi√≥n en el cuello') ||
                sintomasLower.includes('cuello tenso') || sintomasLower.includes('como tensi√≥n')) &&
                sintomasLower.includes('leve')) {
                return {
                    recommendedSpeciality: 'ortopedia',
                    specialityName: 'Ortopedista',
                    description: 'Especialista en huesos, articulaciones y sistema musculoesquel√©tico',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Mareos sin p√©rdida de equilibrio
            if ((sintomasLower.includes('me siento mareado') || sintomasLower.includes('mareo') ||
                sintomasLower.includes('mareos')) &&
                (sintomasLower.includes('pero no llego a perder el equilibrio') || sintomasLower.includes('sin perder equilibrio') ||
                sintomasLower.includes('leve'))) {
                return {
                    recommendedSpeciality: 'neurologia',
                    specialityName: 'Neur√≥logo',
                    description: 'Especialista en enfermedades del sistema nervioso y cerebro',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Dedos dormidos de las manos
            if (sintomasLower.includes('se me duermen los dedos') || sintomasLower.includes('dedos dormidos') ||
                sintomasLower.includes('dedos de las manos dormidos') || sintomasLower.includes('dedos entumecidos')) {
                if (sintomasLower.includes('dolor') || sintomasLower.includes('rigidez')) {
                    return {
                        recommendedSpeciality: 'reumatologia',
                        specialityName: 'Reumat√≥logo',
                        description: 'Especialista en enfermedades autoinmunes y articulaciones',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else {
                    return {
                        recommendedSpeciality: 'neurologia',
                        specialityName: 'Neur√≥logo',
                        description: 'Especialista en enfermedades del sistema nervioso y cerebro',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Dificultad para levantarse por las ma√±anas
            if ((sintomasLower.includes('me cuesta levantarme') || sintomasLower.includes('dificultad para levantarme') ||
                sintomasLower.includes('me cuesta mucho levantarme')) &&
                (sintomasLower.includes('por las ma√±anas') || sintomasLower.includes('en las ma√±anas'))) {
                if (sintomasLower.includes('sed') || sintomasLower.includes('peso') || sintomasLower.includes('tiroides') ||
                    sintomasLower.includes('hormon')) {
                    return {
                        recommendedSpeciality: 'endocrinologia',
                        specialityName: 'Endocrin√≥logo',
                        description: 'Especialista en hormonas, metabolismo y gl√°ndulas endocrinas',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else {
                    return {
                        recommendedSpeciality: 'psiquiatria',
                        specialityName: 'Psiquiatra',
                        description: 'Especialista en salud mental y trastornos psiqui√°tricos',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Piel m√°s seca de lo normal
            if ((sintomasLower.includes('piel m√°s seca') || sintomasLower.includes('piel seca') ||
                sintomasLower.includes('piel muy seca')) &&
                (sintomasLower.includes('de lo normal') || sintomasLower.includes('m√°s de lo normal'))) {
                return {
                    recommendedSpeciality: 'dermatologia',
                    specialityName: 'Dermat√≥logo',
                    description: 'Especialista en enfermedades de la piel, pelo y u√±as',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Agitaci√≥n sin esfuerzo
            if ((sintomasLower.includes('me siento agitado') || sintomasLower.includes('agitado') ||
                sintomasLower.includes('agitaci√≥n')) &&
                (sintomasLower.includes('aunque no haya hecho nada') || sintomasLower.includes('sin hacer nada') ||
                sintomasLower.includes('sin motivo'))) {
                if (sintomasLower.includes('coraz√≥n') || sintomasLower.includes('corazon') || sintomasLower.includes('palpitaciones')) {
                    return {
                        recommendedSpeciality: 'cardiologia',
                        specialityName: 'Cardi√≥logo',
                        description: 'Especialista en enfermedades del coraz√≥n y sistema cardiovascular',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else {
                    return {
                        recommendedSpeciality: 'psiquiatria',
                        specialityName: 'Psiquiatra',
                        description: 'Especialista en salud mental y trastornos psiqui√°tricos',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Nudo en la panza sin enfermedad
            if ((sintomasLower.includes('nudo en la panza') || sintomasLower.includes('nudo en el est√≥mago') ||
                sintomasLower.includes('sensaci√≥n de nudo')) &&
                (sintomasLower.includes('sin estar enfermo') || sintomasLower.includes('sin enfermedad'))) {
                return {
                    recommendedSpeciality: 'gastroenterologia',
                    specialityName: 'Gastroenter√≥logo',
                    description: 'Especialista en sistema digestivo y enfermedades gastrointestinales',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Dolor muscular como si hubiera hecho ejercicio
            if ((sintomasLower.includes('me duelen los m√∫sculos') || sintomasLower.includes('dolor muscular')) &&
                (sintomasLower.includes('como si hubiera hecho ejercicio') || sintomasLower.includes('como despu√©s de ejercicio'))) {
                return {
                    recommendedSpeciality: 'reumatologia',
                    specialityName: 'Reumat√≥logo',
                    description: 'Especialista en enfermedades autoinmunes y articulaciones',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Dificultad para respirar por la nariz
            if ((sintomasLower.includes('me cuesta respirar por la nariz') || sintomasLower.includes('dificultad para respirar por la nariz') ||
                sintomasLower.includes('no puedo respirar por la nariz')) &&
                sintomasLower.includes('desde hace tiempo')) {
                return {
                    recommendedSpeciality: 'otorrinolaringologia',
                    specialityName: 'Otorrinolaring√≥logo',
                    description: 'Especialista en o√≠do, nariz y garganta',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Latido en el ojo
            if (sintomasLower.includes('me late el ojo') || sintomasLower.includes('latido en el ojo') ||
                sintomasLower.includes('ojo que late') || sintomasLower.includes('sensaci√≥n de latido en el ojo')) {
                return {
                    recommendedSpeciality: 'neurologia',
                    specialityName: 'Neur√≥logo',
                    description: 'Especialista en enfermedades del sistema nervioso y cerebro',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Cuello tieso al despertar
            if (sintomasLower.includes('me levanto con el cuello tieso') || sintomasLower.includes('cuello tieso al despertar') ||
                sintomasLower.includes('cuello r√≠gido al despertar')) {
                return {
                    recommendedSpeciality: 'ortopedia',
                    specialityName: 'Ortopedista',
                    description: 'Especialista en huesos, articulaciones y sistema musculoesquel√©tico',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Ardor en la boca sin raz√≥n
            if (sintomasLower.includes('me arde la boca') || sintomasLower.includes('ardor en la boca') ||
                sintomasLower.includes('boca que arde')) {
                if (sintomasLower.includes('sin raz√≥n') || sintomasLower.includes('sin motivo')) {
                    return {
                        recommendedSpeciality: 'odontologia',
                        specialityName: 'Odont√≥logo',
                        description: 'Especialista en salud dental y bucal',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Pies fr√≠os constantemente
            if ((sintomasLower.includes('pies fr√≠os') || sintomasLower.includes('tengo los pies fr√≠os')) &&
                (sintomasLower.includes('casi todo el tiempo') || sintomasLower.includes('constantemente') ||
                sintomasLower.includes('siempre'))) {
                if (sintomasLower.includes('tiroides') || sintomasLower.includes('hormon')) {
                    return {
                        recommendedSpeciality: 'endocrinologia',
                        specialityName: 'Endocrin√≥logo',
                        description: 'Especialista en hormonas, metabolismo y gl√°ndulas endocrinas',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else {
                    return {
                        recommendedSpeciality: 'reumatologia',
                        specialityName: 'Reumat√≥logo',
                        description: 'Especialista en enfermedades autoinmunes y articulaciones',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Dificultad para respirar acostado boca arriba
            if (sintomasLower.includes('me cuesta respirar') &&
                (sintomasLower.includes('cuando estoy acostado boca arriba') || sintomasLower.includes('acostado boca arriba') ||
                sintomasLower.includes('boca arriba'))) {
                if (sintomasLower.includes('coraz√≥n') || sintomasLower.includes('corazon') || sintomasLower.includes('palpitaciones')) {
                    return {
                        recommendedSpeciality: 'cardiologia',
                        specialityName: 'Cardi√≥logo',
                        description: 'Especialista en enfermedades del coraz√≥n y sistema cardiovascular',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else {
                    return {
                        recommendedSpeciality: 'neumologia',
                        specialityName: 'Neum√≥logo',
                        description: 'Especialista en enfermedades respiratorias y pulmones',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Sensaci√≥n de lleno de aire despu√©s de comer
            if ((sintomasLower.includes('me siento lleno de aire') || sintomasLower.includes('lleno de aire') ||
                sintomasLower.includes('como lleno de aire')) &&
                (sintomasLower.includes('despu√©s de comer') || sintomasLower.includes('tras comer'))) {
                return {
                    recommendedSpeciality: 'gastroenterologia',
                    specialityName: 'Gastroenter√≥logo',
                    description: 'Especialista en sistema digestivo y enfermedades gastrointestinales',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Vista borrosa moment√°nea
            if ((sintomasLower.includes('vista borrosa') || sintomasLower.includes('visi√≥n borrosa')) &&
                (sintomasLower.includes('un segundo') || sintomasLower.includes('por un segundo') ||
                sintomasLower.includes('moment√°neamente') || sintomasLower.includes('y se me pasa'))) {
                return {
                    recommendedSpeciality: 'oftalmologia',
                    specialityName: 'Oftalm√≥logo',
                    description: 'Especialista en enfermedades de los ojos y visi√≥n',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Dolor en la mand√≠bula al masticar
            if (sintomasLower.includes('me duele la mand√≠bula') &&
                (sintomasLower.includes('al masticar') || sintomasLower.includes('cuando mastico'))) {
                return {
                    recommendedSpeciality: 'odontologia',
                    specialityName: 'Odont√≥logo',
                    description: 'Especialista en salud dental y bucal',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Manos h√∫medas constantemente
            if ((sintomasLower.includes('manos h√∫medas') || sintomasLower.includes('manos sudorosas') ||
                sintomasLower.includes('manos mojadas')) &&
                (sintomasLower.includes('todo el tiempo') || sintomasLower.includes('constantemente'))) {
                if (sintomasLower.includes('tiroides') || sintomasLower.includes('hormon')) {
                    return {
                        recommendedSpeciality: 'endocrinologia',
                        specialityName: 'Endocrin√≥logo',
                        description: 'Especialista en hormonas, metabolismo y gl√°ndulas endocrinas',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else {
                    return {
                        recommendedSpeciality: 'psiquiatria',
                        specialityName: 'Psiquiatra',
                        description: 'Especialista en salud mental y trastornos psiqui√°tricos',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Picaz√≥n en brazos sin visible
            if ((sintomasLower.includes('me pican los brazos') || sintomasLower.includes('picaz√≥n en los brazos')) &&
                (sintomasLower.includes('sin que se vea nada') || sintomasLower.includes('sin sarpullido') ||
                sintomasLower.includes('sin erupci√≥n'))) {
                return {
                    recommendedSpeciality: 'dermatologia',
                    specialityName: 'Dermat√≥logo',
                    description: 'Especialista en enfermedades de la piel, pelo y u√±as',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Est√≥mago sensible a alimentos
            if ((sintomasLower.includes('est√≥mago sensible') || sintomasLower.includes('estomago sensible')) &&
                (sintomasLower.includes('a ciertos alimentos') || sintomasLower.includes('a algunos alimentos') ||
                sintomasLower.includes('a ciertos comidas'))) {
                return {
                    recommendedSpeciality: 'gastroenterologia',
                    specialityName: 'Gastroenter√≥logo',
                    description: 'Especialista en sistema digestivo y enfermedades gastrointestinales',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Dificultad para respirar con calor o humedad
            if (sintomasLower.includes('me cuesta respirar') &&
                (sintomasLower.includes('cuando hace calor') || sintomasLower.includes('con calor') ||
                sintomasLower.includes('cuando hay humedad') || sintomasLower.includes('con humedad'))) {
                return {
                    recommendedSpeciality: 'neumologia',
                    specialityName: 'Neum√≥logo',
                    description: 'Especialista en enfermedades respiratorias y pulmones',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Garganta irritada al despertar
            if (sintomasLower.includes('garganta irritada') || sintomasLower.includes('me levanto con la garganta irritada') ||
                sintomasLower.includes('garganta irritada al despertar')) {
                return {
                    recommendedSpeciality: 'otorrinolaringologia',
                    specialityName: 'Otorrinolaring√≥logo',
                    description: 'Especialista en o√≠do, nariz y garganta',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Presi√≥n leve en el pecho
            if ((sintomasLower.includes('presi√≥n en el pecho') || sintomasLower.includes('presi√≥n leve en el pecho') ||
                sintomasLower.includes('sensaci√≥n de presi√≥n en el pecho')) &&
                (sintomasLower.includes('a veces') || sintomasLower.includes('a ratos'))) {
                return {
                    recommendedSpeciality: 'cardiologia',
                    specialityName: 'Cardi√≥logo',
                    description: 'Especialista en enfermedades del coraz√≥n y sistema cardiovascular',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Cuerpo pesado y dificultad para moverse
            if ((sintomasLower.includes('cuerpo pesado') || sintomasLower.includes('me siento pesado')) &&
                (sintomasLower.includes('me cuesta moverme') || sintomasLower.includes('dificultad para moverme'))) {
                if (sintomasLower.includes('sed') || sintomasLower.includes('peso') || sintomasLower.includes('tiroides')) {
                    return {
                        recommendedSpeciality: 'endocrinologia',
                        specialityName: 'Endocrin√≥logo',
                        description: 'Especialista en hormonas, metabolismo y gl√°ndulas endocrinas',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else {
                    return {
                        recommendedSpeciality: 'medicina-general',
                        specialityName: 'M√©dico General',
                        description: 'M√©dico general para atenci√≥n primaria y seguimiento',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Dolor de rodilla con cambios de clima
            if (sintomasLower.includes('me duele una rodilla') &&
                (sintomasLower.includes('cuando cambia el clima') || sintomasLower.includes('con cambios de clima') ||
                sintomasLower.includes('cuando cambia el tiempo'))) {
                return {
                    recommendedSpeciality: 'reumatologia',
                    specialityName: 'Reumat√≥logo',
                    description: 'Especialista en enfermedades autoinmunes y articulaciones',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Agitaci√≥n r√°pida con esfuerzo m√≠nimo
            if ((sintomasLower.includes('me agito r√°pido') || sintomasLower.includes('agitaci√≥n r√°pida')) &&
                (sintomasLower.includes('al hacer algo m√≠nimo') || sintomasLower.includes('con poco esfuerzo') ||
                sintomasLower.includes('con esfuerzo m√≠nimo'))) {
                if (sintomasLower.includes('coraz√≥n') || sintomasLower.includes('corazon') || sintomasLower.includes('palpitaciones')) {
                    return {
                        recommendedSpeciality: 'cardiologia',
                        specialityName: 'Cardi√≥logo',
                        description: 'Especialista en enfermedades del coraz√≥n y sistema cardiovascular',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else {
                    return {
                        recommendedSpeciality: 'neumologia',
                        specialityName: 'Neum√≥logo',
                        description: 'Especialista en enfermedades respiratorias y pulmones',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Picaz√≥n en el cuero cabelludo sin caspa
            if ((sintomasLower.includes('picaz√≥n en el cuero cabelludo') || sintomasLower.includes('me pica el cuero cabelludo') ||
                sintomasLower.includes('picor en la cabeza')) &&
                (sintomasLower.includes('sin caspa') || sintomasLower.includes('sin tener caspa'))) {
                return {
                    recommendedSpeciality: 'dermatologia',
                    specialityName: 'Dermat√≥logo',
                    description: 'Especialista en enfermedades de la piel, pelo y u√±as',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Dificultad para tragar con sensaci√≥n de trabado
            if ((sintomasLower.includes('me cuesta tragar') || sintomasLower.includes('dificultad para tragar')) &&
                (sintomasLower.includes('como si se trabara algo') || sintomasLower.includes('se trabara') ||
                sintomasLower.includes('sensaci√≥n de trabado'))) {
                return {
                    recommendedSpeciality: 'otorrinolaringologia',
                    specialityName: 'Otorrinolaring√≥logo',
                    description: 'Especialista en o√≠do, nariz y garganta',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Mareos al girar r√°pido
            if ((sintomasLower.includes('me dan mareos') || sintomasLower.includes('mareos')) &&
                (sintomasLower.includes('cuando giro r√°pido') || sintomasLower.includes('al girar r√°pido') ||
                sintomasLower.includes('al girar'))) {
                return {
                    recommendedSpeciality: 'otorrinolaringologia',
                    specialityName: 'Otorrinolaring√≥logo',
                    description: 'Especialista en o√≠do, nariz y garganta',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Sue√±o despu√©s de comer
            if ((sintomasLower.includes('me da sue√±o despu√©s de comer') || sintomasLower.includes('sue√±o despu√©s de comer') ||
                sintomasLower.includes('somnolencia despu√©s de comer')) &&
                sintomasLower.includes('aunque no haya comido mucho')) {
                return {
                    recommendedSpeciality: 'endocrinologia',
                    specialityName: 'Endocrin√≥logo',
                    description: 'Especialista en hormonas, metabolismo y gl√°ndulas endocrinas',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Tensi√≥n constante
            if ((sintomasLower.includes('me siento tenso') || sintomasLower.includes('tensi√≥n') ||
                sintomasLower.includes('tenso')) &&
                (sintomasLower.includes('todo el tiempo') || sintomasLower.includes('constantemente') ||
                sintomasLower.includes('como si no pudiera aflojar'))) {
                return {
                    recommendedSpeciality: 'psiquiatria',
                    specialityName: 'Psiquiatra',
                    description: 'Especialista en salud mental y trastornos psiqui√°tricos',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Pinchazos en el pecho
            if ((sintomasLower.includes('pinchazos en el pecho') || sintomasLower.includes('como pinchazos')) &&
                (sintomasLower.includes('a veces') || sintomasLower.includes('a ratos'))) {
                return {
                    recommendedSpeciality: 'cardiologia',
                    specialityName: 'Cardi√≥logo',
                    description: 'Especialista en enfermedades del coraz√≥n y sistema cardiovascular',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Dificultad para concentrarse en la lectura
            if ((sintomasLower.includes('me cuesta concentrarme') || sintomasLower.includes('dificultad para concentrarse')) &&
                (sintomasLower.includes('en lo que leo') || sintomasLower.includes('al leer') ||
                sintomasLower.includes('en la lectura'))) {
                return {
                    recommendedSpeciality: 'psiquiatria',
                    specialityName: 'Psiquiatra',
                    description: 'Especialista en salud mental y trastornos psiqui√°tricos',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Sed aumentada
            if (sintomasLower.includes('m√°s sed de lo normal') || sintomasLower.includes('tengo m√°s sed') ||
                sintomasLower.includes('sed aumentada') || sintomasLower.includes('sed excesiva')) {
                return {
                    recommendedSpeciality: 'endocrinologia',
                    specialityName: 'Endocrin√≥logo',
                    description: 'Especialista en hormonas, metabolismo y gl√°ndulas endocrinas',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Dolor en brazos al dormir de un lado
            if (sintomasLower.includes('me duelen los brazos') &&
                (sintomasLower.includes('cuando duermo de un lado') || sintomasLower.includes('al dormir de un lado') ||
                sintomasLower.includes('dormir de un lado'))) {
                return {
                    recommendedSpeciality: 'ortopedia',
                    specialityName: 'Ortopedista',
                    description: 'Especialista en huesos, articulaciones y sistema musculoesquel√©tico',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Est√≥mago sensible e hinchaz√≥n f√°cil
            if ((sintomasLower.includes('est√≥mago sensible') || sintomasLower.includes('estomago sensible')) &&
                (sintomasLower.includes('me hincho f√°cil') || sintomasLower.includes('hinchaz√≥n f√°cil') ||
                sintomasLower.includes('se me hincha f√°cil'))) {
                return {
                    recommendedSpeciality: 'gastroenterologia',
                    specialityName: 'Gastroenter√≥logo',
                    description: 'Especialista en sistema digestivo y enfermedades gastrointestinales',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Dificultad para respirar cuando est√° nervioso
            if (sintomasLower.includes('me cuesta respirar') &&
                (sintomasLower.includes('cuando estoy nervioso') || sintomasLower.includes('al estar nervioso') ||
                sintomasLower.includes('si estoy nervioso'))) {
                return {
                    recommendedSpeciality: 'psiquiatria',
                    specialityName: 'Psiquiatra',
                    description: 'Especialista en salud mental y trastornos psiqui√°tricos',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Sangrado nasal al despertar
            if (sintomasLower.includes('me despierto con la nariz sangrando') || sintomasLower.includes('nariz sangrando al despertar') ||
                sintomasLower.includes('sangrado nasal al despertar')) {
                return {
                    recommendedSpeciality: 'otorrinolaringologia',
                    specialityName: 'Otorrinolaring√≥logo',
                    description: 'Especialista en o√≠do, nariz y garganta',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Molestia en parte baja del abdomen
            if ((sintomasLower.includes('molestia en la parte baja del abdomen') || sintomasLower.includes('molestia parte baja abdomen') ||
                sintomasLower.includes('dolor parte baja abdomen')) &&
                sintomasLower.includes('leve')) {
                if (genero === 'femenino') {
                    return {
                        recommendedSpeciality: 'ginecologia',
                        specialityName: 'Ginec√≥logo',
                        description: 'Especialista en salud reproductiva femenina',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else if (genero === 'masculino') {
                    return {
                        recommendedSpeciality: 'urologia',
                        specialityName: 'Ur√≥logo',
                        description: 'Especialista en sistema urinario y genital masculino',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else {
                    return {
                        recommendedSpeciality: 'gastroenterologia',
                        specialityName: 'Gastroenter√≥logo',
                        description: 'Especialista en sistema digestivo y enfermedades gastrointestinales',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Dificultad para mantener equilibrio con ojos cerrados
            if (sintomasLower.includes('me cuesta mantener el equilibrio') &&
                (sintomasLower.includes('si cierro los ojos') || sintomasLower.includes('con los ojos cerrados') ||
                sintomasLower.includes('al cerrar los ojos'))) {
                return {
                    recommendedSpeciality: 'neurologia',
                    specialityName: 'Neur√≥logo',
                    description: 'Especialista en enfermedades del sistema nervioso y cerebro',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Dolor en dedos con fr√≠o
            if (sintomasLower.includes('me duelen los dedos') &&
                (sintomasLower.includes('cuando hace fr√≠o') || sintomasLower.includes('con el fr√≠o') ||
                sintomasLower.includes('si hace fr√≠o'))) {
                return {
                    recommendedSpeciality: 'reumatologia',
                    specialityName: 'Reumat√≥logo',
                    description: 'Especialista en enfermedades autoinmunes y articulaciones',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Latidos fuertes del coraz√≥n en reposo
            if ((sintomasLower.includes('me late fuerte el coraz√≥n') || sintomasLower.includes('latidos fuertes') ||
                sintomasLower.includes('coraz√≥n late fuerte')) &&
                (sintomasLower.includes('cuando estoy tranquilo') || sintomasLower.includes('en reposo') ||
                sintomasLower.includes('sin hacer nada'))) {
                return {
                    recommendedSpeciality: 'cardiologia',
                    specialityName: 'Cardi√≥logo',
                    description: 'Especialista en enfermedades del coraz√≥n y sistema cardiovascular',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Zumbido en la cabeza persistente
            if ((sintomasLower.includes('zumbido en la cabeza') || sintomasLower.includes('ruido en la cabeza')) &&
                (sintomasLower.includes('que no se va') || sintomasLower.includes('persistente') ||
                sintomasLower.includes('constante'))) {
                return {
                    recommendedSpeciality: 'neurologia',
                    specialityName: 'Neur√≥logo',
                    description: 'Especialista en enfermedades del sistema nervioso y cerebro',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Acidez aunque coma poco
            if (sintomasLower.includes('me da acidez') &&
                (sintomasLower.includes('aunque coma poco') || sintomasLower.includes('comiendo poco') ||
                sintomasLower.includes('aunque no coma mucho'))) {
                return {
                    recommendedSpeciality: 'gastroenterologia',
                    specialityName: 'Gastroenter√≥logo',
                    description: 'Especialista en sistema digestivo y enfermedades gastrointestinales',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Dolor en piernas al estar sentado
            if (sintomasLower.includes('me duelen las piernas') &&
                (sintomasLower.includes('si estoy mucho tiempo sentado') || sintomasLower.includes('al estar sentado') ||
                sintomasLower.includes('cuando estoy sentado'))) {
                return {
                    recommendedSpeciality: 'ortopedia',
                    specialityName: 'Ortopedista',
                    description: 'Especialista en huesos, articulaciones y sistema musculoesquel√©tico',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Ardor en el est√≥mago a ratos
            if ((sintomasLower.includes('me arde el est√≥mago') || sintomasLower.includes('ardor en el est√≥mago')) &&
                (sintomasLower.includes('a veces') || sintomasLower.includes('a ratos'))) {
                return {
                    recommendedSpeciality: 'gastroenterologia',
                    specialityName: 'Gastroenter√≥logo',
                    description: 'Especialista en sistema digestivo y enfermedades gastrointestinales',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Dificultad para respirar por la noche
            if (sintomasLower.includes('me cuesta respirar por la noche') || sintomasLower.includes('dificultad para respirar por la noche') ||
                sintomasLower.includes('respirar por la noche')) {
                return {
                    recommendedSpeciality: 'neumologia',
                    specialityName: 'Neum√≥logo',
                    description: 'Especialista en enfermedades respiratorias y pulmones',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Irritabilidad
            if ((sintomasLower.includes('muy irritable') || sintomasLower.includes('irritabilidad') ||
                sintomasLower.includes('me siento irritable')) &&
                (sintomasLower.includes('√∫ltimamente') || sintomasLower.includes('recientemente'))) {
                return {
                    recommendedSpeciality: 'psiquiatria',
                    specialityName: 'Psiquiatra',
                    description: 'Especialista en salud mental y trastornos psiqui√°tricos',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Manos dormidas al despertar
            if ((sintomasLower.includes('manos dormidas') || sintomasLower.includes('manos entumecidas')) &&
                (sintomasLower.includes('cuando me despierto') || sintomasLower.includes('al despertar') ||
                sintomasLower.includes('al despertarme'))) {
                if (sintomasLower.includes('dolor') || sintomasLower.includes('rigidez')) {
                    return {
                        recommendedSpeciality: 'reumatologia',
                        specialityName: 'Reumat√≥logo',
                        description: 'Especialista en enfermedades autoinmunes y articulaciones',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else {
                    return {
                        recommendedSpeciality: 'neurologia',
                        specialityName: 'Neur√≥logo',
                        description: 'Especialista en enfermedades del sistema nervioso y cerebro',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Dolor en el cuello despu√©s de trabajar
            if (sintomasLower.includes('me duele el cuello') &&
                (sintomasLower.includes('despu√©s de trabajar') || sintomasLower.includes('al trabajar') ||
                sintomasLower.includes('despu√©s de trabajar muchas horas'))) {
                return {
                    recommendedSpeciality: 'ortopedia',
                    specialityName: 'Ortopedista',
                    description: 'Especialista en huesos, articulaciones y sistema musculoesquel√©tico',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Dolor detr√°s de los ojos
            if (sintomasLower.includes('dolor detr√°s de los ojos') || sintomasLower.includes('dolor leve detr√°s de los ojos')) {
                return {
                    recommendedSpeciality: 'oftalmologia',
                    specialityName: 'Oftalm√≥logo',
                    description: 'Especialista en enfermedades de los ojos y visi√≥n',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Presi√≥n en la sien
            if ((sintomasLower.includes('presi√≥n en la sien') || sintomasLower.includes('presi√≥n leve en la sien')) &&
                (sintomasLower.includes('a veces') || sintomasLower.includes('a ratos'))) {
                return {
                    recommendedSpeciality: 'neurologia',
                    specialityName: 'Neur√≥logo',
                    description: 'Especialista en enfermedades del sistema nervioso y cerebro',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Dificultad para respirar con fr√≠o
            if (sintomasLower.includes('me cuesta respirar') &&
                (sintomasLower.includes('cuando hace fr√≠o') || sintomasLower.includes('con el fr√≠o') ||
                sintomasLower.includes('si hace fr√≠o'))) {
                return {
                    recommendedSpeciality: 'neumologia',
                    specialityName: 'Neum√≥logo',
                    description: 'Especialista en enfermedades respiratorias y pulmones',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Molestia estomacal con comida pesada
            if (sintomasLower.includes('me molesta el est√≥mago') &&
                (sintomasLower.includes('si como algo pesado') || sintomasLower.includes('con comida pesada') ||
                sintomasLower.includes('al comer pesado'))) {
                return {
                    recommendedSpeciality: 'gastroenterologia',
                    specialityName: 'Gastroenter√≥logo',
                    description: 'Especialista en sistema digestivo y enfermedades gastrointestinales',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Ardor en la piel con el sol
            if (sintomasLower.includes('me arde la piel') &&
                (sintomasLower.includes('cuando me da el sol') || sintomasLower.includes('con el sol') ||
                sintomasLower.includes('al sol'))) {
                return {
                    recommendedSpeciality: 'dermatologia',
                    specialityName: 'Dermat√≥logo',
                    description: 'Especialista en enfermedades de la piel, pelo y u√±as',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Dolor muscular sin ejercicio
            if ((sintomasLower.includes('me duelen los m√∫sculos') || sintomasLower.includes('dolor muscular')) &&
                (sintomasLower.includes('aunque no haya hecho ejercicio') || sintomasLower.includes('sin hacer ejercicio') ||
                sintomasLower.includes('sin ejercicio'))) {
                return {
                    recommendedSpeciality: 'reumatologia',
                    specialityName: 'Reumat√≥logo',
                    description: 'Especialista en enfermedades autoinmunes y articulaciones',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Piernas entumecidas al despertar
            if ((sintomasLower.includes('piernas entumecidas') || sintomasLower.includes('piernas dormidas')) &&
                (sintomasLower.includes('al despertar') || sintomasLower.includes('cuando me despierto') ||
                sintomasLower.includes('al despertarme'))) {
                return {
                    recommendedSpeciality: 'neurologia',
                    specialityName: 'Neur√≥logo',
                    description: 'Especialista en enfermedades del sistema nervioso y cerebro',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Dificultad para tragar saliva
            if ((sintomasLower.includes('me cuesta tragar saliva') || sintomasLower.includes('dificultad para tragar saliva') ||
                sintomasLower.includes('tragar saliva')) &&
                sintomasLower.includes('a veces')) {
                return {
                    recommendedSpeciality: 'otorrinolaringologia',
                    specialityName: 'Otorrinolaring√≥logo',
                    description: 'Especialista en o√≠do, nariz y garganta',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Sensaci√≥n de fiebre sin fiebre
            if ((sintomasLower.includes('sensaci√≥n de fiebre') || sintomasLower.includes('como si tuviera fiebre')) &&
                (sintomasLower.includes('pero no tengo') || sintomasLower.includes('sin tener fiebre') ||
                sintomasLower.includes('sin fiebre'))) {
                return {
                    recommendedSpeciality: 'medicina-general',
                    specialityName: 'M√©dico General',
                    description: 'M√©dico general para atenci√≥n primaria y seguimiento',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Picaz√≥n en la nariz frecuente
            if ((sintomasLower.includes('me pica la nariz') || sintomasLower.includes('picaz√≥n en la nariz') ||
                sintomasLower.includes('picor en la nariz')) &&
                (sintomasLower.includes('muy seguido') || sintomasLower.includes('frecuentemente'))) {
                return {
                    recommendedSpeciality: 'medicina-general',
                    specialityName: 'M√©dico General',
                    description: 'M√©dico general para atenci√≥n primaria y seguimiento',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Presi√≥n en la espalda media
            if (sintomasLower.includes('presi√≥n en la espalda') || sintomasLower.includes('presi√≥n en la espalda media') ||
                sintomasLower.includes('especie de presi√≥n en la espalda')) {
                return {
                    recommendedSpeciality: 'ortopedia',
                    specialityName: 'Ortopedista',
                    description: 'Especialista en huesos, articulaciones y sistema musculoesquel√©tico',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Dolor de pecho solo al respirar profundo
            if (sintomasLower.includes('me duele el pecho') &&
                (sintomasLower.includes('solo cuando respiro profundo') || sintomasLower.includes('al respirar profundo') ||
                sintomasLower.includes('cuando respiro profundo'))) {
                return {
                    recommendedSpeciality: 'neumologia',
                    specialityName: 'Neum√≥logo',
                    description: 'Especialista en enfermedades respiratorias y pulmones',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Mareos al estar de pie
            if (sintomasLower.includes('me siento mareado') &&
                (sintomasLower.includes('cuando estoy mucho rato de pie') || sintomasLower.includes('al estar de pie') ||
                sintomasLower.includes('de pie mucho tiempo'))) {
                return {
                    recommendedSpeciality: 'neurologia',
                    specialityName: 'Neur√≥logo',
                    description: 'Especialista en enfermedades del sistema nervioso y cerebro',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Punzada en el abdomen (gen√©rica, sin especificar est√≥mago)
            if ((sintomasLower.includes('punzada en el abdomen') || sintomasLower.includes('como una punzada')) &&
                (sintomasLower.includes('a veces') || sintomasLower.includes('a ratos'))) {
                return {
                    recommendedSpeciality: 'gastroenterologia',
                    specialityName: 'Gastroenter√≥logo',
                    description: 'Especialista en sistema digestivo y enfermedades gastrointestinales',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Dificultad para mantener ojos abiertos
            if ((sintomasLower.includes('me cuesta mantener los ojos abiertos') || sintomasLower.includes('dificultad para mantener ojos abiertos')) &&
                sintomasLower.includes('al final del d√≠a')) {
                if (sintomasLower.includes('sed') || sintomasLower.includes('peso') || sintomasLower.includes('tiroides')) {
                    return {
                        recommendedSpeciality: 'endocrinologia',
                        specialityName: 'Endocrin√≥logo',
                        description: 'Especialista en hormonas, metabolismo y gl√°ndulas endocrinas',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else {
                    return {
                        recommendedSpeciality: 'oftalmologia',
                        specialityName: 'Oftalm√≥logo',
                        description: 'Especialista en enfermedades de los ojos y visi√≥n',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Sensaci√≥n de enfermedad inminente
            if (sintomasLower.includes('me siento raro') || sintomasLower.includes('como si me fuera a enfermar') ||
                sintomasLower.includes('sensaci√≥n de enfermedad') || sintomasLower.includes('como si fuera a enfermar')) {
                return {
                    recommendedSpeciality: 'medicina-general',
                    specialityName: 'M√©dico General',
                    description: 'M√©dico general para atenci√≥n primaria y seguimiento',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Agitaci√≥n r√°pida al caminar despacio
            if ((sintomasLower.includes('me agito r√°pido') || sintomasLower.includes('agitaci√≥n r√°pida')) &&
                (sintomasLower.includes('aunque camine despacio') || sintomasLower.includes('caminando despacio') ||
                sintomasLower.includes('al caminar despacio'))) {
                if (sintomasLower.includes('coraz√≥n') || sintomasLower.includes('corazon') || sintomasLower.includes('palpitaciones')) {
                    return {
                        recommendedSpeciality: 'cardiologia',
                        specialityName: 'Cardi√≥logo',
                        description: 'Especialista en enfermedades del coraz√≥n y sistema cardiovascular',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else {
                    return {
                        recommendedSpeciality: 'neumologia',
                        specialityName: 'Neum√≥logo',
                        description: 'Especialista en enfermedades respiratorias y pulmones',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Dolor en dedos de los pies sin motivo
            if ((sintomasLower.includes('me duelen los dedos de los pies') || sintomasLower.includes('dolor en dedos de los pies')) &&
                (sintomasLower.includes('sin motivo') || sintomasLower.includes('sin raz√≥n') || sintomasLower.includes('a veces'))) {
                return {
                    recommendedSpeciality: 'reumatologia',
                    specialityName: 'Reumat√≥logo',
                    description: 'Especialista en enfermedades autoinmunes y articulaciones',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Cara caliente sin fiebre
            if ((sintomasLower.includes('cara caliente') || sintomasLower.includes('siento la cara caliente')) &&
                (sintomasLower.includes('sin fiebre') || sintomasLower.includes('pero no tengo fiebre'))) {
                if (sintomasLower.includes('tiroides') || sintomasLower.includes('hormon')) {
                    return {
                        recommendedSpeciality: 'endocrinologia',
                        specialityName: 'Endocrin√≥logo',
                        description: 'Especialista en hormonas, metabolismo y gl√°ndulas endocrinas',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else {
                    return {
                        recommendedSpeciality: 'medicina-general',
                        specialityName: 'M√©dico General',
                        description: 'M√©dico general para atenci√≥n primaria y seguimiento',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Hombros tensos constantemente
            if ((sintomasLower.includes('hombros tensos') || sintomasLower.includes('hombros r√≠gidos')) &&
                (sintomasLower.includes('todo el tiempo') || sintomasLower.includes('constantemente'))) {
                return {
                    recommendedSpeciality: 'ortopedia',
                    specialityName: 'Ortopedista',
                    description: 'Especialista en huesos, articulaciones y sistema musculoesquel√©tico',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Dificultad para respirar bien acostado
            if (sintomasLower.includes('me cuesta respirar bien') &&
                (sintomasLower.includes('cuando estoy acostado') || sintomasLower.includes('al estar acostado') ||
                sintomasLower.includes('acostado'))) {
                if (sintomasLower.includes('coraz√≥n') || sintomasLower.includes('corazon') || sintomasLower.includes('palpitaciones')) {
                    return {
                        recommendedSpeciality: 'cardiologia',
                        specialityName: 'Cardi√≥logo',
                        description: 'Especialista en enfermedades del coraz√≥n y sistema cardiovascular',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else {
                    return {
                        recommendedSpeciality: 'neumologia',
                        specialityName: 'Neum√≥logo',
                        description: 'Especialista en enfermedades respiratorias y pulmones',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Dolor de pie/extremidades - debe ir a Ortopedia
            if (sintomasLower.includes('dolor de pie') || sintomasLower.includes('dolor pie') || 
                sintomasLower.includes('dolor en el pie') || sintomasLower.includes('pie') && sintomasLower.includes('dolor') ||
                sintomasLower.includes('tobillo') && sintomasLower.includes('dolor') ||
                sintomasLower.includes('rodilla') && sintomasLower.includes('dolor') ||
                sintomasLower.includes('hombro') && sintomasLower.includes('dolor') ||
                sintomasLower.includes('dolor en extremidades')) {
                return {
                    recommendedSpeciality: 'ortopedia',
                    specialityName: 'Ortopedista',
                    description: 'Especialista en huesos, articulaciones y sistema musculoesquel√©tico',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Dolor de pene/genitales - debe ir a Urolog√≠a
            if (sintomasLower.includes('dolor de pene') || sintomasLower.includes('dolor pene') || 
                sintomasLower.includes('dolor genital') || (sintomasLower.includes('pene') && sintomasLower.includes('dolor'))) {
                return {
                    recommendedSpeciality: 'urologia',
                    specialityName: 'Ur√≥logo',
                    description: 'Especialista en sistema urinario y genital masculino',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Sed excesiva o cambios de peso - debe ir a Endocrinolog√≠a
            if (sintomasLower.includes('mucha sed') || sintomasLower.includes('sed excesiva') || 
                sintomasLower.includes('sed todo el tiempo') || sintomasLower.includes('subido de peso sin motivo') ||
                sintomasLower.includes('bajado de peso sin dieta') || sintomasLower.includes('aumento de peso') ||
                sintomasLower.includes('p√©rdida de peso') || sintomasLower.includes('perdida de peso') ||
                sintomasLower.includes('bajar de peso') || sintomasLower.includes('subir de peso')) {
                return {
                    recommendedSpeciality: 'endocrinologia',
                    specialityName: 'Endocrin√≥logo',
                    description: 'Especialista en hormonas, metabolismo y gl√°ndulas endocrinas',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Problemas de audici√≥n - debe ir a Otorrinolaringolog√≠a
            if (sintomasLower.includes('oigo menos') || sintomasLower.includes('problemas de audici√≥n') ||
                sintomasLower.includes('problemas de audicion') || sintomasLower.includes('sordera') ||
                sintomasLower.includes('no oigo bien') || sintomasLower.includes('p√©rdida de audici√≥n') ||
                sintomasLower.includes('perdida de audicion') || sintomasLower.includes('dificultad para o√≠r') ||
                sintomasLower.includes('dificultad para oir')) {
                return {
                    recommendedSpeciality: 'otorrinolaringologia',
                    specialityName: 'Otorrinolaring√≥logo',
                    description: 'Especialista en o√≠do, nariz y garganta',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Ca√≠da de pelo - Dermatolog√≠a o Endocrinolog√≠a
            if (sintomasLower.includes('se me cae el pelo') || sintomasLower.includes('ca√≠da de pelo') ||
                sintomasLower.includes('caida de pelo') || sintomasLower.includes('p√©rdida de pelo') ||
                sintomasLower.includes('perdida de pelo') || sintomasLower.includes('alopecia') ||
                sintomasLower.includes('calvicie')) {
                if (sintomasLower.includes('hormon') || sintomasLower.includes('tiroides') || sintomasLower.includes('menopausia')) {
                    return {
                        recommendedSpeciality: 'endocrinologia',
                        specialityName: 'Endocrin√≥logo',
                        description: 'Especialista en hormonas, metabolismo y gl√°ndulas endocrinas',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else {
                    return {
                        recommendedSpeciality: 'dermatologia',
                        specialityName: 'Dermat√≥logo',
                        description: 'Especialista en enfermedades de la piel, pelo y u√±as',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Hinchaz√≥n en extremidades - Ortopedia o Cardiolog√≠a (EVALUAR PRIMERO)
            if ((sintomasLower.includes('hinchaz√≥n') || sintomasLower.includes('hinchazon')) &&
                (sintomasLower.includes('tobillo') || sintomasLower.includes('pie') || sintomasLower.includes('pies') ||
                 sintomasLower.includes('pierna') || sintomasLower.includes('rodilla') || sintomasLower.includes('mano') ||
                 sintomasLower.includes('brazo') || sintomasLower.includes('extremidad'))) {
                // Si tambi√©n menciona coraz√≥n o palpitaciones, podr√≠a ser cardiolog√≠a
                if (sintomasLower.includes('coraz√≥n') || sintomasLower.includes('corazon') || 
                    sintomasLower.includes('palpitaciones') || sintomasLower.includes('al final del d√≠a')) {
                    return {
                        recommendedSpeciality: 'cardiologia',
                        specialityName: 'Cardi√≥logo',
                        description: 'Especialista en enfermedades del coraz√≥n y sistema cardiovascular',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else {
                    return {
                        recommendedSpeciality: 'ortopedia',
                        specialityName: 'Ortopedista',
                        description: 'Especialista en huesos, articulaciones y sistema musculoesquel√©tico',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Gases/hinchaz√≥n digestiva - Gastroenterolog√≠a (SOLO si NO es en extremidades)
            if ((sintomasLower.includes('hinchaz√≥n') || sintomasLower.includes('hinchazon') ||
                sintomasLower.includes('gases') || sintomasLower.includes('flatulencia') ||
                sintomasLower.includes('distensi√≥n abdominal') || sintomasLower.includes('distension abdominal') ||
                sintomasLower.includes('abdomen hinchado') || sintomasLower.includes('est√≥mago hinchado') ||
                sintomasLower.includes('estomago hinchado') || sintomasLower.includes('barriga hinchada') ||
                sintomasLower.includes('vientre hinchado')) &&
                !sintomasLower.includes('tobillo') && !sintomasLower.includes('pie') && 
                !sintomasLower.includes('pies') && !sintomasLower.includes('pierna') &&
                !sintomasLower.includes('rodilla') && !sintomasLower.includes('mano') &&
                !sintomasLower.includes('brazo') && !sintomasLower.includes('extremidad')) {
                return {
                    recommendedSpeciality: 'gastroenterologia',
                    specialityName: 'Gastroenter√≥logo',
                    description: 'Especialista en sistema digestivo y enfermedades gastrointestinales',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Dolor de espalda - Ortopedia
            if (sintomasLower.includes('dolor de espalda') || sintomasLower.includes('dolor espalda') ||
                sintomasLower.includes('me duele la espalda') || sintomasLower.includes('dolor lumbar') ||
                sintomasLower.includes('dolor cervical') || sintomasLower.includes('espalda') && sintomasLower.includes('dolor')) {
                return {
                    recommendedSpeciality: 'ortopedia',
                    specialityName: 'Ortopedista',
                    description: 'Especialista en huesos, articulaciones y sistema musculoesquel√©tico',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Dificultad para caminar - Ortopedia o Neurolog√≠a
            if (sintomasLower.includes('me cuesta caminar') || sintomasLower.includes('dificultad para caminar') ||
                sintomasLower.includes('dificultad caminar') || sintomasLower.includes('problemas para caminar')) {
                if (sintomasLower.includes('equilibrio') || sintomasLower.includes('mareo') || 
                    sintomasLower.includes('v√©rtigo') || sintomasLower.includes('vertigo') ||
                    sintomasLower.includes('adormecimiento')) {
                    return {
                        recommendedSpeciality: 'neurologia',
                        specialityName: 'Neur√≥logo',
                        description: 'Especialista en enfermedades del sistema nervioso y cerebro',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else {
                    return {
                        recommendedSpeciality: 'ortopedia',
                        specialityName: 'Ortopedista',
                        description: 'Especialista en huesos, articulaciones y sistema musculoesquel√©tico',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Torcedura/lesiones - Ortopedia
            if (sintomasLower.includes('me torc√≠') || sintomasLower.includes('me torci') ||
                sintomasLower.includes('torcedura') || sintomasLower.includes('esguince') ||
                sintomasLower.includes('me lastim√©') || sintomasLower.includes('me lastime') ||
                sintomasLower.includes('lesi√≥n') || sintomasLower.includes('lesion') ||
                sintomasLower.includes('golpe') && sintomasLower.includes('dolor')) {
                return {
                    recommendedSpeciality: 'ortopedia',
                    specialityName: 'Ortopedista',
                    description: 'Especialista en huesos, articulaciones y sistema musculoesquel√©tico',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Adormecimiento - Neurolog√≠a
            if (sintomasLower.includes('se me duerme') || sintomasLower.includes('adormecimiento') ||
                sintomasLower.includes('entumecimiento') || sintomasLower.includes('hormigueo') ||
                sintomasLower.includes('p√©rdida de sensibilidad') || sintomasLower.includes('perdida de sensibilidad')) {
                return {
                    recommendedSpeciality: 'neurologia',
                    specialityName: 'Neur√≥logo',
                    description: 'Especialista en enfermedades del sistema nervioso y cerebro',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Sangre al ir al ba√±o - Gastroenterolog√≠a o Urolog√≠a
            if (sintomasLower.includes('sangre al ir al ba√±o') || sintomasLower.includes('sangre en heces') ||
                sintomasLower.includes('sangre en orina') || sintomasLower.includes('sangre al defecar') ||
                sintomasLower.includes('sangre al orinar')) {
                if (sintomasLower.includes('orinar') || sintomasLower.includes('orina') || 
                    sintomasLower.includes('micci√≥n') || sintomasLower.includes('miccion')) {
                    return {
                        recommendedSpeciality: 'urologia',
                        specialityName: 'Ur√≥logo',
                        description: 'Especialista en sistema urinario y genital masculino',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else {
                    return {
                        recommendedSpeciality: 'gastroenterologia',
                        specialityName: 'Gastroenter√≥logo',
                        description: 'Especialista en sistema digestivo y enfermedades gastrointestinales',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // P√©rdida de equilibrio - Neurolog√≠a
            if (sintomasLower.includes('pierdo el equilibrio') || sintomasLower.includes('p√©rdida de equilibrio') ||
                sintomasLower.includes('perdida de equilibrio') || sintomasLower.includes('problemas de equilibrio') ||
                sintomasLower.includes('desequilibrio') || sintomasLower.includes('me caigo')) {
                return {
                    recommendedSpeciality: 'neurologia',
                    specialityName: 'Neur√≥logo',
                    description: 'Especialista en enfermedades del sistema nervioso y cerebro',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // P√©rdida de apetito - Gastroenterolog√≠a
            if (sintomasLower.includes('no tengo apetito') || sintomasLower.includes('p√©rdida de apetito') ||
                sintomasLower.includes('perdida de apetito') || sintomasLower.includes('falta de apetito') ||
                sintomasLower.includes('sin apetito')) {
                return {
                    recommendedSpeciality: 'gastroenterologia',
                    specialityName: 'Gastroenter√≥logo',
                    description: 'Especialista en sistema digestivo y enfermedades gastrointestinales',
                    confidence: 'alta',
                    score: 10,
                    allMatches: []
                };
            }
            
            // Herpes genital/enfermedades genitales - debe considerar g√©nero
            if (sintomasLower.includes('herpes genital') || (sintomasLower.includes('herpes') && sintomasLower.includes('genital')) ||
                sintomasLower.includes('enfermedad de transmisi√≥n sexual') || sintomasLower.includes('enfermedad de transmision sexual') ||
                sintomasLower.includes('ets') || sintomasLower.includes('its') || sintomasLower.includes('infecci√≥n genital') ||
                sintomasLower.includes('infeccion genital') || sintomasLower.includes('verrugas genitales') ||
                sintomasLower.includes('s√≠filis') || sintomasLower.includes('sifilis') || sintomasLower.includes('gonorrea') ||
                sintomasLower.includes('clamidia') || (sintomasLower.includes('herpes') && (genero === 'masculino' || genero === 'femenino'))) {
                // Si g√©nero es masculino ‚Üí urolog√≠a
                if (genero === 'masculino' || sintomasLower.includes('pene') || sintomasLower.includes('genital masculino')) {
                    return {
                        recommendedSpeciality: 'urologia',
                        specialityName: 'Ur√≥logo',
                        description: 'Especialista en sistema urinario y genital masculino',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
                // Si g√©nero es femenino ‚Üí ginecolog√≠a
                else if (genero === 'femenino' || sintomasLower.includes('vaginal') || sintomasLower.includes('genital femenino')) {
                    return {
                        recommendedSpeciality: 'ginecologia',
                        specialityName: 'Ginec√≥logo',
                        description: 'Especialista en salud reproductiva femenina',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
                // Por defecto seg√∫n edad (mujeres en edad reproductiva ‚Üí ginecolog√≠a)
                else {
                    return {
                        recommendedSpeciality: edad >= 12 && edad <= 65 ? 'ginecologia' : 'urologia',
                        specialityName: edad >= 12 && edad <= 65 ? 'Ginec√≥logo' : 'Ur√≥logo',
                        description: edad >= 12 && edad <= 65 ? 'Especialista en salud reproductiva femenina' : 'Especialista en sistema urinario y genital masculino',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
            }
            
            // Dolor de pubis/p√©lvico - debe ir a Ginecolog√≠a o Urolog√≠a
            if (sintomasLower.includes('dolor de pubis') || sintomasLower.includes('dolor pubis') || 
                sintomasLower.includes('dolor en pubis') || sintomasLower.includes('dolor p√©lvico') || 
                sintomasLower.includes('dolor pelvico') || (sintomasLower.includes('pubis') && sintomasLower.includes('dolor'))) {
                // Si g√©nero es masculino ‚Üí urolog√≠a
                if (genero === 'masculino' || sintomasLower.includes('pene') || sintomasLower.includes('genital masculino')) {
                    return {
                        recommendedSpeciality: 'urologia',
                        specialityName: 'Ur√≥logo',
                        description: 'Especialista en sistema urinario y genital masculino',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                }
                // Si es mujer en edad reproductiva, ginecolog√≠a
                else if (genero === 'femenino' || (edad >= 12 && edad <= 65 && (sintomasLower.includes('menstrual') || sintomasLower.includes('vaginal') || 
                    sintomasLower.includes('embarazo') || sintomasLower.includes('ovario') || sintomasLower.includes('√∫tero')))) {
                    return {
                        recommendedSpeciality: 'ginecologia',
                        specialityName: 'Ginec√≥logo',
                        description: 'Especialista en salud reproductiva femenina',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else if (sintomasLower.includes('orinar') || sintomasLower.includes('urinario') || 
                          sintomasLower.includes('pr√≥stata') || sintomasLower.includes('prostata') || 
                          sintomasLower.includes('vejiga')) {
                    return {
                        recommendedSpeciality: 'urologia',
                        specialityName: 'Ur√≥logo',
                        description: 'Especialista en sistema urinario y genital masculino',
                        confidence: 'alta',
                        score: 10,
                        allMatches: []
                    };
                } else {
                    // Por defecto seg√∫n g√©nero y edad
                    if (genero === 'masculino') {
                        return {
                            recommendedSpeciality: 'urologia',
                            specialityName: 'Ur√≥logo',
                            description: 'Especialista en sistema urinario y genital masculino',
                            confidence: 'alta',
                            score: 10,
                            allMatches: []
                        };
                    } else if (genero === 'femenino' && edad >= 12 && edad <= 65) {
                        return {
                            recommendedSpeciality: 'ginecologia',
                            specialityName: 'Ginec√≥logo',
                            description: 'Especialista en salud reproductiva femenina',
                            confidence: 'alta',
                            score: 10,
                            allMatches: []
                        };
                    } else {
                        return {
                            recommendedSpeciality: edad >= 12 && edad <= 65 ? 'ginecologia' : 'urologia',
                            specialityName: edad >= 12 && edad <= 65 ? 'Ginec√≥logo' : 'Ur√≥logo',
                            description: edad >= 12 && edad <= 65 ? 'Especialista en salud reproductiva femenina' : 'Especialista en sistema urinario y genital masculino',
                            confidence: 'alta',
                            score: 10,
                            allMatches: []
                        };
                    }
                }
            }
            
            const specialityPatterns = {
                'cardiologia': {
                    keywords: ['palpitaciones', 'arritmia', 'taquicardia', 'bradicardia', 'presi√≥n arterial', 'presion arterial', 'hipertensi√≥n', 'hipertension', 'coraz√≥n', 'corazon', 'cardiaco', 'angina', 'infarto', 'dolor tor√°cico card√≠aco', 'dolor toracico cardiaco', 'presi√≥n en el pecho al hacer esfuerzo', 'molestia en el pecho al hacer esfuerzo', 'dolor en el pecho al hacer esfuerzo', 'presi√≥n en el pecho al caminar', 'presi√≥n en el pecho al ejercitar', 'presi√≥n en el pecho al subir escaleras', 'coraz√≥n late fuerte sin raz√≥n', 'siento el coraz√≥n sin motivo', 'latidos fuertes sin hacer nada', 'palpitaciones sin raz√≥n', 'palpitaciones sin motivo', 'palpitaciones y sensaci√≥n de falta de aire', 'se me hinchan los pies al final del d√≠a', 'hinchaz√≥n de pies al final del d√≠a', 'pies hinchados al final del d√≠a', 'mareo al levantarse', 'mareo cuando me levanto', 'me mareo al levantarme r√°pido', 'mareo al pararse'],
                    ageFactors: { min: 40, weight: 1.5 },
                    urgency: { high: 8, medium: 6 },
                    excludeKeywords: ['muela', 'diente', 'dental', 'boca', 'odont', 'caries', 'enc√≠a', 'encia', 'cabeza', 'cefalea', 'migra√±a', 'migrana', 'pie', 'pies', 'tobillo', 'rodilla', 'hombro', 'pubis', 'p√©lvico', 'pelvico', 'vaginal', 'abdomen', 'est√≥mago', 'estomago', 'abdominal', 'extremidad', 'brazo', 'pierna', 'mano', 'dolor de cabeza', 'dolor de pie', 'dolor en el pie', 'pene', 'genital', 'sed', 'peso', 'audici√≥n', 'audicion', 'oigo', 'pelo', 'hinchaz√≥n', 'hinchazon', 'gases', 'espalda', 'caminar', 'torc√≠', 'torci', 'duerme', 'sangre', 'equilibrio', 'apetito', 'orinar', 'defecar', 'heces', 'orina'] // Excluir TODOS los s√≠ntomas no card√≠acos
                },
                'neurologia': {
                    keywords: ['dolor cabeza', 'dolor de cabeza', 'cefalea', 'migra√±a', 'migrana', 'mareo', 'v√©rtigo', 'vertigo', 'convulsiones', 'epilepsia', 'temblor', 'par√°lisis', 'paralisis', 'debilidad muscular', 'entumecimiento', 'hormigueo', 'p√©rdida memoria', 'perdida memoria', 'confusi√≥n', 'confusion', 'desorientaci√≥n', 'desorientacion', 'cambios personalidad', 'problemas habla', 'dificultad caminar', 'coordinaci√≥n', 'coordinacion', 'se me duerme', 'adormecimiento', 'p√©rdida de sensibilidad', 'perdida de sensibilidad', 'pierdo el equilibrio', 'p√©rdida de equilibrio', 'perdida de equilibrio', 'problemas de equilibrio', 'desequilibrio', 'me caigo', 'dolor de cabeza casi todos los d√≠as', 'dolor de cabeza por las tardes', 'me tiemblan las manos', 'temblores en las manos', 'manos temblorosas', 'entumecimiento en los dedos', 'se me duermen los dedos', 'dedos entumecidos', 'manos fr√≠as y hormigueo', 'manos fr√≠as y entumecimiento', 'presi√≥n en la cabeza al agacharme', 'presi√≥n cuando me agacho', 'dificultad para recordar', 'no recuerdo cosas recientes', 'problemas de memoria', 'olvido', 'se me duerme un lado de la cara', 'adormecimiento en la cara', 'cara adormecida', 'presi√≥n constante en la frente', 'presi√≥n en la frente', 'dolor de presi√≥n en la frente', 'me despierto con dolor de cabeza', 'dolor de cabeza al despertar', 'dolor de cabeza por las ma√±anas', 'me cuesta mantener el equilibrio', 'dificultad para mantener el equilibrio al caminar', 'calambres en las piernas', 'calambres por la noche', 'calambres nocturnos'],
                    ageFactors: { min: 0, weight: 2.5 }, // Aumentar peso para priorizar
                    urgency: { high: 7, medium: 5 }
                },
                'pediatria': {
                    keywords: ['ni√±o', 'beb√©', 'infantil', 'fiebre', 'llanto', 'irritabilidad', 'dificultad comer', 'v√≥mitos', 'diarrea', 'desarrollo', 'crecimiento', 'vacunas', 'pedi√°trico'],
                    ageFactors: { max: 18, weight: 2.0 },
                    urgency: { high: 6, medium: 4 }
                },
                'ginecologia': {
                    keywords: ['menstrual', 'regla', 'menstruaci√≥n', 'menstruacion', 'embarazo', 'embarazada', 'parto', 'menopausia', 'ovario', '√∫tero', 'utero', 'vaginal', 'mama', 'seno', 'mamario', 'p√©lvico', 'pelvico', 'genital femenino', 'fertilidad', 'infertilidad', 'pubis', 'dolor pubis', 'dolor de pubis', 'dolor p√©lvico', 'dolor pelvico', 'dolor en pubis', 'herpes genital', 'herpes', 'enfermedad de transmisi√≥n sexual', 'enfermedad de transmision sexual', 'ets', 'its', 'infecci√≥n genital', 'infeccion genital', 'verrugas genitales', 's√≠filis', 'sifilis', 'gonorrea', 'clamidia'],
                    ageFactors: { min: 12, max: 65, weight: 2.0 }, // Aumentar peso para priorizar
                    urgency: { high: 7, medium: 5 },
                    excludeKeywords: ['pene', 'genital masculino', 'masculino'] // Excluir si es masculino
                },
                'dermatologia': {
                    keywords: ['piel', 'dermatitis', 'erupci√≥n', 'sarpullido', 'manchas', 'lunares', 'verrugas', 'acn√©', 'eczema', 'psoriasis', 'alergia', 'picaz√≥n', 'prurito', 'urticaria', 'ampollas', '√∫lceras', 'c√°ncer piel', 'melanoma', 'se me cae el pelo', 'ca√≠da de pelo', 'caida de pelo', 'p√©rdida de pelo', 'perdida de pelo', 'alopecia', 'calvicie', 'se me cae el cabello', 'ca√≠da de cabello', 'caida de cabello', 'p√©rdida de cabello', 'perdida de cabello', 'picaz√≥n en la piel', 'picor en la piel', 'me pica la piel', 'ronchas', 'piel seca', 'se descama', 'descamaci√≥n', 'piel muy seca', 'me pican los brazos', 'picaz√≥n en los brazos', 'picor en los brazos', 'piel sensible al sol', 'sensibilidad al sol', 'me quema el sol', 'u√±as quebradizas', 'u√±as fr√°giles', 'se me rompen las u√±as', 'labios agrietados', 'labios secos todo el tiempo', 'labios que se agrietan', 'picaz√≥n en el cuero cabelludo', 'me pica el cuero cabelludo', 'picor en la cabeza'],
                    ageFactors: { min: 0, weight: 1.5 }, // Aumentar peso
                    urgency: { high: 6, medium: 4 }
                },
                'oftalmologia': {
                    keywords: ['ojo', 'ojos', 'visi√≥n', 'vista', 'ceguera', 'borroso', 'doble visi√≥n', 'dolor ocular', 'enrojecimiento', 'lagrimeo', 'seco', 'glaucoma', 'cataratas', 'retina', 'c√≥rnea', 'pupila', 'p√°rpado', 'veo borroso', 'visi√≥n borrosa', 'veo borroso a ratos', 'visi√≥n borrosa con la luz', 'ojos secos', 'ojos muy secos', 'me arden los ojos', 'ardor en los ojos', 'dolor de cabeza detr√°s de los ojos', 'dolor detr√°s de los ojos', 'picaz√≥n en los ojos', 'me pican los ojos', 'picor en los ojos', 'picaz√≥n en los ojos al aire libre', 'me pican los ojos cuando salgo'],
                    ageFactors: { min: 0, weight: 1.0 },
                    urgency: { high: 7, medium: 5 }
                },
                'ortopedia': {
                    keywords: ['hueso', 'articulaci√≥n', 'articulacion', 'dolor espalda', 'dolor lumbar', 'dolor cervical', 'rodilla', 'hombro', 'cadera', 'fractura', 'esguince', 'luxaci√≥n', 'luxacion', 'artritis', 'artrosis', 'osteoporosis', 'tendinitis', 'bursitis', 'hernia discal', 'escoliosis', 'pie', 'pies', 'tobillo', 'tobillos', 'dolor pie', 'dolor de pie', 'dolor en el pie', 'mu√±eca', 'muneca', 'codo', 'codos', 'brazo', 'brazos', 'pierna', 'piernas', 'mano', 'manos', 'extremidad', 'extremidades', 'dolor en extremidades', 'me duele la espalda', 'espalda', 'me cuesta caminar', 'dificultad para caminar', 'dificultad caminar', 'problemas para caminar', 'me torc√≠', 'me torci', 'torcedura', 'me lastim√©', 'me lastime', 'lesi√≥n', 'lesion', 'dolor de rodilla al subir escaleras', 'me duele la rodilla al subir', 'me cuesta levantar los brazos', 'dificultad para levantar brazos', 'dolor en el hombro al levantar', 'me duelen los pies al caminar', 'dolor en los pies al caminar', 'dolor de pies al caminar', 'dolor en los m√∫sculos del cuello', 'dolor cuello y hombros', 'm√∫sculos del cuello duelen', 'dolor punzante detr√°s de la rodilla', 'dolor detr√°s de la rodilla', 'ardor en la espalda alta', 'dolor en la espalda alta', 'espalda alta duele', 'dolor en los m√∫sculos despu√©s de estar sentado', 'me duelen los m√∫sculos al estar sentado', 'me suenan los huesos', 'ruido en los huesos al mover', 'crujidos en los huesos', 'rigidez en el cuello al despertar', 'me levanto con rigidez en el cuello', 'cuello r√≠gido al despertar', 'dolor en la espalda baja', 'dolor de espalda baja', 'hinchaz√≥n de tobillo', 'hinchaz√≥n tobillo', 'tobillo hinchado', 'hinchaz√≥n en el tobillo', 'hinchaz√≥n de pie', 'hinchaz√≥n pie', 'pie hinchado', 'hinchaz√≥n en el pie', 'hinchaz√≥n de pies', 'pies hinchados', 'hinchaz√≥n de pierna', 'hinchaz√≥n pierna', 'pierna hinchada', 'hinchaz√≥n en la pierna', 'hinchaz√≥n de rodilla', 'rodilla hinchada', 'hinchaz√≥n en la rodilla', 'hinchaz√≥n de mano', 'mano hinchada', 'hinchaz√≥n en la mano', 'hinchaz√≥n de brazo', 'brazo hinchado', 'hinchaz√≥n en el brazo'],
                    ageFactors: { min: 0, weight: 2.5 }, // Aumentar peso para priorizar
                    urgency: { high: 6, medium: 4 }
                },
                'odontologia': {
                    keywords: ['muela', 'diente', 'dental', 'odont', 'boca', 'enc√≠a', 'gingival', 'caries', 'absceso dental', 'ortodoncia', 'endodoncia', 'periodoncia', 'dentadura', 'implante dental', 'extracci√≥n dental', 'masticar', 'mastic', 'mordida', 'mand√≠bula dental', 'dolor bucal', 'dolor oral', 'me arde la lengua', 'ardor en la lengua', 'mal sabor de boca', 'me duelen las enc√≠as', 'enc√≠as sangran', 'sangrado de enc√≠as', 'enc√≠as que sangran al cepillarme', 'me suena la mand√≠bula', 'mand√≠bula que suena', 'ruido en la mand√≠bula al abrir'],
                    ageFactors: { min: 0, weight: 3.0 }, // Peso muy alto para priorizar odontolog√≠a
                    urgency: { high: 7, medium: 5 }
                },
                'psiquiatria': {
                    keywords: ['depresi√≥n', 'depresion', 'ansiedad', 'estr√©s', 'estres', 'ataque de p√°nico', 'ataque de panico', 'trastorno mental', 'pensamiento suicida', 'suicidio', 'bipolar', 'esquizofrenia', 'psicosis', 'alucinaciones', 'delirios', 'fobia', 'obsesivo', 'compulsivo', 'trastorno alimentario', 'anorexia', 'bulimia', 'psiquiatr', 'me cuesta dormir', 'dificultad para dormir', 'no puedo dormir', 'paso dando vueltas', 'insomnio', 'me cuesta concentrarme', 'dificultad para concentrarse', 'muy distra√≠do', 'no me puedo concentrar', 'problemas de concentraci√≥n', 'ansiedad casi todo el tiempo', 'siempre ansioso', 'nervioso todo el tiempo', 'me siento triste', 'tristeza sin motivo', 'sin ganas de hacer nada', 'triste sin raz√≥n', 'cambios de humor', 'cambios de √°nimo', 'altibajos emocionales', 'siempre nervioso con palpitaciones', 'nervioso con palpitaciones'],
                    ageFactors: { min: 0, weight: 1.2 },
                    urgency: { high: 9, medium: 6 }
                },
                'endocrinologia': {
                    keywords: ['diabetes', 'glucosa', 'insulina', 'tiroides', 'hipotiroidismo', 'hipertiroidismo', 'hormon', 'obesidad', 'sobrepeso', 'crecimiento', 'pubertad', 'menopausia', 'testosterona', 'estr√≥geno', 'estrogeno', 'cortisol', 'adrenalina', 'endocrin', 'mucha sed', 'sed excesiva', 'sed todo el tiempo', 'subido de peso sin motivo', 'bajado de peso sin dieta', 'aumento de peso', 'p√©rdida de peso', 'perdida de peso', 'bajar de peso', 'subir de peso', 'cansancio despu√©s de comer', 'mucho cansancio despu√©s de comer', 'sue√±o despu√©s de comer', 'siento calor de repente', 'calor repentino', 'sudo mucho', 'sofocos', 'bochornos', 'mareo despu√©s de comer', 'me mareo despu√©s de comer', 'mareos tras comer', 'me cuesta subir de peso', 'no puedo subir de peso', 'dificultad para ganar peso', 'sensibilidad al fr√≠o', 'mucha sensibilidad al fr√≠o', 'no tolero el fr√≠o', 'sue√±o durante el d√≠a', 'me da sue√±o en el d√≠a', 'somnolencia diurna aunque duerma bien', 'mucha hambre aunque haya comido', 'hambre excesiva', 'siempre tengo hambre', 'bulto en el cuello', 'bulto peque√±o en el cuello', 'n√≥dulo en el cuello', 'ganas de orinar por la noche', 'orinar frecuente por la noche', 'muchas veces al ba√±o por la noche'],
                    ageFactors: { min: 0, weight: 2.0 }, // Aumentar peso
                    urgency: { high: 7, medium: 5 }
                },
                'urologia': {
                    keywords: ['problemas urinarios', 'orinar', 'micci√≥n', 'miccion', 'pr√≥stata', 'prostata', 'ri√±ones', 'rinones', 'ri√±√≥n', 'rinon', 'vejiga', 'c√°lculo renal', 'calculo renal', 'piedra renal', 'infecci√≥n urinaria', 'infeccion urinaria', 'cistitis', 'uretritis', 'incontinencia', 'disfunci√≥n er√©ctil', 'disfuncion erectil', 'impotencia', 'urolog', 'dolor al orinar', 'dolor pubis', 'dolor de pubis', 'dolor en pubis', 'dolor de pene', 'dolor pene', 'dolor genital', 'pene', 'genital masculino', 'sangre en orina', 'sangre al orinar', 'herpes genital', 'herpes', 'enfermedad de transmisi√≥n sexual', 'enfermedad de transmision sexual', 'ets', 'its', 'infecci√≥n genital', 'infeccion genital', 'verrugas genitales', 's√≠filis', 'sifilis', 'gonorrea', 'clamidia', 'me arde al orinar', 'ardor al orinar', 'quemaz√≥n al orinar', 'muchas veces al ba√±o', 'frecuente al ba√±o', 'a menudo al ba√±o'],
                    ageFactors: { min: 0, weight: 2.0 }, // Aumentar peso
                    urgency: { high: 7, medium: 5 },
                    excludeKeywords: ['vaginal', 'genital femenino', 'femenino', 'menstrual', 'embarazo', 'ovario', '√∫tero', 'utero'] // Excluir si es femenino
                },
                'otorrinolaringologia': {
                    keywords: ['dolor de o√≠do', 'dolor de oido', 'o√≠do', 'oido', 'audici√≥n', 'audicion', 'sordera', 'tinnitus', 'ac√∫fenos', 'acufenos', 'dolor de garganta', 'faringitis', 'amigdalitis', 'ronquera', 'disfon√≠a', 'disfonia', 'sinusitis', 'rinitis', 'alergia nasal', 'congesti√≥n nasal', 'congestion nasal', 'sangrado nasal', 'epistaxis', 'orl', 'otorrino', 'oigo menos', 'problemas de audici√≥n', 'problemas de audicion', 'no oigo bien', 'p√©rdida de audici√≥n', 'perdida de audicion', 'dificultad para o√≠r', 'dificultad para oir', 'boca seca al despertar', 'boca seca y dolor de garganta', 'dolor de o√≠dos y zumbido', 'zumbido constante', 'me cuesta tragar', 'dificultad para tragar', 'nudo en la garganta', 'sensaci√≥n de nudo al tragar', 'me sangra la nariz', 'sangre por la nariz', 'sangrado de nariz seguido', 'me cuesta respirar por la nariz', 'dificultad para respirar por la nariz', 'nariz tapada', 'v√©rtigo al mirar hacia abajo', 'me da v√©rtigo cuando miro abajo', 'mareo al mirar abajo', 'me cuesta escuchar con ruido', 'dificultad para escuchar en ambientes ruidosos', 'no oigo bien con ruido', 'ronco mucho', 'ronquidos', 'dificultad para respirar por la noche'],
                    ageFactors: { min: 0, weight: 2.0 }, // Aumentar peso
                    urgency: { high: 6, medium: 4 }
                },
                'gastroenterologia': {
                    keywords: ['dolor de est√≥mago', 'dolor de estomago', 'dolor abdominal', 'n√°useas', 'nauseas', 'v√≥mitos', 'vomitos', 'diarrea', 'estre√±imiento', 'estrenimiento', 'reflujo', 'acidez', 'ardor', 'gastritis', '√∫lcera', 'ulcera', 'colitis', 's√≠ndrome del intestino irritable', 'sindrome del intestino irritable', 'enfermedad de crohn', 'colitis ulcerosa', 'hepatitis', 'h√≠gado', 'higado', 'p√°ncreas', 'pancreas', 'gastroenter', 'gases', 'flatulencia', 'distensi√≥n abdominal', 'distension abdominal', 'abdomen hinchado', 'est√≥mago hinchado', 'estomago hinchado', 'barriga hinchada', 'vientre hinchado', 'no tengo apetito', 'p√©rdida de apetito', 'perdida de apetito', 'falta de apetito', 'sin apetito', 'sangre al ir al ba√±o', 'sangre en heces', 'sangre al defecar', 'dolor en el abdomen despu√©s de comer', 'dolor abdominal despu√©s de comer', 'dolor en la parte baja del abdomen al comer', 'est√≥mago hinchado casi todos los d√≠as', 'dolor en el costado derecho', 'dolor costado derecho', 'dolor lado derecho del abdomen', 'me da acidez', 'acidez casi todos los d√≠as', 'acidez frecuente', 'ardor en el pecho al acostarme', 'reflujo al acostarse', 'dolor de est√≥mago cuando estoy nervioso', 'nudo en el est√≥mago cuando estoy nervioso', 'sensaci√≥n de nudo cuando estoy nervioso', 'me suenan las tripas', 'ruidos en el est√≥mago', 'suenan los intestinos aunque no tenga hambre', 'piel amarillenta', 'piel amarilla', 'ictericia', 'color amarillo'],
                    ageFactors: { min: 0, weight: 2.0 }, // Aumentar peso
                    urgency: { high: 7, medium: 5 },
                    excludeKeywords: ['tobillo', 'pie', 'pies', 'pierna', 'rodilla', 'mano', 'brazo', 'extremidad', 'hinchaz√≥n de tobillo', 'hinchaz√≥n tobillo', 'tobillo hinchado', 'hinchaz√≥n en el tobillo', 'hinchaz√≥n de pie', 'hinchaz√≥n pie', 'pie hinchado', 'hinchaz√≥n en el pie', 'hinchaz√≥n de pies', 'pies hinchados', 'hinchaz√≥n de pierna', 'hinchaz√≥n pierna', 'pierna hinchada', 'hinchaz√≥n en la pierna'] // Excluir hinchaz√≥n en extremidades
                },
                'neumologia': {
                    keywords: ['dificultad respiratoria', 'dificultad para respirar', 'disnea', 'asma', 'bronquitis', 'neumon√≠a', 'neumonia', 'tos cr√≥nica', 'tos cronica', 'tos persistente', 'esputo', 'flema', 'sangre al toser', 'hemoptisis', 'enfisema', 'epoc', 'fibrosis pulmonar', 'neumolog', 'pulm√≥n', 'pulmon', 'respiratorio', 'dificultad para respirar al caminar', 'me cuesta respirar al caminar r√°pido', 'falta de aire al caminar', 'tos seca que no se va', 'tos que no mejora', 'tos constante', 'tos con flema', 'tos con moco', 'flema que no mejora', 'dolor de pecho al respirar', 'dolor en el pecho cuando respiro profundo', 'falta de aire por las noches', 'dificultad para respirar por la noche', 'me falta el aire al dormir'],
                    ageFactors: { min: 0, weight: 1.2 },
                    urgency: { high: 8, medium: 6 }
                },
                'reumatologia': {
                    keywords: ['artritis', 'artrosis', 'lupus', 'fibromialgia', 'espondilitis', 'gota', 'dolor articular', 'dolor en las articulaciones', 'rigidez matutina', 'inflamaci√≥n articular', 'inflamacion articular', 's√≠ndrome de sj√∂gren', 'sindrome de sjogren', 'esclerodermia', 'polimialgia', 'reumat', 'dolor en las articulaciones por las ma√±anas', 'dolor articular al despertar', 'dolores musculares sin hacer ejercicio', 'dolor muscular sin raz√≥n', 'manos hinchadas al despertar', 'me despierto con las manos hinchadas', 'dolor en los m√∫sculos al despertar', 'me duelen los m√∫sculos al despertar', 'me duelen los huesos cuando hace fr√≠o', 'dolor en los huesos con el fr√≠o', 'dedos morados cuando hace fr√≠o', 'dedos morados con el fr√≠o', 'dedos azules con fr√≠o'],
                    ageFactors: { min: 30, weight: 1.5 },
                    urgency: { high: 6, medium: 4 }
                },
                'hematologia': {
                    keywords: ['anemia', 'hemoglobina baja', 'sangre', 'coagulaci√≥n', 'coagulacion', 'hemorragia', 'sangrado', 'moretones', 'moratones', 'leucemia', 'linfoma', 'mieloma', 'plaquetas', 'gl√≥bulos blancos', 'globulos blancos', 'gl√≥bulos rojos', 'globulos rojos', 'hematolog', 'moretones sin raz√≥n', 'moretones sin motivo', 'me salen moretones', 'moratones sin causa'],
                    ageFactors: { min: 0, weight: 1.2 },
                    urgency: { high: 8, medium: 6 }
                },
                'oncologia': {
                    keywords: ['c√°ncer', 'cancer', 'tumor', 'tumores', 'neoplasia', 'met√°stasis', 'metastasis', 'quimioterapia', 'radioterapia', 'biopsia', 'maligno', 'benigno', 'oncolog'],
                    ageFactors: { min: 0, weight: 2.0 },
                    urgency: { high: 9, medium: 7 }
                },
                'medicina-general': {
                    keywords: ['general', 'malestar', 'cansancio', 'fatiga', 'fiebre', 'gripe', 'resfriado', 'tos general', 'congesti√≥n', 'congestion', 'dolor general', 'nausea', 'v√≥mitos', 'vomitos', 'diarrea', 'estre√±imiento', 'estrenimiento', 'p√©rdida peso', 'perdida peso', 'ganancia peso', 'muy cansado aunque duerma bien', 'cansancio aunque duerma bien', 'fatiga aunque duerma', 'sin energ√≠a aunque duerma bien', 'agotado aunque duerma', 'fiebre leve desde hace varios d√≠as', 'fiebre leve persistente', 'cara hinchada al despertar', 'me despierto con la cara hinchada', 'hinchaz√≥n en la cara', 'se me hinchan los pies al final del d√≠a', 'hinchaz√≥n de pies', 'pies hinchados', 'me siento d√©bil', 'debilidad despu√©s de poco esfuerzo', 'muy d√©bil', 'picaz√≥n en los ojos y la nariz al despertar', 'me pican los ojos y la nariz', 'p√°rpados hinchados al despertar', 'me despierto con los p√°rpados hinchados'],
                    ageFactors: { min: 0, weight: 1.0 },
                    urgency: { high: 5, medium: 3 },
                    excludeKeywords: ['muela', 'diente', 'dental', 'odont', 'caries', 'enc√≠a', 'masticar', 'depresi√≥n', 'depresion', 'ansiedad', 'diabetes', 'tiroides', 'dolor de o√≠do', 'dolor de oido', 'dolor de est√≥mago', 'dolor de estomago', 'dificultad respiratoria', 'problemas urinarios', 'artritis', 'c√°ncer', 'cancer', 'tumor'] // Excluir si hay s√≠ntomas espec√≠ficos
                }
            };

            let bestMatch = { speciality: 'medicina-general', score: 0, confidence: 'baja' };
            let matches = [];

            for (const [speciality, pattern] of Object.entries(specialityPatterns)) {
                let score = 0;
                let keywordMatches = 0;

                // Verificar palabras de exclusi√≥n primero
                if (pattern.excludeKeywords) {
                    const hasExclude = pattern.excludeKeywords.some(exclude => {
                        // Verificar si la palabra de exclusi√≥n est√° en los s√≠ntomas
                        if (sintomasLower.includes(exclude)) return true;
                        // Verificar si la palabra de exclusi√≥n coincide con el g√©nero
                        if (exclude === 'masculino' && genero === 'masculino') return true;
                        if (exclude === 'femenino' && genero === 'femenino') return true;
                        return false;
                    });
                    if (hasExclude) {
                        // Si tiene palabras de exclusi√≥n, reducir significativamente el score
                        score = -10;
                        matches.push({
                            speciality: speciality,
                            score: score,
                            keywordMatches: 0,
                            confidence: 'baja'
                        });
                        continue;
                    }
                }

                pattern.keywords.forEach(keyword => {
                    if (sintomasLower.includes(keyword)) {
                        score += 2;
                        keywordMatches++;
                    }
                });

                if (pattern.ageFactors.min && edad < pattern.ageFactors.min) {
                    score *= 0.3;
                }
                if (pattern.ageFactors.max && edad > pattern.ageFactors.max) {
                    score *= 0.3;
                }
                if (pattern.ageFactors.min && pattern.ageFactors.max && 
                    edad >= pattern.ageFactors.min && edad <= pattern.ageFactors.max) {
                    score *= pattern.ageFactors.weight;
                }

                if (intensidad >= pattern.urgency.high) {
                    score *= 1.5;
                } else if (intensidad >= pattern.urgency.medium) {
                    score *= 1.2;
                }

                sintomasAdicionales.forEach(sintoma => {
                    if (pattern.keywords.some(keyword => keyword.includes(sintoma))) {
                        score += 1;
                    }
                });

                matches.push({
                    speciality: speciality,
                    score: score,
                    keywordMatches: keywordMatches,
                    confidence: score > 4 ? 'alta' : score > 2 ? 'media' : 'baja'
                });
            }

            matches.sort((a, b) => b.score - a.score);
            bestMatch = matches[0];

            const specialityNames = {
                'odontologia': 'Odont√≥logo',
                'cardiologia': 'Cardi√≥logo',
                'neurologia': 'Neur√≥logo',
                'pediatria': 'Pediatra',
                'ginecologia': 'Ginec√≥logo',
                'dermatologia': 'Dermat√≥logo',
                'oftalmologia': 'Oftalm√≥logo',
                'ortopedia': 'Ortopedista',
                'psiquiatria': 'Psiquiatra',
                'endocrinologia': 'Endocrin√≥logo',
                'urologia': 'Ur√≥logo',
                'otorrinolaringologia': 'Otorrinolaring√≥logo',
                'gastroenterologia': 'Gastroenter√≥logo',
                'neumologia': 'Neum√≥logo',
                'reumatologia': 'Reumat√≥logo',
                'hematologia': 'Hemat√≥logo',
                'oncologia': 'Onc√≥logo',
                'medicina-general': 'M√©dico General'
            };

            const specialityDescriptions = {
                'odontologia': 'Especialista en salud dental y bucal',
                'cardiologia': 'Especialista en enfermedades del coraz√≥n y sistema cardiovascular',
                'neurologia': 'Especialista en enfermedades del sistema nervioso y cerebro',
                'pediatria': 'Especialista en salud infantil y desarrollo de ni√±os',
                'ginecologia': 'Especialista en salud reproductiva femenina',
                'dermatologia': 'Especialista en enfermedades de la piel, pelo y u√±as',
                'oftalmologia': 'Especialista en salud ocular y problemas de visi√≥n',
                'ortopedia': 'Especialista en huesos, articulaciones y sistema musculoesquel√©tico',
                'psiquiatria': 'Especialista en salud mental y trastornos psiqui√°tricos',
                'endocrinologia': 'Especialista en hormonas, metabolismo y gl√°ndulas endocrinas',
                'urologia': 'Especialista en sistema urinario y genital masculino',
                'otorrinolaringologia': 'Especialista en o√≠do, nariz y garganta',
                'gastroenterologia': 'Especialista en sistema digestivo y enfermedades gastrointestinales',
                'neumologia': 'Especialista en enfermedades respiratorias y pulmones',
                'reumatologia': 'Especialista en enfermedades autoinmunes y articulaciones',
                'hematologia': 'Especialista en enfermedades de la sangre',
                'oncologia': 'Especialista en c√°ncer y tumores',
                'medicina-general': 'M√©dico general para atenci√≥n primaria y seguimiento'
            };

            return {
                recommendedSpeciality: bestMatch.speciality,
                specialityName: specialityNames[bestMatch.speciality],
                description: specialityDescriptions[bestMatch.speciality],
                confidence: bestMatch.confidence,
                score: bestMatch.score,
                allMatches: matches.slice(0, 3)
            };
        }

        document.getElementById('evaluationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = this.querySelector('.submit-btn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analizando con IA Avanzada...';
            submitBtn.disabled = true;
            
            try {
                const formData = new FormData(this);
                const edad = parseInt(formData.get('edad'));
                const genero = formData.get('genero');
                const sintomas = formData.get('sintomas');
                const duracion = formData.get('duracion');
                const intensidad = parseInt(formData.get('intensidad'));
                
                // Validar que todos los campos obligatorios est√©n completos
                let tieneErrores = false;
                
                if (!genero || genero === '') {
                    alert('Por favor, selecciona tu g√©nero');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    tieneErrores = true;
                    return;
                }
                
                if (!duracion || duracion === '') {
                    alert('Por favor, selecciona la duraci√≥n de los s√≠ntomas');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    tieneErrores = true;
                    return;
                }
                
                if (!intensidad || isNaN(intensidad) || intensidad < 1 || intensidad > 10) {
                    alert('Por favor, selecciona la intensidad del dolor/malestar');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    tieneErrores = true;
                    return;
                }
                
                if (!sintomas || sintomas.trim() === '') {
                    alert('Por favor, describe tus s√≠ntomas');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    tieneErrores = true;
                    return;
                }
                
                if (tieneErrores) {
                    return;
                }
                
                // Usar IA gratuita (Gemini) para an√°lisis inteligente
                const iaAnalysis = await consultarIA(sintomas, edad, intensidad, duracion, genero);
                
                // Fallback a an√°lisis b√°sico si la IA falla
                const aiAnalysis = analyzeSymptomsAndRecommendSpecialist(sintomas, edad, intensidad, [], genero);
                
                // Usar an√°lisis de IA si est√° disponible, sino usar el b√°sico
                const finalAnalysis = iaAnalysis || {
                    especialidad_codigo: aiAnalysis.recommendedSpeciality,
                    especialidad_nombre: aiAnalysis.specialityName,
                    especialista_recomendado: aiAnalysis.specialityName,
                    urgencia: intensidad >= 8 ? "Alta" : intensidad >= 6 ? "Media" : "Baja",
                    diagnostico_preliminar: ["Requiere evaluaci√≥n m√©dica"],
                    recomendaciones_inmediatas: "Consulta con un m√©dico",
                    posibles_causas: ["Requiere evaluaci√≥n m√©dica"],
                    senales_alerta: ["Si los s√≠ntomas empeoran, acuda a urgencias"]
                };

                const aiRecommendationHTML = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 10px; margin-bottom: 1rem;">
                        <h4 style="color: white; margin-bottom: 1rem;">
                            <i class="fas fa-brain"></i> An√°lisis de IA Avanzada
                        </h4>
                        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <strong>Especialista recomendado:</strong> ${finalAnalysis.especialista_recomendado || aiAnalysis.specialityName}<br>
                            <strong>Urgencia:</strong> 
                            <span style="color: ${finalAnalysis.urgencia === 'Alta' ? '#ff6b6b' : finalAnalysis.urgencia === 'Media' ? '#ffa726' : '#4caf50'};">
                                ${finalAnalysis.urgencia?.toUpperCase() || 'MEDIA'}
                            </span>
                        </div>
                        ${finalAnalysis.diagnostico_preliminar ? `
                            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                <strong>Diagn√≥stico preliminar:</strong><br>
                                ${finalAnalysis.diagnostico_preliminar.map((diag, index) => `${index + 1}. ${diag}`).join('<br>')}
                            </div>
                        ` : ''}
                        ${finalAnalysis.recomendaciones_inmediatas ? `
                            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                <strong>Recomendaciones inmediatas:</strong><br>
                                ${finalAnalysis.recomendaciones_inmediatas}
                            </div>
                        ` : ''}
                        ${finalAnalysis.senales_alerta ? `
                            <div style="background: rgba(255,107,107,0.2); padding: 1rem; border-radius: 8px; border-left: 4px solid #ff6b6b;">
                                <strong>‚ö†Ô∏è Se√±ales de alerta:</strong><br>
                                ${Array.isArray(finalAnalysis.senales_alerta) ? finalAnalysis.senales_alerta.join('<br>') : finalAnalysis.senales_alerta}
                            </div>
                        ` : ''}
                    </div>
                `;

                const summary = `
                    <strong>Resumen de la evaluaci√≥n:</strong><br>
                    ‚Ä¢ Edad: ${edad} a√±os<br>
                    ‚Ä¢ G√©nero: ${genero === 'masculino' ? 'Masculino' : genero === 'femenino' ? 'Femenino' : 'Otro'}<br>
                    ‚Ä¢ Intensidad: ${intensidad}/10<br>
                    ‚Ä¢ Duraci√≥n: ${duracion}<br>
                    ‚Ä¢ S√≠ntomas: ${sintomas}<br>
                    <br>
                    <strong>An√°lisis realizado por:</strong> ${iaAnalysis ? 'IA Avanzada (Gemini)' : 'An√°lisis Inteligente'}
                `;
                
                document.getElementById('ai-recommendation').innerHTML = aiRecommendationHTML;
                document.getElementById('evaluation-summary').innerHTML = summary;
                document.getElementById('evaluation-result').classList.remove('hidden');
                
                const evaluationData = {
                    edad: edad,
                    genero: genero,
                    sintomas: sintomas,
                    duracion: duracion,
                    intensidad: intensidad,
                    iaAnalysis: iaAnalysis
                };
                localStorage.setItem('evaluationData', JSON.stringify(evaluationData));
                
                // Guardar especialidad recomendada (usar c√≥digo de IA si est√° disponible)
                const especialidadCodigo = finalAnalysis.especialidad_codigo || aiAnalysis.recommendedSpeciality;
                const especialidadNombre = finalAnalysis.especialidad_nombre || finalAnalysis.especialista_recomendado || aiAnalysis.specialityName;
                
                localStorage.setItem('recommendedSpeciality', especialidadCodigo);
                localStorage.setItem('specialityName', especialidadNombre);
                
            } catch (error) {
                console.error('Error en la evaluaci√≥n:', error);
                alert('Hubo un error al procesar la evaluaci√≥n. Por favor, int√©ntalo de nuevo.');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Constantes de API
        const AUTH_API_URL = 'api/auth.php';
        const MEDICOS_API_URL = 'api/medicos.php';
        const CITAS_API_URL = 'api/citas.php';

        // Funci√≥n para calcular edad desde fecha de nacimiento
        function calcularEdadDesdeFechaNacimiento(fechaNacimiento) {
            const edadInput = document.getElementById('edad');
            const edadInfo = document.getElementById('edad-info');
            
            if (!fechaNacimiento) {
                if (edadInput) {
                    edadInput.value = '';
                    edadInput.required = true;
                }
                if (edadInfo) {
                    edadInfo.textContent = 'No se encontr√≥ fecha de nacimiento. Por favor, actualiza tu perfil.';
                    edadInfo.style.color = '#f44336';
                    edadInfo.style.display = 'block';
                }
                return null;
            }
            
            try {
                const birthDate = new Date(fechaNacimiento);
                const today = new Date();
                
                if (isNaN(birthDate.getTime()) || birthDate > today) {
                    throw new Error('Fecha de nacimiento inv√°lida');
                }
                
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                
                if (age < 0 || age > 120) {
                    throw new Error('Edad calculada fuera del rango v√°lido');
                }
                
                if (edadInput) {
                    edadInput.value = age;
                    edadInput.required = true;
                }
                
                if (edadInfo) {
                    edadInfo.style.display = 'none';
                }
                
                return age;
            } catch (error) {
                console.error('Error al calcular edad:', error);
                if (edadInput) {
                    edadInput.value = '';
                }
                if (edadInfo) {
                    edadInfo.textContent = `Error al calcular edad: ${error.message}`;
                    edadInfo.style.color = '#f44336';
                    edadInfo.style.display = 'block';
                }
                return null;
            }
        }

        // Cargar informaci√≥n del usuario
        async function loadUserInfo() {
            try {
                const response = await fetch(`${AUTH_API_URL}?action=session`, {
                    credentials: 'include',
                    headers: {'Accept': 'application/json'}
                });
                
                const result = await response.json();
                if (result.authenticated && result.user && result.user.fecha_nacimiento) {
                    calcularEdadDesdeFechaNacimiento(result.user.fecha_nacimiento);
                }
            } catch (error) {
                console.error('Error al cargar informaci√≥n del usuario:', error);
            }
        }

        // Variables globales para la reserva
        let reservaData = {
            especialidad: null,
            medico: null,
            fecha: null,
            hora: null,
            sintomas: null
        };

        // Funci√≥n para mostrar modal de confirmaci√≥n
        async function mostrarConfirmacionReserva() {
            const modal = document.getElementById('confirmacionModal');
            const detalles = document.getElementById('confirmacionDetalles');
            
            // Obtener datos de la evaluaci√≥n
            const evaluationData = JSON.parse(localStorage.getItem('evaluationData') || '{}');
            const recommendedSpeciality = localStorage.getItem('recommendedSpeciality') || 'medicina-general';
            const specialityName = localStorage.getItem('specialityName') || 'M√©dico General';
            
            modal.style.display = 'block';
            detalles.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Buscando m√©dico y horario disponible...</p>';
            
            try {
                // Buscar m√©dicos disponibles para la especialidad
                const medicosResponse = await fetch(`${MEDICOS_API_URL}?action=por_especialidad&especialidad=${encodeURIComponent(recommendedSpeciality)}`, {
                    credentials: 'include',
                    headers: {'Accept': 'application/json'}
                });
                
                const medicos = await medicosResponse.json();
                
                if (!medicos || medicos.length === 0) {
                    detalles.innerHTML = `
                        <div class="error-message">
                            <p><i class="fas fa-exclamation-triangle"></i> No hay m√©dicos disponibles para la especialidad "${specialityName}" en este momento.</p>
                            <p>Por favor, intenta m√°s tarde o selecciona otra especialidad.</p>
                        </div>
                    `;
                    // Ocultar botones de acci√≥n cuando hay error
                    document.getElementById('btn-editar-reserva').style.display = 'none';
                    document.getElementById('btn-guardar-edicion').style.display = 'none';
                    document.getElementById('btn-confirmar-reserva').style.display = 'none';
                    return;
                }
                
                // Seleccionar el primer m√©dico disponible
                const medicoSeleccionado = medicos[0];
                
                // Buscar fecha y hora disponible
                const hoy = new Date();
                let fechaDisponible = null;
                let horaDisponible = null;
                
                // Buscar en los pr√≥ximos 30 d√≠as
                for (let i = 0; i < 30; i++) {
                    const fecha = new Date(hoy);
                    fecha.setDate(hoy.getDate() + i);
                    const fechaStr = fecha.toISOString().split('T')[0];
                    
                    const horasResponse = await fetch(`${MEDICOS_API_URL}?action=horas_disponibles&medico_id=${medicoSeleccionado.id}&fecha=${fechaStr}`, {
                        credentials: 'include',
                        headers: {'Accept': 'application/json'}
                    });
                    
                    const horas = await horasResponse.json();
                    
                    if (horas && horas.length > 0) {
                        fechaDisponible = fechaStr;
                        horaDisponible = horas[0];
                        break;
                    }
                }
                
                if (!fechaDisponible || !horaDisponible) {
                    detalles.innerHTML = `
                        <div class="error-message">
                            <p><i class="fas fa-exclamation-triangle"></i> No hay horarios disponibles para "${specialityName}" en los pr√≥ximos 30 d√≠as.</p>
                            <p>Por favor, intenta m√°s tarde o contacta directamente con el consultorio.</p>
                        </div>
                    `;
                    // Ocultar botones de acci√≥n cuando hay error
                    document.getElementById('btn-editar-reserva').style.display = 'none';
                    document.getElementById('btn-guardar-edicion').style.display = 'none';
                    document.getElementById('btn-confirmar-reserva').style.display = 'none';
                    return;
                }
                
                // Guardar datos de reserva
                reservaData = {
                    especialidad: recommendedSpeciality,
                    medico: medicoSeleccionado,
                    fecha: fechaDisponible,
                    hora: horaDisponible,
                    sintomas: evaluationData.sintomas || ''
                };
                
                // Mostrar detalles de confirmaci√≥n
                mostrarDetallesReserva(specialityName, medicos, medicoSeleccionado, fechaDisponible, horaDisponible, evaluationData.sintomas);
                
            } catch (error) {
                console.error('Error al buscar disponibilidad:', error);
                detalles.innerHTML = `
                    <div class="error-message">
                        <p><i class="fas fa-exclamation-triangle"></i> Error al buscar disponibilidad. Por favor, intenta nuevamente.</p>
                    </div>
                `;
                // Ocultar botones de acci√≥n cuando hay error
                document.getElementById('btn-editar-reserva').style.display = 'none';
                document.getElementById('btn-guardar-edicion').style.display = 'none';
                document.getElementById('btn-confirmar-reserva').style.display = 'none';
            }
        }

        // Funci√≥n para mostrar detalles de reserva (modo visualizaci√≥n)
        function mostrarDetallesReserva(specialityName, medicos, medicoSeleccionado, fechaDisponible, horaDisponible, sintomas) {
            const detalles = document.getElementById('confirmacionDetalles');
            const fechaFormateada = new Date(fechaDisponible).toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            detalles.innerHTML = `
                <div class="detalle-reserva" id="detalle-reserva-view">
                    <p><strong><i class="fas fa-user-md"></i> Especialidad:</strong> ${specialityName}</p>
                    <p><strong><i class="fas fa-stethoscope"></i> M√©dico:</strong> <span id="medico-nombre-view">${medicoSeleccionado.nombre}</span></p>
                    <p><strong><i class="fas fa-calendar"></i> Fecha:</strong> <span id="fecha-view">${fechaFormateada}</span></p>
                    <p><strong><i class="fas fa-clock"></i> Hora:</strong> <span id="hora-view">${horaDisponible}</span></p>
                    <p><strong><i class="fas fa-notes-medical"></i> Motivo:</strong> ${sintomas || 'Consulta m√©dica'}</p>
                </div>
                <p style="color: #666; font-size: 0.9rem;">
                    <i class="fas fa-info-circle"></i> Por favor, confirma si est√°s de acuerdo con estos detalles antes de reservar la cita.
                </p>
            `;
            
            // Guardar datos para edici√≥n
            window.modalEditData = {
                specialityName: specialityName,
                medicos: medicos,
                medicoSeleccionado: medicoSeleccionado,
                fechaDisponible: fechaDisponible,
                horaDisponible: horaDisponible,
                sintomas: sintomas
            };
            
            // Mostrar bot√≥n editar y "Confirmar y Reservar", ocultar guardar
            document.getElementById('btn-editar-reserva').style.display = 'inline-block';
            document.getElementById('btn-guardar-edicion').style.display = 'none';
            document.getElementById('btn-confirmar-reserva').style.display = 'inline-block';
        }

        // Funci√≥n para editar reserva
        async function editarReserva() {
            const detalles = document.getElementById('confirmacionDetalles');
            const editData = window.modalEditData;
            
            if (!editData) {
                alert('Error: No se encontraron datos para editar');
                return;
            }
            
            // Obtener todas las fechas disponibles (pr√≥ximos 30 d√≠as)
            const hoy = new Date();
            const fechasDisponibles = [];
            for (let i = 0; i < 30; i++) {
                const fecha = new Date(hoy);
                fecha.setDate(hoy.getDate() + i);
                fechasDisponibles.push({
                    fecha: fecha.toISOString().split('T')[0],
                    fechaFormateada: fecha.toLocaleDateString('es-ES', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    })
                });
            }
            
            // Crear opciones de m√©dicos
            const medicosOptions = editData.medicos.map(m => 
                `<option value="${m.id}" ${m.id === editData.medicoSeleccionado.id ? 'selected' : ''}>${m.nombre}</option>`
            ).join('');
            
            // Crear opciones de fechas
            const fechasOptions = fechasDisponibles.map(f => 
                `<option value="${f.fecha}" ${f.fecha === editData.fechaDisponible ? 'selected' : ''}>${f.fechaFormateada}</option>`
            ).join('');
            
            detalles.innerHTML = `
                <div class="detalle-reserva" id="detalle-reserva-edit">
                    <p><strong><i class="fas fa-user-md"></i> Especialidad:</strong> ${editData.specialityName}</p>
                    
                    <div class="form-group" style="margin-top: 1rem;">
                        <label><strong><i class="fas fa-stethoscope"></i> M√©dico:</strong></label>
                        <select id="edit-medico" class="form-control" style="width: 100%; padding: 0.5rem; margin-top: 0.5rem;">
                            ${medicosOptions}
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-top: 1rem;">
                        <label><strong><i class="fas fa-calendar"></i> Fecha:</strong></label>
                        <select id="edit-fecha" class="form-control" style="width: 100%; padding: 0.5rem; margin-top: 0.5rem;">
                            ${fechasOptions}
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-top: 1rem;">
                        <label><strong><i class="fas fa-clock"></i> Hora:</strong></label>
                        <select id="edit-hora" class="form-control" style="width: 100%; padding: 0.5rem; margin-top: 0.5rem;">
                            <option value="">Cargando horarios...</option>
                        </select>
                        <small id="hora-loading-edit" style="display: none; color: #667eea;">Cargando horarios...</small>
                    </div>
                    
                    <p style="margin-top: 1rem;"><strong><i class="fas fa-notes-medical"></i> Motivo:</strong> ${editData.sintomas || 'Consulta m√©dica'}</p>
                </div>
                <p style="color: #666; font-size: 0.9rem;">
                    <i class="fas fa-info-circle"></i> Selecciona el m√©dico, fecha y hora que prefieras.
                </p>
            `;
            
            // Cargar horas disponibles para la fecha seleccionada
            await cargarHorasDisponiblesEdit(editData.medicoSeleccionado.id, editData.fechaDisponible, editData.horaDisponible);
            
            // Agregar event listeners
            document.getElementById('edit-medico').addEventListener('change', async function() {
                const medicoId = this.value;
                const fecha = document.getElementById('edit-fecha').value;
                if (fecha) {
                    await cargarHorasDisponiblesEdit(medicoId, fecha, null);
                }
            });
            
            document.getElementById('edit-fecha').addEventListener('change', async function() {
                const fecha = this.value;
                const medicoId = document.getElementById('edit-medico').value;
                if (medicoId) {
                    await cargarHorasDisponiblesEdit(medicoId, fecha, null);
                }
            });
            
            // Ocultar bot√≥n editar y "Confirmar y Reservar", mostrar guardar
            document.getElementById('btn-editar-reserva').style.display = 'none';
            document.getElementById('btn-guardar-edicion').style.display = 'inline-block';
            document.getElementById('btn-confirmar-reserva').style.display = 'none';
        }

        // Funci√≥n para cargar horas disponibles en modo edici√≥n
        async function cargarHorasDisponiblesEdit(medicoId, fecha, horaSeleccionada) {
            const horaSelect = document.getElementById('edit-hora');
            const horaLoading = document.getElementById('hora-loading-edit');
            
            horaSelect.disabled = true;
            horaSelect.innerHTML = '<option value="">Cargando...</option>';
            horaLoading.style.display = 'block';
            
            try {
                const response = await fetch(`${MEDICOS_API_URL}?action=horas_disponibles&medico_id=${medicoId}&fecha=${fecha}`, {
                    credentials: 'include',
                    headers: {'Accept': 'application/json'}
                });
                
                const horas = await response.json();
                
                horaLoading.style.display = 'none';
                
                if (!horas || horas.length === 0) {
                    horaSelect.innerHTML = '<option value="">No hay horarios disponibles</option>';
                    return;
                }
                
                horaSelect.innerHTML = horas.map(h => 
                    `<option value="${h}" ${h === horaSeleccionada ? 'selected' : ''}>${h}</option>`
                ).join('');
                
                horaSelect.disabled = false;
            } catch (error) {
                console.error('Error al cargar horarios:', error);
                horaSelect.innerHTML = '<option value="">Error al cargar horarios</option>';
                horaLoading.style.display = 'none';
            }
        }

        // Funci√≥n para guardar edici√≥n
        async function guardarEdicionReserva() {
            const medicoId = document.getElementById('edit-medico').value;
            const fecha = document.getElementById('edit-fecha').value;
            const hora = document.getElementById('edit-hora').value;
            
            if (!medicoId || !fecha || !hora) {
                alert('Por favor, completa todos los campos');
                return;
            }
            
            // Buscar el m√©dico seleccionado
            const editData = window.modalEditData;
            const medicoSeleccionado = editData.medicos.find(m => m.id == medicoId);
            
            if (!medicoSeleccionado) {
                alert('Error: M√©dico no encontrado');
                return;
            }
            
            // Actualizar datos de reserva
            reservaData = {
                especialidad: reservaData.especialidad,
                medico: medicoSeleccionado,
                fecha: fecha,
                hora: hora,
                sintomas: editData.sintomas
            };
            
            // Actualizar datos de edici√≥n
            editData.medicoSeleccionado = medicoSeleccionado;
            editData.fechaDisponible = fecha;
            editData.horaDisponible = hora;
            
            // Volver a modo visualizaci√≥n
            mostrarDetallesReserva(
                editData.specialityName,
                editData.medicos,
                medicoSeleccionado,
                fecha,
                hora,
                editData.sintomas
            );
        }

        // Funci√≥n para cerrar modal
        function cerrarModalConfirmacion() {
            document.getElementById('confirmacionModal').style.display = 'none';
            // Restablecer estado de botones
            document.getElementById('btn-editar-reserva').style.display = 'none';
            document.getElementById('btn-guardar-edicion').style.display = 'none';
            document.getElementById('btn-confirmar-reserva').style.display = 'inline-block';
        }

        // Funci√≥n para confirmar y reservar
        async function confirmarReserva() {
            const btn = document.getElementById('btn-confirmar-reserva');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Reservando...';
            
            try {
                // Obtener informaci√≥n del usuario
                const sessionResponse = await fetch(`${AUTH_API_URL}?action=session`, {
                    credentials: 'include',
                    headers: {'Accept': 'application/json'}
                });
                
                const sessionResult = await sessionResponse.json();
                
                if (!sessionResult.authenticated || !sessionResult.user) {
                    throw new Error('Debes iniciar sesi√≥n para reservar una cita');
                }
                
                const user = sessionResult.user;
                const evaluationData = JSON.parse(localStorage.getItem('evaluationData') || '{}');
                
                // Crear datos de la cita
                const citaData = {
                    nombre: user.nombre || '',
                    telefono: user.telefono || '',
                    email: user.email || '',
                    edadPaciente: evaluationData.edad || parseInt(document.getElementById('edad').value),
                    especialidad: reservaData.especialidad,
                    medico_id: reservaData.medico.id,
                    fecha: reservaData.fecha,
                    hora: reservaData.hora,
                    tipoConsulta: 'presencial',
                    motivo: reservaData.sintomas || 'Consulta m√©dica recomendada por evaluaci√≥n de s√≠ntomas',
                    confirmacion: 'MED' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                    ownerKey: user.email || user.telefono
                };
                
                // Reservar cita
                const response = await fetch(CITAS_API_URL, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(citaData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    cerrarModalConfirmacion();
                    alert('¬°Cita reservada exitosamente!\n\n' +
                          `Especialidad: ${localStorage.getItem('specialityName')}\n` +
                          `M√©dico: ${reservaData.medico.nombre}\n` +
                          `Fecha: ${new Date(reservaData.fecha).toLocaleDateString('es-ES')}\n` +
                          `Hora: ${reservaData.hora}\n` +
                          `C√≥digo de confirmaci√≥n: ${citaData.confirmacion}`);
                    
                    // Redirigir a citas
                    window.location.href = 'citas.html';
                } else {
                    throw new Error(result.message || 'Error al reservar la cita');
                }
                
            } catch (error) {
                console.error('Error al reservar cita:', error);
                alert('Error al reservar la cita: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check"></i> Confirmar y Reservar';
            }
        }

        function resetForm() {
            document.getElementById('evaluationForm').reset();
            document.getElementById('intensidad-value').textContent = '5';
            document.getElementById('evaluation-result').classList.add('hidden');
        }

        // Proteger p√°gina - requiere autenticaci√≥n
        window.addEventListener('DOMContentLoaded', async function() {
            const session = await checkSession();
            if (!session.authenticated) {
                window.location.replace('login.html');
                return;
            }
            
            // Si est√° autenticado, mostrar contenido y habilitar formulario
            document.body.classList.add('authenticated');
            const form = document.getElementById('evaluationForm');
            if (form) {
                form.style.pointerEvents = 'auto';
                form.style.opacity = '1';
            }
            
            // Cargar informaci√≥n del usuario (edad)
            await loadUserInfo();
            
            // Inicializar slider de intensidad
            initIntensidadSlider();
            
            // Inicializar reconocimiento de voz
            initSpeechRecognition();
        });
        
        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('confirmacionModal');
            if (event.target === modal) {
                cerrarModalConfirmacion();
            }
        }
        
        // Tambi√©n verificar antes de que se cargue el DOM (protecci√≥n adicional)
        (async function() {
            const session = await checkSession();
            if (!session.authenticated) {
                window.location.replace('login.html');
            }
        })();
    </script>
    
    <!-- Modal para editar perfil -->
    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Editar Informaci√≥n</h3>
                <span class="close" onclick="document.getElementById('editProfileModal').classList.remove('active')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editProfileForm" onsubmit="event.preventDefault(); saveProfileChanges();">
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Nombre completo *</label>
                        <input type="text" id="edit-nombre" required placeholder="Ingresa tu nombre completo">
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-envelope"></i> Email *</label>
                        <input type="email" id="edit-email" required placeholder="correo@ejemplo.com">
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-phone"></i> Tel√©fono</label>
                        <input type="tel" id="edit-telefono" placeholder="+56 9 1234 5678">
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-id-card"></i> RUT</label>
                        <input type="text" id="edit-rut" placeholder="12.345.678-9">
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-calendar"></i> Fecha de Nacimiento</label>
                        <input type="date" id="edit-fecha-nacimiento">
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-map-marker-alt"></i> Direcci√≥n</label>
                        <input type="text" id="edit-direccion" placeholder="Calle, n√∫mero, departamento">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-map-marker-alt"></i> Regi√≥n</label>
                            <select id="edit-region">
                                <option value="">Seleccionar regi√≥n</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-map-pin"></i> Comuna</label>
                            <select id="edit-comuna" disabled>
                                <option value="">Primero selecciona una regi√≥n</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="edit-profile-result" class="hidden"></div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="document.getElementById('editProfileModal').classList.remove('active')">
                            Cancelar
                        </button>
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-save"></i> Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script src="js/chile-regiones-comunas.js"></script>
    <script src="js/edit-profile.js"></script>
</body>
</html>